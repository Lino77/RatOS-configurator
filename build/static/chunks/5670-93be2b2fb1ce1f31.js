(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5670],{65660:function(){},26989:function(e,t,r){"use strict";r.d(t,{X:function(){return getHost}});let getHost=()=>{var e;return""!="".trim()?"":(null===(e=window.location)||void 0===e?void 0:e.hostname)!=null?window.location.hostname:null}},61352:function(e,t,r){"use strict";r.d(t,{oK:function(){return useMoonraker},xH:function(){return useMoonrakerMutation},DS:function(){return useMoonrakerQuery},Fu:function(){return useMoonrakerState},A4:function(){return useNamespacedItemQuery},hS:function(){return usePrinterObjectQuery},Q:function(){return usePrinterObjectSubscription}});var n=r(49738),a=r(2973),o=r(45277),s=r(43790),u=r(26989);let l=[{version:1,description:"Undo double JSON encoding of RatOS's data",up:async()=>{let e=await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS"));if(!e.ok)return{result:"Nothing to migrate"};{let t=await e.json();if("error"in t)throw Error(t.error.message);let r=[];if(null==t.result.value)return{result:"Nothing to migrate"};for await(let[e,r]of Object.entries(t.result.value))try{let t=JSON.parse(r);console.log("Migrating",e,"from",r,"to",t),await window.fetch("http://".concat((0,u.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})})}catch(t){console.error("Error migrating",e,r,"clearing key"),await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS&key=").concat(encodeURIComponent(e)),{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e})});continue}return{result:"Succesfully decoded ".concat(r.length," keys.\n").concat(r.join("\n"))}}},down:async()=>{let e=await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS"));if(e.ok){let t=await e.json();if("error"in t)throw Error(t.error.message);if(null==t.result.value)return{result:"Nothing to migrate"};let r=[];for await(let[e,n]of Object.entries(t.result.value)){let t=JSON.stringify(n);await window.fetch("http://".concat((0,u.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})}),r.push("Re-encoded ".concat(e))}return{result:"Succesfully re-encoded ".concat(r.length," keys.\n").concat(r.join("\n"))}}return{result:"Nothing to migrate"}}}],getCurrentVersion=async()=>{let e=await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS&key=__db_version"));if(e.ok){let t=await e.json();return"error"in t?0:t.result.value}return 0},setCurrentVersion=async e=>{await window.fetch("http://".concat((0,u.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:"__db_version",value:e})})},i=!1,migrate=async(e,t)=>{if(i)return console.log("Already migrating, ignoring..");if(e===t)return console.log("Already at target version");i=!0;try{let r=l.filter(r=>r.version>=e&&r.version<=t).sort((r,n)=>e<=t?r.version-n.version:n.version-r.version);for await(let n of r){let r=await (e<t?n.up():n.down());console.log("Migrated to version ".concat(n.version,": ").concat(r.result))}await setCurrentVersion(t)}finally{i=!1}},c=!1,migrateToLatest=async()=>{if(c)return console.log("Already migrated, ignoring..");let e=await getCurrentVersion(),t=Math.max(...l.map(e=>e.version));if(e===t){console.log("Already at latest version");return}if(i){console.log("Already migrating, ignoring..");return}console.log("Migrating to latest version...",e,t),await migrate(e,t),c=!0,console.log("Migration complete.")};var d=r(52540),f=r(86736),g=r.n(f);let m=0,getWsURL=()=>{let e=(0,u.X)();return null==e||""==e.trim()?null:"ws://".concat(e,"/websocket")},y={},useMoonraker=e=>{let t=(0,n.useRef)({}),r=(0,n.useRef)({}),a=(0,n.useRef)([]),o=(0,n.useRef)([]),[u,l]=(0,n.useState)(getWsURL());(0,n.useEffect)(()=>{l(getWsURL())},[]);let i=(0,n.useCallback)(e=>{if("error"in e)return!1;if("notify_status_update"===e.method&&null!=e.params){let t=e.params[0];if(null!=t)for(let e of a.current){let r=y[e];if(null!=r){for(let e in r)if(null!=t[e])return!0}}}return!1},[]),{lastJsonMessage:c,sendJsonMessage:d,readyState:f}=(0,s.ZP)(u,{filter:r=>{if("connected"!==p)return!0;try{var n;let a=JSON.parse(r.data);if(null!=t.current[a.id]||(null==e?void 0:null===(n=e.passThroughUpdateMethods)||void 0===n?void 0:n.length)&&"method"in a&&e.passThroughUpdateMethods.includes(a.method))return!0}catch(e){console.warn("Filter: Failed to parse message",e,r.data)}return!1},onMessage:t=>{if(null==e?void 0:e.onStatusUpdate)try{let n=JSON.parse(t.data);if(i(n)){var r;let t=n.params[0];null===(r=e.onStatusUpdate)||void 0===r||r.call(e,t)}}catch(e){console.warn("OnMessage: Failed to parse message",e,t.data)}},shouldReconnect:e=>!0,reconnectAttempts:1/0,reconnectInterval:3e3,share:!0}),g=(0,n.useRef)(f);g.current=f;let[p,h]=(0,n.useState)(1===f?"connected":"connecting"),v=(0,n.useCallback)((e,t)=>{1===g.current?e():o.current.push({resolve:e,reject:t})},[]),b=(0,n.useCallback)(()=>new Promise((e,t)=>{v(e,t)}),[v]),w=(0,n.useCallback)(async function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=++m;return await b(),new Promise((o,s)=>{t.current[a]=(e,t)=>e?s(e):t&&"object"==typeof t&&"error"in t&&t.error?s(t.error):null==t?s(Error("No result. Unknown response format.")):void o(t);let u=1e4;"printer.gcode.script"===e&&(u=6e5),r.current[a]=window.setTimeout(()=>{var e,n;null===(e=(n=t.current)[a])||void 0===e||e.call(n,Error("Request timed out"),null),delete t.current[a],delete r.current[a]},u),d({jsonrpc:"2.0",method:e,params:n,id:a})})},[b,d]),k=(0,n.useCallback)(async function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let n=Object.fromEntries(t.map(e=>[e,null])),o=Object.assign({},n,...Object.values(y).filter(e=>null!=e)),s=w("printer.objects.subscribe",{objects:o}),u=m;y[u]=n,a.current.push(u);let l=(await s).status;return{res:l,unsuscribe:async()=>{if(a.current=a.current.filter(e=>e!==u),null==y[u]){delete y[u];let e=Object.assign({},...Object.values(y).filter(e=>null!=e));await w("printer.objects.subscribe",{objects:e})}}}},[w]),O=(0,n.useCallback)(async(e,t,r)=>(await b(),await w("server.database.post_item",{namespace:e,key:t,value:r})),[w,b]),j=(0,n.useCallback)(async(e,t)=>{await b();try{var r;let n=await w("server.database.get_item",{namespace:e,key:t});return null!==(r=null==n?void 0:n.value)&&void 0!==r?r:null}catch(e){return console.log(e),null}},[w,b]);return(0,n.useEffect)(()=>{1===f?(async()=>{await migrateToLatest(),o.current.forEach(e=>e.resolve()),o.current=[],h("connected")})():h("connecting")},[f]),(0,n.useEffect)(()=>{(null==c?void 0:c.id)&&t.current[c.id]&&(window.clearTimeout(r.current[c.id]),"error"in c?t.current[c.id](Error(c.error.message),null):t.current[c.id](null,c.result),delete r.current[c.id],delete t.current[c.id])},[c]),(0,n.useEffect)(()=>()=>{for(let e in r.current)delete r.current[e],delete t.current[e];if(a.current.length>0){a.current.forEach(e=>{delete y[e]}),a.current=[];let e=Object.assign({},...Object.values(y).filter(e=>null!=e));w("printer.objects.subscribe",{objects:Object.keys(e).length>0?e:null}).catch(e=>{})}o.current.forEach(e=>e.reject()),o.current=[]},[]),{query:w,saveItem:O,getItem:j,subscribeToObject:k,status:p,lastMessage:c,isReady:1===f}},useNamespacedItemQuery=(e,t,r)=>{let{getItem:n}=useMoonraker();return(0,a.a)({...r,queryKey:[e,t],queryFn:async()=>n(e,t)})},useMoonrakerQuery=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker(),o=3===t.length?t[2]:t[1],s=3===t.length?t[1]:void 0,u=t[0],l=3===t.length?[u,s]:[u];return(0,a.a)({...null!=o?o:{},queryKey:[t[0]],queryFn:async()=>n(...l)})},useMoonrakerMutation=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker(),a=t[1],s=t[0];return(0,o.D)({...a,mutationKey:[t[0]],mutationFn:async e=>{let t=e?[s,e]:[s];return n(...t)}})},usePrinterObjectQuery=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker();return(0,a.a)({queryKey:t,queryFn:async()=>{let e=Object.fromEntries(t.map(e=>[e,null]));return(await n("printer.objects.query",{objects:e})).status}})},usePrinterObjectSubscription=function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];let[o,s]=(0,n.useState)(null),u=(0,n.useRef)(o);u.current=o;let l=(0,n.useRef)(e);l.current=e;let i=(0,n.useCallback)(e=>{var t;return null==l.current?e:null===(t=l.current)||void 0===t?void 0:t.call(l,e)},[]),c=(0,n.useMemo)(()=>Object.fromEntries(r.map(e=>[e,null])),[JSON.stringify(r.sort())]),{subscribeToObject:f}=useMoonraker({onStatusUpdate:(0,n.useCallback)(e=>{let t={};for(let r in c)null!=e[r]&&(t[r]=e[r]);let r=i(t);if(null==r||"object"!=typeof r)throw Error("Invalid selection function, must return object, got "+typeof r);Object.keys(t).length>0&&!1===g()(r,u.current)&&s(e=>(0,d.T)(null!=e?e:{},r))},[i,c])});return(0,n.useEffect)(()=>{let e=f(...Object.keys(c));return e.then(e=>{s(i(e.res))}).catch(e=>{e instanceof Error&&console.error(e)}),()=>{e.then(e=>e.unsuscribe()).catch(e=>{e instanceof Error&&console.error(e)})}},[i,c,f]),o},useNamespacedItemMutation=(e,t,r)=>{let{saveItem:n}=useMoonraker();return(0,o.D)({...r,mutationKey:[e,t],mutationFn:r=>n(e,t,r)})},useMoonrakerState=function(e,t){var r;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=useNamespacedItemQuery(e,t,{initialData:a}),s=useNamespacedItemMutation(e,t),u=(0,n.useCallback)(async e=>{var t;let r="function"==typeof e?e(null!==(t=o.data)&&void 0!==t?t:a):e;await s.mutateAsync(r,{onSuccess:()=>{o.refetch()}})},[a,s,o]);return[null!==(r=o.data)&&void 0!==r?r:a,u,o,s]}},64918:function(e,t,r){"use strict";r.d(t,{SX:function(){return o},uF:function(){return s}});var n=r(67763),a=r(21067);function getBaseUrl(){return"/configure"}r(28070);let o=(0,a.t)({config:()=>({links:[(0,n.N8)({url:"".concat(getBaseUrl(),"/api/trpc"),maxURLLength:2083})]}),overrides:{useMutation:{async onSuccess(e){await e.originalFn(),await e.queryClient.invalidateQueries()}}},ssr:!1}),s=(0,n.K5)({links:[(0,n.N8)({url:"".concat(getBaseUrl(),"/api/trpc"),maxURLLength:2083})]})}}]);
//# sourceMappingURL=5670-93be2b2fb1ce1f31.js.map