(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2745],{65660:function(){},98948:function(e,t,r){"use strict";r.d(t,{j:function(){return getLogger}});var n=r(74958),a=r.n(n),o=r(75061),s=r(10187),i=r(31354);let send=async function(e,t){s.u.clientLog.mutate({level:e,logEvent:i.s.parse(t)})},u=null,getLogger=()=>null!=u?u:u=a()({...o.N,browser:{transmit:{send}}})},75061:function(e,t,r){"use strict";r.d(t,{N:function(){return n}});let n={timestamp:!0,level:"info"}},10187:function(e,t,r){"use strict";r.d(t,{S:function(){return n.SX},u:function(){return n.uF}});var n=r(79293)},81446:function(e,t,r){"use strict";r.d(t,{X:function(){return getHost}});let getHost=()=>{var e;return""!="".trim()?"":(null===(e=window.location)||void 0===e?void 0:e.hostname)!=null?window.location.hostname:null}},96886:function(e,t,r){"use strict";r.d(t,{oK:function(){return useMoonraker},xH:function(){return useMoonrakerMutation},DS:function(){return useMoonrakerQuery},Fu:function(){return useMoonrakerState},A4:function(){return useNamespacedItemQuery},hS:function(){return usePrinterObjectQuery},Q:function(){return usePrinterObjectSubscription}});var n=r(39164),a=r(9948),o=r(65339),s=r(84634),i=r(81446);let u=[{version:1,description:"Undo double JSON encoding of RatOS's data",up:async()=>{let e=await window.fetch("http://".concat((0,i.X)(),"/server/database/item?namespace=RatOS"));if(!e.ok)return{result:"Nothing to migrate"};{let t=await e.json();if("error"in t)throw Error(t.error.message);let r=[];if(null==t.result.value)return{result:"Nothing to migrate"};for await(let[e,r]of Object.entries(t.result.value))try{let t=JSON.parse(r);console.log("Migrating",e,"from",r,"to",t),await window.fetch("http://".concat((0,i.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})})}catch(t){console.error("Error migrating",e,r,"clearing key"),await window.fetch("http://".concat((0,i.X)(),"/server/database/item?namespace=RatOS&key=").concat(encodeURIComponent(e)),{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e})});continue}return{result:"Succesfully decoded ".concat(r.length," keys.\n").concat(r.join("\n"))}}},down:async()=>{let e=await window.fetch("http://".concat((0,i.X)(),"/server/database/item?namespace=RatOS"));if(e.ok){let t=await e.json();if("error"in t)throw Error(t.error.message);if(null==t.result.value)return{result:"Nothing to migrate"};let r=[];for await(let[e,n]of Object.entries(t.result.value)){let t=JSON.stringify(n);await window.fetch("http://".concat((0,i.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})}),r.push("Re-encoded ".concat(e))}return{result:"Succesfully re-encoded ".concat(r.length," keys.\n").concat(r.join("\n"))}}return{result:"Nothing to migrate"}}},{version:2,description:"Change caramba printers to v-core-4 / v-chonk",up:async()=>{let e=await window.fetch("http://".concat((0,i.X)(),"/server/database/item?namespace=RatOS"));if(!e.ok)return{result:"Nothing to migrate"};{let t=await e.json();if("error"in t)throw Error(t.error.message);let r=[];if(null==t.result.value)return{result:"Nothing to migrate"};for await(let[e,n]of Object.entries(t.result.value))if("Printer"===e&&"string"==typeof n){let e=n.replace(/caramba-chonk/g,"v-chonk").replace(/caramba/g,"v-core-4");if(e===n)continue;await window.fetch("http://".concat((0,i.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:"Printer",value:e})}),r.push("Migrated ".concat(n," to ").concat(e))}return{result:"Succesfully migrated ".concat(r.length," keys.\n").concat(r.join("\n"))}}},down:async()=>{let e=await window.fetch("http://".concat((0,i.X)(),"/server/database/item?namespace=RatOS"));if(!e.ok)return{result:"Nothing to migrate"};{let t=await e.json();if("error"in t)throw Error(t.error.message);let r=[];if(null==t.result.value)return{result:"Nothing to migrate"};for await(let[e,n]of Object.entries(t.result.value))if("Printer"===e&&"string"==typeof n){let e=n.replace(/v-chonk/g,"caramba-chonk").replace(/v-core-4/g,"caramba");if(e===n)continue;await window.fetch("http://".concat((0,i.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:"Printer",value:e})}),r.push("Migrated ".concat(n," to ").concat(e))}return{result:"Succesfully migrated ".concat(r.length," keys.\n").concat(r.join("\n"))}}}}],getCurrentVersion=async()=>{let e=await window.fetch("http://".concat((0,i.X)(),"/server/database/item?namespace=RatOS&key=__db_version"));if(e.ok){let t=await e.json();return"error"in t?0:t.result.value}return 0},setCurrentVersion=async e=>{await window.fetch("http://".concat((0,i.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:"__db_version",value:e})})},c=!1,migrate=async(e,t)=>{if(c)return console.log("Already migrating, ignoring..");if(e===t)return console.log("Already at target version");c=!0;try{let r=u.filter(r=>r.version>e&&r.version<=t).sort((r,n)=>e<=t?r.version-n.version:n.version-r.version);for await(let n of r){let r=await (e<t?n.up():n.down());console.log("Migrated to version ".concat(n.version,": ").concat(r.result))}await setCurrentVersion(t)}finally{c=!1}},l=!1,migrateToLatest=async()=>{if(l)return console.log("Already migrated, ignoring..");let e=await getCurrentVersion(),t=Math.max(...u.map(e=>e.version));if(e===t){console.log("Already at latest version");return}if(c){console.log("Already migrating, ignoring..");return}console.log("Migrating to latest version...",e,t),await migrate(e,t),l=!0,console.log("Migration complete.")};var f=r(52540),d=r(86736),g=r.n(d),m=r(98948);let p=0,getWsURL=()=>{let e=(0,i.X)();return null==e||""==e.trim()?null:"ws://".concat(e,"/websocket")},h={},useMoonraker=e=>{let t=(0,n.useRef)({}),r=(0,n.useRef)({}),a=(0,n.useRef)([]),o=(0,n.useRef)([]),[i,u]=(0,n.useState)(getWsURL());(0,n.useEffect)(()=>{u(getWsURL())},[]);let c=(0,n.useCallback)(e=>{if("error"in e)return!1;if("notify_status_update"===e.method&&null!=e.params){let t=e.params[0];if(null!=t)for(let e of a.current){let r=h[e];if(null!=r){for(let e in r)if(null!=t[e])return!0}}}return!1},[]),{lastJsonMessage:l,sendJsonMessage:f,readyState:d}=(0,s.ZP)(i,{filter:r=>{if("connected"!==y)return!0;try{var n;let a=JSON.parse(r.data);if(null!=t.current[a.id]||(null==e?void 0:null===(n=e.passThroughUpdateMethods)||void 0===n?void 0:n.length)&&"method"in a&&e.passThroughUpdateMethods.includes(a.method))return!0}catch(e){(0,m.j)().warn({e,messageData:r.data},"Filter: Failed to parse message")}return!1},onMessage:t=>{if(null==e?void 0:e.onStatusUpdate)try{let n=JSON.parse(t.data);if(c(n)){var r;let t=n.params[0];null===(r=e.onStatusUpdate)||void 0===r||r.call(e,t)}}catch(e){(0,m.j)().warn({e,messageData:t.data},"OnMessage: Failed to parse message")}},shouldReconnect:e=>!0,reconnectAttempts:1/0,reconnectInterval:3e3,share:!0}),g=(0,n.useRef)(d);g.current=d;let[y,v]=(0,n.useState)(1===d?"connected":"connecting"),b=(0,n.useCallback)((e,t)=>{1===g.current?e():o.current.push({resolve:e,reject:t})},[]),w=(0,n.useCallback)(()=>new Promise((e,t)=>{b(e,t)}),[b]),j=(0,n.useCallback)(async function(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=++p;return await w(),new Promise((o,s)=>{t.current[a]=(e,t)=>e?s(e):t&&"object"==typeof t&&"error"in t&&t.error?s(t.error):null==t?s(Error("No result. Unknown response format.")):void o(t);let i=1e4;"printer.gcode.script"===e&&(i=6e5),r.current[a]=window.setTimeout(()=>{var e,n;null===(e=(n=t.current)[a])||void 0===e||e.call(n,Error("Request timed out"),null),delete t.current[a],delete r.current[a]},i),f({jsonrpc:"2.0",method:e,params:n,id:a})})},[w,f]),k=(0,n.useCallback)(async function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let n=Object.fromEntries(t.map(e=>[e,null])),o=Object.assign({},n,...Object.values(h).filter(e=>null!=e)),s=j("printer.objects.subscribe",{objects:o}),i=p;h[i]=n,a.current.push(i);let u=(await s).status;return{res:u,unsuscribe:async()=>{if(a.current=a.current.filter(e=>e!==i),null==h[i]){delete h[i];let e=Object.assign({},...Object.values(h).filter(e=>null!=e));await j("printer.objects.subscribe",{objects:e})}}}},[j]),O=(0,n.useCallback)(async(e,t,r)=>(await w(),await j("server.database.post_item",{namespace:e,key:t,value:r})),[j,w]),S=(0,n.useCallback)(async(e,t)=>{await w();try{var r;let n=await j("server.database.get_item",{namespace:e,key:t});return null!==(r=null==n?void 0:n.value)&&void 0!==r?r:null}catch(e){return(0,m.j)().warn(e),null}},[j,w]);return(0,n.useEffect)(()=>{1===d?(async()=>{await migrateToLatest(),o.current.forEach(e=>e.resolve()),o.current=[],v("connected")})():v("connecting")},[d]),(0,n.useEffect)(()=>{(null==l?void 0:l.id)&&t.current[l.id]&&(window.clearTimeout(r.current[l.id]),"error"in l?t.current[l.id](Error(l.error.message),null):t.current[l.id](null,l.result),delete r.current[l.id],delete t.current[l.id])},[l]),(0,n.useEffect)(()=>()=>{for(let e in r.current)delete r.current[e],delete t.current[e];if(a.current.length>0){a.current.forEach(e=>{delete h[e]}),a.current=[];let e=Object.assign({},...Object.values(h).filter(e=>null!=e));j("printer.objects.subscribe",{objects:Object.keys(e).length>0?e:null}).catch(e=>{})}o.current.forEach(e=>e.reject()),o.current=[]},[]),{query:j,saveItem:O,getItem:S,subscribeToObject:k,status:y,lastMessage:l,isReady:1===d}},useNamespacedItemQuery=(e,t,r)=>{let{getItem:n}=useMoonraker();return(0,a.a)({...r,queryKey:[e,t],queryFn:async()=>n(e,t)})},useMoonrakerQuery=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker(),o=3===t.length?t[2]:t[1],s=3===t.length?t[1]:void 0,i=t[0],u=3===t.length?[i,s]:[i];return(0,a.a)({...null!=o?o:{},queryKey:[t[0]],queryFn:async()=>n(...u)})},useMoonrakerMutation=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker(),a=t[1],s=t[0];return(0,o.D)({...a,mutationKey:[t[0]],mutationFn:async e=>{let t=e?[s,e]:[s];return n(...t)}})},usePrinterObjectQuery=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker();return(0,a.a)({queryKey:t,queryFn:async()=>{let e=Object.fromEntries(t.map(e=>[e,null]));return(await n("printer.objects.query",{objects:e})).status}})},usePrinterObjectSubscription=function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];let[o,s]=(0,n.useState)(null),i=(0,n.useRef)(o);i.current=o;let u=(0,n.useRef)(e);u.current=e;let c=(0,n.useCallback)(e=>{var t;return null==u.current?e:null===(t=u.current)||void 0===t?void 0:t.call(u,e)},[]),l=(0,n.useMemo)(()=>Object.fromEntries(r.map(e=>[e,null])),[JSON.stringify(r.sort())]),{subscribeToObject:d}=useMoonraker({onStatusUpdate:(0,n.useCallback)(e=>{let t={};for(let r in l)null!=e[r]&&(t[r]=e[r]);let r=c(t);if(null==r||"object"!=typeof r)throw Error("Invalid selection function, must return object, got "+typeof r);Object.keys(t).length>0&&!1===g()(r,i.current)&&s(e=>(0,f.T)(null!=e?e:{},r))},[c,l])});return(0,n.useEffect)(()=>{let e=d(...Object.keys(l));return e.then(e=>{s(c(e.res))}).catch(e=>{e instanceof Error&&(0,m.j)().error(e)}),()=>{e.then(e=>e.unsuscribe()).catch(e=>{e instanceof Error&&(0,m.j)().error(e)})}},[c,l,d]),o},useNamespacedItemMutation=(e,t,r)=>{let{saveItem:n}=useMoonraker();return(0,o.D)({...r,mutationKey:[e,t],mutationFn:r=>n(e,t,r)})},useMoonrakerState=function(e,t){var r;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=useNamespacedItemQuery(e,t,{initialData:a}),s=useNamespacedItemMutation(e,t),i=(0,n.useCallback)(async e=>{var t;let r="function"==typeof e?e(null!==(t=o.data)&&void 0!==t?t:a):e;await s.mutateAsync(r,{onSuccess:()=>{o.refetch()}})},[a,s,o]);return[null!==(r=o.data)&&void 0!==r?r:a,i,o,s]}},79293:function(e,t,r){"use strict";r.d(t,{SX:function(){return o},uF:function(){return s}});var n=r(67763),a=r(61863);function getBaseUrl(){return"/configure"}r(28070);let o=(0,a.t)({config:()=>({links:[(0,n.N8)({url:"".concat(getBaseUrl(),"/api/trpc"),maxURLLength:2083})]}),overrides:{useMutation:{async onSuccess(e){await e.originalFn(),await e.queryClient.invalidateQueries()}}},ssr:!1}),s=(0,n.K5)({links:[(0,n.N8)({url:"".concat(getBaseUrl(),"/api/trpc"),maxURLLength:2083})]})},31354:function(e,t,r){"use strict";r.d(t,{s:function(){return o}});var n=r(94594);let a=n.z.enum(["trace","debug","info","warn","error","fatal"]),o=n.z.object({ts:n.z.number(),messages:n.z.array(n.z.any()),bindings:n.z.array(n.z.record(n.z.string(),n.z.any())),level:n.z.object({label:a,value:n.z.number()})})}}]);
//# sourceMappingURL=2745-a7223a8414dc44e3.js.map