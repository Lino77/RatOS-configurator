"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[352],{26989:function(e,t,r){r.d(t,{X:function(){return getHost}});let getHost=()=>{var e;return""!="".trim()?"":(null===(e=window.location)||void 0===e?void 0:e.hostname)!=null?window.location.hostname:null}},61352:function(e,t,r){r.d(t,{oK:function(){return useMoonraker},xH:function(){return useMoonrakerMutation},DS:function(){return useMoonrakerQuery},Fu:function(){return useMoonrakerState},A4:function(){return useNamespacedItemQuery},hS:function(){return usePrinterObjectQuery},Q:function(){return usePrinterObjectSubscription}});var n=r(49738),a=r(2973),o=r(45277),s=r(43790),u=r(26989);let i=[{version:1,description:"Undo double JSON encoding of RatOS's data",up:async()=>{let e=await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS"));if(!e.ok)return{result:"Nothing to migrate"};{let t=await e.json();if("error"in t)throw Error(t.error.message);let r=[];if(null==t.result.value)return{result:"Nothing to migrate"};for await(let[e,r]of Object.entries(t.result.value))try{let t=JSON.parse(r);console.log("Migrating",e,"from",r,"to",t),await window.fetch("http://".concat((0,u.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})})}catch(t){console.error("Error migrating",e,r,"clearing key"),await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS&key=").concat(encodeURIComponent(e)),{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e})});continue}return{result:"Succesfully decoded ".concat(r.length," keys.\n").concat(r.join("\n"))}}},down:async()=>{let e=await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS"));if(e.ok){let t=await e.json();if("error"in t)throw Error(t.error.message);if(null==t.result.value)return{result:"Nothing to migrate"};let r=[];for await(let[e,n]of Object.entries(t.result.value)){let t=JSON.stringify(n);await window.fetch("http://".concat((0,u.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})}),r.push("Re-encoded ".concat(e))}return{result:"Succesfully re-encoded ".concat(r.length," keys.\n").concat(r.join("\n"))}}return{result:"Nothing to migrate"}}}],getCurrentVersion=async()=>{let e=await window.fetch("http://".concat((0,u.X)(),"/server/database/item?namespace=RatOS&key=__db_version"));if(e.ok){let t=await e.json();return"error"in t?0:t.result.value}return 0},setCurrentVersion=async e=>{await window.fetch("http://".concat((0,u.X)(),"/server/database/item"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:"__db_version",value:e})})},l=!1,migrate=async(e,t)=>{if(l)return console.log("Already migrating, ignoring..");if(e===t)return console.log("Already at target version");l=!0;try{let r=i.filter(r=>r.version>=e&&r.version<=t).sort((r,n)=>e<=t?r.version-n.version:n.version-r.version);for await(let n of r){let r=await (e<t?n.up():n.down());console.log("Migrated to version ".concat(n.version,": ").concat(r.result))}await setCurrentVersion(t)}finally{l=!1}},c=!1,migrateToLatest=async()=>{if(c)return console.log("Already migrated, ignoring..");let e=await getCurrentVersion(),t=Math.max(...i.map(e=>e.version));if(e===t){console.log("Already at latest version");return}if(l){console.log("Already migrating, ignoring..");return}console.log("Migrating to latest version...",e,t),await migrate(e,t),c=!0,console.log("Migration complete.")};var f=r(52540);let d=0,getWsURL=()=>{let e=(0,u.X)();return null==e||""==e.trim()?null:"ws://".concat(e,"/websocket")},g={},useMoonraker=()=>{let e=(0,n.useRef)({}),t=(0,n.useRef)({}),r=(0,n.useRef)([]),a=(0,n.useRef)([]),[o,u]=(0,n.useState)(getWsURL());(0,n.useEffect)(()=>{u(getWsURL())},[]);let{lastJsonMessage:i,sendJsonMessage:l,readyState:c}=(0,s.ZP)(o,{filter:t=>{if("connected"!==m)return!0;try{let n=JSON.parse(t.data);if(null!=e.current[n.id])return!0;if("notify_status_update"===n.method&&null!=n.params){let e=n.params[0];if(null!=e)for(let t of r.current){let r=g[t];if(null!=r){for(let t in r)if(null!=e[t])return!0}}}return!1}catch(e){console.warn("Failed to parse message",e,t.data)}return!0},shouldReconnect:e=>!0,reconnectAttempts:1/0,reconnectInterval:3e3,share:!0}),f=(0,n.useRef)(c);f.current=c;let[m,y]=(0,n.useState)(1===c?"connected":"connecting"),p=(0,n.useCallback)((e,t)=>{1===f.current?e():a.current.push({resolve:e,reject:t})},[]),h=(0,n.useCallback)(()=>new Promise((e,t)=>{p(e,t)}),[p]),v=(0,n.useCallback)(async function(r){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await h(),new Promise((a,o)=>{let s=++d;e.current[s]=(e,t)=>e?o(e):(null==t?void 0:t.error)?o(t.error):void a(t);let u=1e4;"printer.gcode.script"===r&&(u=6e4),t.current[s]=window.setTimeout(()=>{var r,n;null===(r=(n=e.current)[s])||void 0===r||r.call(n,Error("Request timed out"),null),delete e.current[s],delete t.current[s]},u),l({jsonrpc:"2.0",method:r,params:n,id:s})})},[h,l]),b=(0,n.useCallback)(async function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let a=Object.fromEntries(t.map(e=>[e,null])),o=Object.assign({},a,...Object.values(g).filter(e=>null!=e)),s=(await v("printer.objects.subscribe",{objects:o})).status,u=d;return g[u]=a,r.current.push(u),{res:s,unsuscribe:async()=>{if(r.current=r.current.filter(e=>e!==u),null==g[u]){delete g[u];let e=Object.assign({},...Object.values(g).filter(e=>null!=e));await v("printer.objects.subscribe",{objects:e})}}}},[v]),w=(0,n.useCallback)(async(e,t,r)=>(await h(),await v("server.database.post_item",{namespace:e,key:t,value:r})),[v,h]),O=(0,n.useCallback)(async(e,t)=>{await h();try{var r;let n=await v("server.database.get_item",{namespace:e,key:t});return null!==(r=null==n?void 0:n.value)&&void 0!==r?r:null}catch(e){return console.log(e),null}},[v,h]);return(0,n.useEffect)(()=>{1===c?(async()=>{await migrateToLatest(),a.current.forEach(e=>e.resolve()),a.current=[],y("connected")})():y("connecting")},[c]),(0,n.useEffect)(()=>{(null==i?void 0:i.id)&&e.current[i.id]&&(window.clearTimeout(t.current[i.id]),e.current[i.id](null,i.result),delete t.current[i.id],delete e.current[i.id])},[i]),(0,n.useEffect)(()=>()=>{for(let r in t.current)delete t.current[r],delete e.current[r];if(r.current.length>0){r.current.forEach(e=>{delete g[e]}),r.current=[];let e=Object.assign({},...Object.values(g).filter(e=>null!=e));v("printer.objects.subscribe",{objects:Object.keys(e).length>0?e:null}).catch(e=>{})}a.current.forEach(e=>e.reject()),a.current=[]},[]),{query:v,saveItem:w,getItem:O,subscribeToObject:b,status:m,lastMessage:i,isReady:1===c}},useNamespacedItemQuery=(e,t,r)=>{let{getItem:n}=useMoonraker();return(0,a.a)({...r,queryKey:[e,t],queryFn:async()=>n(e,t)})},useMoonrakerQuery=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker(),o=3===t.length?t[2]:t[1],s=3===t.length?t[1]:void 0,u=t[0],i=3===t.length?[u,s]:[u];return(0,a.a)({...null!=o?o:{},queryKey:[t[0]],queryFn:async()=>n(...i)})},useMoonrakerMutation=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker(),a=t[1],s=t[0];return(0,o.D)({...a,mutationKey:[t[0]],mutationFn:async e=>{let t=e?[s,e]:[s];return n(...t)}})},usePrinterObjectQuery=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let{query:n}=useMoonraker();return(0,a.a)({queryKey:t,queryFn:async()=>{let e=Object.fromEntries(t.map(e=>[e,null]));return(await n("printer.objects.query",{objects:e})).status}})},usePrinterObjectSubscription=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let[a,o]=(0,n.useState)(null),{subscribeToObject:s,lastMessage:u}=useMoonraker(),i=(0,n.useMemo)(()=>Object.fromEntries(t.map(e=>[e,null])),[JSON.stringify(t.sort())]);return(0,n.useEffect)(()=>{let e=s(...Object.keys(i));return e.then(e=>{o(e.res)}).catch(e=>{e instanceof Error&&console.error(e)}),()=>{e.then(e=>e.unsuscribe()).catch(e=>{e instanceof Error&&console.error(e)})}},[i,s]),(0,n.useEffect)(()=>{if((null==u?void 0:u.method)==="notify_status_update"&&null!=u.params){let e=u.params[0],t={};for(let r in i)null!=e[r]&&(t[r]=e[r]);Object.keys(t).length>0&&o(e=>(0,f.T)(null!=e?e:{},t))}},[i,u]),a},useNamespacedItemMutation=(e,t,r)=>{let{saveItem:n}=useMoonraker();return(0,o.D)({...r,mutationKey:[e,t],mutationFn:r=>n(e,t,r)})},useMoonrakerState=function(e,t){var r;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=useNamespacedItemQuery(e,t,{initialData:a}),s=useNamespacedItemMutation(e,t),u=(0,n.useCallback)(async e=>{var t;let r="function"==typeof e?e(null!==(t=o.data)&&void 0!==t?t:a):e;s.mutate(r,{onSuccess:()=>{o.refetch()}})},[a,s,o]);return[null!==(r=o.data)&&void 0!==r?r:a,u,o,s]}}}]);