(()=>{var e={};e.id=8723,e.ids=[8723],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},38316:e=>{"use strict";e.exports=require("zod")},39491:e=>{"use strict";e.exports=require("assert")},50852:e=>{"use strict";e.exports=require("async_hooks")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},73292:e=>{"use strict";e.exports=require("fs/promises")},98188:e=>{"use strict";e.exports=require("module")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},14521:e=>{"use strict";e.exports=require("readline")},12781:e=>{"use strict";e.exports=require("stream")},71576:e=>{"use strict";e.exports=require("string_decoder")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},26144:e=>{"use strict";e.exports=require("vm")},71267:e=>{"use strict";e.exports=require("worker_threads")},32942:(e,t,n)=>{"use strict";n.r(t),n.d(t,{GlobalError:()=>s.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>d,routeModule:()=>x,tree:()=>c});var i=n(46855),r=n(12875),a=n(7611),s=n.n(a),o=n(32600),l={};for(let e in o)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(l[e]=()=>o[e]);n.d(t,l);let c=["",{children:["calibration",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(n.bind(n,99024)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/calibration/page.tsx"]}]},{layout:[()=>Promise.resolve().then(n.bind(n,78796)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/calibration/layout.tsx"]}]},{layout:[()=>Promise.resolve().then(n.bind(n,25419)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/layout.tsx"],template:[()=>Promise.resolve().then(n.bind(n,22709)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/template.tsx"],"not-found":[()=>Promise.resolve().then(n.t.bind(n,28626,23)),"next/dist/client/components/not-found-error"]}],d=["/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/calibration/page.tsx"],u="/calibration/page",m={require:n,loadChunk:()=>Promise.resolve()},x=new i.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/calibration/page",pathname:"/calibration",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},2376:(e,t,n)=>{Promise.resolve().then(n.bind(n,11336))},11336:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>Page});var i=n(28793),r=n(370),a=n(32801),s=n(3966),o=n.n(s),l=n(15611),c=n(57748),d=n(23681),u=n(37993);let useDebounce=(e,t)=>{let n=(0,s.useRef)(),i=(0,s.useRef)([]);return(0,s.useEffect)(()=>()=>{n.current&&clearTimeout(n.current)},[]),(0,s.useCallback)((...r)=>{i.current=r,n.current||(n.current=setTimeout(()=>{e(...i.current),n.current=void 0},t))},[e,t])},m={duration:150},Button=e=>{let[t]=(0,l.u)(),[n,r]=o().useState(!1),a=useDebounce(r,200),m=(0,s.useCallback)(async()=>{e.onClick&&!e.isLoading&&(a(!0),await e.onClick(),a(!1))},[a,e]);return(0,i.jsxs)("li",{className:(0,c.d)("flex"),children:["before"===e.subButtonPosition&&i.jsx("ol",{ref:t,className:"flex divide-x divide-zinc-200 dark:divide-zinc-800",children:e.children}),i.jsx("div",{className:(0,c.d)("flex items-center",e.isActive&&"dark:bg-zinc-800"),children:(0,i.jsxs)("button",{onClick:m,type:"button",title:e.title,className:(0,d.m)("flex items-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-700 transition-transform hover:text-black active:scale-95 dark:text-zinc-300 dark:hover:text-white",e.isActive?"hover:text-brand:600 text-brand-600 dark:text-brand-500 dark:hover:text-brand-500":"",e.hidden?"hidden":"",e.className),children:[e.icon&&(e.isLoading||n)&&i.jsx(u.$,{noMargin:!0,className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),e.icon&&!e.isLoading&&i.jsx(e.icon,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),e.name&&i.jsx("span",{className:"inline",children:e.name})]})}),null!=e.subButtonPosition&&"before"!==e.subButtonPosition&&i.jsx("ol",{ref:t,className:"flex divide-x divide-zinc-200 dark:divide-zinc-800",children:e.children}),null==e.subButtonPosition&&e.children&&e.children]},e.id)};function Toolbar(e){let[t]=(0,l.u)(m);return i.jsx("nav",{className:(0,d.m)("flex select-none overflow-hidden rounded-md border border-zinc-200 bg-white shadow dark:border-zinc-800 dark:bg-zinc-900/80",e.className),"aria-label":"Breadcrumb",children:i.jsx("ol",{role:"list",className:"flex divide-x divide-zinc-200 dark:divide-zinc-800",ref:t,children:e.buttons.map(t=>{let n=e.subButtons?.filter(e=>e.parent===t.id);return t.hidden?null:(0,s.createElement)(Button,{...t,key:t.id},null!=n&&n.length>0&&t.isActive?n.map(e=>e.hidden?null:(0,s.createElement)(Button,{...e,key:e.id})):t.children)})})})}var x=n(54743),h=n(11438),p=n(18391),f=n(82542),b=n(10654),g=n(49376),v=n(5486),y=n(50036),k=n(65073),j=n(88737),w=n(76690),N=n(61739),z=n(21410),C=n(28874),S=n(76871);let ScrollContainer=e=>i.jsx("div",{...e,className:(0,d.m)("scroll-smooth scrollbar-thin scrollbar-track-transparent scrollbar-thumb-zinc-400 scrollbar-thumb-rounded-md dark:scrollbar-thumb-zinc-600",e.className)}),_={pixelPrMm:160,outerNozzleDiameter:1,flipVertical:!1,flipHorizontal:!1},CameraSettingsDialog=e=>{let t=(0,s.useRef)(!1),[n,r,a]=(0,C.Fu)("RatOS","camera-settings",_),[o,l]=(0,s.useState)(a.isFetched?n.pixelPrMm.toFixed(2):null),[c,u]=(0,s.useState)(a.isFetched?n.outerNozzleDiameter.toFixed(2):null),m=useDebounce(r,200);return(0,s.useEffect)(()=>{a.isFetched&&!1===t.current&&(l(n?.pixelPrMm.toFixed(2)??_.pixelPrMm.toFixed(2)),u(n?.outerNozzleDiameter.toFixed(2)??_.outerNozzleDiameter.toFixed(2)),t.current=!0)},[n,a.isFetched]),(0,i.jsxs)(ScrollContainer,{className:(0,d.m)("scroll absolute left-5 top-1/2 max-h-[50%] w-80 -translate-y-1/2 transform-gpu overflow-y-auto rounded-md border-y border-r border-zinc-800 bg-zinc-100 p-5 shadow-lg transition-all dark:bg-zinc-900/70",e.isVisible?"translate-x-0 opacity-100":"pointer-events-none -translate-x-8 opacity-0",e.className),onWheel:e=>{e.stopPropagation()},children:[(0,i.jsxs)("h3",{className:"flex flex-1 items-center justify-between text-base font-medium leading-7 text-zinc-900 dark:text-zinc-100",children:[i.jsx("span",{children:"Camera Settings"}),i.jsx(S,{className:"h-5 w-5 cursor-pointer",onClick:()=>e.toggle(!e.isVisible)})]}),(0,i.jsxs)("div",{className:"mt-4 grid grid-cols-1 gap-4 border-t border-zinc-100 pt-4 dark:border-zinc-800",children:[i.jsx(N.o,{label:"Pixel per mm",type:"number",value:o??"",placeholder:a.isFetched?void 0:"Loading...",onChange:e=>{let t=parseFloat(e);l(e),isNaN(t)||m(e=>({...e,pixelPrMm:t}))},error:isNaN(parseFloat(o??""))?"Not a valid number":void 0}),i.jsx(N.o,{label:"Outer Nozzle Diameter",type:"number",step:.1,value:c??"",placeholder:a.isFetched?void 0:"Loading...",onChange:e=>{let t=parseFloat(e);console.log(e,t),u(e),isNaN(t)||m(e=>({...e,outerNozzleDiameter:t}))},error:isNaN(parseFloat(c??""))?"Not a valid number":void 0}),i.jsx(z.Z,{label:"Flip vertical",onChange:e=>r({...n??_,flipVertical:e??!1}),description:"Whether to flip the camera vertically",value:n?.flipVertical??_.flipVertical}),i.jsx(z.Z,{label:"Flip horizontal",onChange:e=>r({...n??_,flipHorizontal:e??!1}),description:"Whether to flip the camera horizontally",value:n?.flipHorizontal??_.flipHorizontal})]})]})};var P=n(24607);let ExposureIcon=e=>(0,i.jsxs)("svg",{viewBox:"0 0 512 512",xmlns:"http://www.w3.org/2000/svg",className:e.className,children:[i.jsx("path",{fill:"currentColor",d:"M456,40H56A16,16,0,0,0,40,56V456a16,16,0,0,0,16,16H456a16,16,0,0,0,16-16V56A16,16,0,0,0,456,40ZM72,72H417.373L72,417.373ZM440,440H94.627L440,94.627Z"}),i.jsx("polygon",{fill:"currentColor",points:"336 368 336 408 368 408 368 368 408 368 408 336 368 336 368 296 336 296 336 336 296 336 296 368 336 368"}),i.jsx("rect",{width:"112",height:"32",x:"112",y:"136",fill:"currentColor"})]});var O=n(89169),A=n(45186),R=n(80332),E=n(28821);let useGcodeCommand=()=>{let e=(0,C.xH)("printer.gcode.script");return(0,s.useCallback)(async(t,...n)=>{let i=[t[0]];n.forEach((e,n)=>{i.push(e.toString(),t[n+1])});let r=i.join("");await e.mutateAsync({script:r}),console.log(r)},[e])},FocusControls=e=>{let t=useGcodeCommand();return i.jsx("div",{className:(0,d.m)("scroll absolute transform-gpu overflow-y-auto rounded-md border-y border-r border-zinc-800 bg-zinc-100 font-mono shadow-lg transition-all dark:bg-zinc-900/70",e.isVisible?" -translate-y-full opacity-100":"pointer-events-none  -translate-y-2/3  opacity-0",e.className),onWheel:e=>{e.stopPropagation()},children:(0,i.jsxs)("ol",{className:"flex flex-col divide-y divide-zinc-200 dark:divide-zinc-800",children:[i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z1`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(O,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"+1.00"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z0.5`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(A,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"+0.50"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z0.1`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(A,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"+0.10"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z0.05`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(A,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"+0.05"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z-0.05`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(A,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"-0.05"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z-0.1`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(R,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"-0.10"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z-0.5`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(R,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"-0.50"})]})})}),i.jsx("li",{className:(0,c.d)("flex"),children:i.jsx("div",{className:(0,c.d)("flex flex-1 items-center justify-center text-center"),children:(0,i.jsxs)("button",{onClick:()=>t`G91\nG0 Z-1.0`,type:"button",className:(0,d.m)("flex items-center justify-center space-x-2 whitespace-nowrap px-5 py-3 text-sm font-medium text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-100"),children:[i.jsx(E,{className:"inline h-5 w-5 flex-shrink-0","aria-hidden":"true"}),i.jsx("span",{className:"inline",children:"-1.00"})]})})})]})})},useWindowSize=()=>{let[e,t]=(0,s.useState)({width:0,height:0});return(0,s.useEffect)(()=>{let handleResize=()=>{requestAnimationFrame(()=>{t({width:0,height:0})})};return window.addEventListener("resize",handleResize),()=>window.removeEventListener("resize",handleResize)},[]),e};var T=n(35235),$=n(24874);let parseOptions=e=>{let t=e.matchAll(/- available option:\s(\w+)\s.+(\[-?\d+\.\.\d+\])/g),n=[];for(let e of t){let[t,i]=e[2].slice(1,-1).split("..").map(e=>parseInt(e,10)),r=n.find(t=>t.key===e[1]);r&&"max"in r&&r.max&&r.max<=i||n.push({key:e[1],min:t,max:["redbalance","bluebalance","greenbalance"].includes(e[1])?2e3:i})}let i=e.matchAll(/- available option:\s(\w+)\s.+(\[-?\d+\.\d+\.\.\d+\.\d+\])/g);for(let e of i){let[t,i]=e[2].slice(1,-1).split("..").map(e=>parseFloat(e)),r=n.find(t=>t.key===e[1]);r&&"max"in r&&r.max&&r.max<=i||n.push({key:e[1],float:!0,min:t,max:["redbalance","bluebalance","greenbalance"].includes(e[1])?2e3:i})}let r=e.matchAll(/- available option:\s(\w+)\s.+(\[false\.\.true\])/g);for(let e of r)n.push({key:e[1],toggle:!0});return n};var M=n(73992);let useCameraSettings=(e,t=!1)=>{let[n,i]=(0,s.useState)([]),r=(0,C.bL)("RatOS","camera-stream-settings"),a=(0,C.A4)("RatOS","camera-stream-settings"),o=(0,s.useRef)(a.data);o.current=a.data;let l=(0,s.useMemo)(()=>n.map(e=>(e.value=o.current?.[e.key]?.value??e.value,e)),[n]),c=(0,s.useCallback)(async t=>{let n=await fetch(`${e}/option?compressionquality=${t}`);i(parseOptions(await n.text()))},[e]),d=(0,s.useCallback)(async(t,i)=>{let s=n.find(e=>e.key===t);if(null==s)throw Error(`Invalid option ${t}`);if(s&&"toggle"in s&&"boolean"!=typeof i)throw Error(`Expect a boolean value for ${t}, got ${i}`);if(s&&"max"in s&&("number"!=typeof i||s.min>i||s.max<i))throw Error(`Value ${i} is out of range for ${t}`);try{let n=await fetch(`${e}/option?${t}=${i.toString()}`);return console.log(n.ok,a.isInitialLoading),n.ok&&!1===a.isInitialLoading&&(console.log("saving",t,i,o.current,(0,M.T)(o.current??{},{[t]:{value:i}})),await r.mutateAsync((0,M.T)(o.current??{},{[t]:{value:i}}))),n.ok}catch(e){return!1}},[n,r,e,a]);return(0,s.useEffect)(()=>{if(t&&c(100),t&&a.isFetched&&null!=o.current)for(let t in o.current){let n=o.current[t]?.value;n&&fetch(`${e}/option?${t}=${n.toString()}`)}},[a.isFetched,e,t,c]),{options:l,setOption:d}},Slider=({onChange:e,min:t,max:n,initialValue:r,step:a,isBoolean:o})=>{let[l,c]=(0,s.useState)(r??t),d=useDebounce((0,s.useCallback)(t=>{e?.(t)},[e]),100),u=(0,s.useCallback)(e=>{let t=a?parseFloat(e.target.value):parseInt(e.target.value,10);c(t),d(t)},[d,a]);return(0,i.jsxs)("div",{className:"relative mb-6",children:[i.jsx("input",{type:"range",value:l,onChange:u,min:t,max:n,step:a??1,className:"h-2 w-full cursor-pointer appearance-none rounded-lg bg-zinc-200 dark:bg-zinc-700"}),i.jsx("span",{className:"absolute -bottom-6 start-0 text-sm text-zinc-500 dark:text-zinc-400",children:o?"Off":`Min (${t})`}),!o&&i.jsx("span",{className:"absolute -bottom-6 start-1/3 -translate-x-1/2 text-sm text-zinc-500 dark:text-zinc-400 rtl:translate-x-1/2",children:(n/3).toFixed(2)}),!o&&i.jsx("span",{className:"absolute -bottom-6 start-2/3 -translate-x-1/2 text-sm text-zinc-500 dark:text-zinc-400 rtl:translate-x-1/2",children:(n/3*2).toFixed(2)}),i.jsx("span",{className:"absolute -bottom-6 end-0 text-sm text-zinc-500 dark:text-zinc-400",children:o?"On":`Max (${n})`})]})};var F=n(30928);let getCameraUrl=()=>{let e=(0,$.X)();return null==e||""==e.trim()?"/webcam":`http://${e}/webcam`};function Page(){let[e,t]=(0,s.useState)(getCameraUrl());(0,s.useEffect)(()=>{t(getCameraUrl())},[]);let[n,o]=(0,s.useState)(null),[m,N]=(0,s.useState)(null),[z,S]=(0,s.useState)(.1),{videoRef:_,connectionState:O}=function(e,t){let n=(0,s.useRef)(null),i=(0,s.useRef)(null),r=(0,s.useRef)(null),a=(0,s.useRef)(e),o=(0,s.useRef)(!1),[l,c]=(0,s.useState)(null),d=(0,s.useRef)(null),u=(0,s.useCallback)(e=>{if(e.candidate)return fetch(a.current,{body:JSON.stringify({type:"remote_candidate",id:d.current,candidates:[e.candidate]}),headers:{"Content-Type":"application/json"},method:"POST"}).catch(function(e){window.console.error(e)})},[]),m=(0,s.useCallback)(async()=>{r.current&&(r.current.close(),r.current=null),o.current=!0;try{c("new");var t={sdpSemantics:"unified-plan"};document.getElementById("use-stun")&&document.getElementById("use-stun").checked&&(t.iceServers=[{urls:["stun:stun.l.google.com:19302"]}]);let s=new URLSearchParams(e),o=Object.fromEntries(s.entries()),l=await fetch(e,{body:JSON.stringify({type:"request",res:o.res}),headers:{"Content-Type":"application/json"},method:"POST"});if(l.ok){let s=await l.json();s.iceServers&&(t.iceServers=s.iceServers),r.current=new RTCPeerConnection(t),r.current.addTransceiver("video",{direction:"recvonly"}),r.current.addEventListener("track",function(e){if("video"==e.track.kind){if(n.current)n.current.srcObject=e.streams[0];else throw Error("No video ref to set src on")}else i.current&&(i.current.srcObject=e.streams[0])}),r.current.addEventListener("connectionstatechange",()=>{let e=r.current?.connectionState;c(e??null)}),d.current=s.id,await r.current.setRemoteDescription(s);let o=await r.current.createAnswer();await r.current.setLocalDescription(o),await new Promise(function(e){if(null==r.current)throw Error("peerConnection.current is null");"complete"===r.current.iceGatheringState?e(null):r.current.addEventListener("icegatheringstatechange",function checkState(){if(null==r.current)throw Error("peerConnection.current is null");"complete"===r.current.iceGatheringState&&(r.current.removeEventListener("icegatheringstatechange",checkState),e(null))})}),r.current.addEventListener("icecandidate",u);var a=r.current.localDescription;if(null==a)throw Error("No offer from peerConnection");await fetch(e,{body:JSON.stringify({type:a.type,id:d.current,sdp:a.sdp}),headers:{"Content-Type":"application/json"},method:"POST"})}else c("failed")}catch(e){console.error(e),c("failed")}finally{o.current=!1}},[u,e]);return(0,s.useEffect)(()=>{if(t){let e=setInterval(async()=>{if(r.current){let e=await r.current.getStats();e.forEach(e=>{"inbound-rtp"===e.type&&"video"===e.kind&&t?.(e)})}},1e3);return()=>clearInterval(e)}},[t]),(0,s.useEffect)(()=>{e&&!1===o.current?m():r.current&&!1===o.current&&r.current.close()},[m,e]),(0,s.useEffect)(()=>{if(["failed","disconnected"].includes(l??"")){let e=setTimeout(()=>{m()},5e3);return()=>clearTimeout(e)}},[m,l]),{videoRef:n,audioRef:i,connectionState:l,close:(0,s.useCallback)(()=>{r.current?.close()},[])}}(e+"/webrtc",(0,s.useCallback)(e=>{e.framesPerSecond&&o(e.framesPerSecond),e.frameHeight&&e.frameWidth&&N(e.frameWidth/e.frameHeight)},[])),[A]=(0,C.Fu)("RatOS","camera-settings"),R=(0,F.W6)(null,(e,t)=>{null!=e&&S(e.getBoundingClientRect().width/e.getBoundingClientRect().height)}),E=(0,s.useRef)(null),[$,M]=(0,s.useState)(null),[L,q]=(0,s.useState)({x:!1,y:!1}),{options:V,setOption:B}=useCameraSettings(e,"connected"===O),[G,D]=(0,s.useState)(!1),[W,Z]=(0,s.useState)(!1),[H,I]=(0,s.useState)(!1),[X,U]=(0,s.useState)(!1),[J,Q]=(0,s.useState)(!1),[Y,K]=(0,s.useState)(!1),[ee,et]=(0,s.useState)(!1),[en,ei]=(0,s.useState)(!1),[er,ea]=(0,s.useState)(!1),[es,eo]=(0,s.useState)(!1),[el,ec]=(0,s.useState)(1),[ed,eu]=(0,s.useState)(!1),em=useGcodeCommand(),[ex]=(0,l.u)(),eh=useWindowSize(),ep=(0,C.Q)(e=>({tool:"extruder"===e.toolhead.extruder?"T0":"T1",homed_axes:e.toolhead.homed_axes,position:e.toolhead.position}),"toolhead"),{isVaocStarted:ef}=(0,C.Q)(e=>({isVaocStarted:e["gcode_macro _VAOC"].is_started}),"gcode_macro _VAOC")??{isVaocStarted:!1},[eb]=(0,P.S)([er],200,!0),[eg]=(0,P.I)([er],190,10,!0),{hasZOffsetProbe:ev}=(0,C.Q)(e=>({hasZOffsetProbe:null!=e.configfile.settings.z_offset_probe}),"configfile")??{hasZOffsetProbe:!1},[ey,ek]=(0,s.useState)(!1);(0,s.useEffect)(()=>{console.log(ep)},[ep]),(0,s.useEffect)(()=>{null!=R.current&&S((R.current?.getBoundingClientRect().width/R.current?.getBoundingClientRect().height)??eh.width/eh.height)},[eh,R]);let ej=(0,s.useCallback)(e=>{let t=_.current?.videoWidth??1,n=R.current?.getBoundingClientRect().width??1;return e*el*(n>0&&t>0?n/t:1)},[_.current,el,eh]),ew=(0,s.useCallback)(e=>{let t=_.current?.videoWidth??1,n=R.current?.getBoundingClientRect().width??1;return e/el/(n>0&&t>0?n/t:1)},[R,_,el]),eN=(0,s.useCallback)(e=>ej(e)*(A?.pixelPrMm??0),[ej,A?.pixelPrMm,eh]),ez=(0,s.useCallback)(e=>ew(e)/(A?.pixelPrMm??0),[ew,A?.pixelPrMm]),[eC,eS]=(0,P.S)([el],2e3,!0),e_=eC||X,eP=(0,s.useCallback)(()=>{U(e=>!e),eS()},[eS]);(0,x.useGesture)({onDrag:e=>{if(e.dragging)M([e.offset[0],e.offset[1]]),q({x:e._movementBound[0],y:e._movementBound[1]});else{let e=ez($?.[0]??0),t=-1*ez($?.[1]??0);em`_VAOC_MOVE X=${e} Y=${t}`,M(null),q({x:!1,y:!1})}},onPinch:e=>{ec(t=>Math.max(Math.min(t*e.offset[0],10),1))},onWheel:e=>{0!=e.delta[1]&&!1!=e.wheeling&&!1!=e.intentional&&(e.delta[1]<0?ec(e=>Math.max(.85*e,1)):ec(e=>Math.min(1.15*e,10)))}},{target:_,enabled:"connected"===O,drag:{enabled:G,from:()=>[0,0],bounds:{left:-eN(1),right:eN(1),top:-eN(1),bottom:eN(1)},rubberband:!0},wheel:{axis:"y",rubberband:!1},pinch:{scaleBounds:{min:1,max:10},pinchOnWheel:!1,rubberband:!0}});let eO=[{icon:ef?r:a,id:"start/stop",name:ef?void 0:"Start Calibration",title:ef?"Stop calibration":"Start calibration",onClick:async()=>{W||(Z(!0),await (ef?em`_VAOC_END`:em`_VAOC_START`),Z(!1))},isActive:ef},{name:"T0",id:"t0",hidden:!ef,title:"Switch to tool 0 (T0)",onClick:async()=>{D(!1),await em`_VAOC_LOAD_TOOL T=0`},isActive:ep?.tool==="T0"},{name:"T1",id:"t1",hidden:!ef,title:"Switch to tool 1 (T1)",onClick:async()=>{D(!1),await em`_VAOC_LOAD_TOOL T=1`},isActive:ep?.tool==="T1"}],eA=[{icon:h,id:"zoom",title:`${e_?"Hide":"Show"} zoom controls`,subButtonPosition:"before",className:"font-mono",name:el>=10?"MAX!":(0,i.jsxs)(i.Fragment,{children:[i.jsx(T.ZP,{preserveValue:!0,start:0,end:Math.round(100*el),duration:.15}),"%"]}),onClick:()=>{eP()},isActive:e_},{icon:p,id:"light",title:`${es?"Turn off":"Turn on"} the LEDs`,onClick:async()=>{let e=!es;await em`_VAOC_SWITCH_LED STATE=${e?1:0}`,eo(e)},isActive:es}],eR=(0,s.useMemo)(()=>[{name:"Settings",icon:f,id:"settings",title:"Show camera settings dialog",onClick:()=>{I(e=>!e)},isActive:H},{name:ep?.tool==="T0"?"Set reference":"Set offset",icon:b,isLoading:eb,hidden:!ef,id:"reference",title:`Set the ${ep?.tool==="T0"?"T0 reference point":"T1 offset"}`,onClick:async()=>{ek(!!ev),ea(!0),await em`_VAOC_SET_TOOL`,ea(!1),D(!1)},isActive:eb},{name:G?(0,i.jsxs)("span",{className:"font-mono",children:[(ep?.position?.[0]??0).toFixed(2),", ",(ep?.position?.[1]??0).toFixed(2)]}):"Move",icon:g,hidden:!ef,id:"move",title:`${G?"Disable":"Enable"} drag and drop calibration`,onClick:()=>{G?(et(!1),Q(!1),K(!1),ei(!1),eu(!1)):(et(!0),Q(!1),K(!1),ei(!1),eu(!0)),D(e=>!e)},isActive:G},{name:"Z-Probe",icon:v,title:"Probe the z endstop to set the Z offset",id:"z-probe",hidden:!ef||!ev||!ey,onClick:async()=>{await em`_VAOC_PROBE_Z_OFFSET`},isActive:!1}],[H,ep?.tool,ep?.position,eb,ef,G,ev,ey,em]),eE=(0,s.useMemo)(()=>{let e=[{icon:y,name:i.jsx("span",{children:null==n?"Loading...":(0,i.jsxs)("span",{children:[i.jsx(T.ZP,{start:0,preserveValue:!0,duration:1,end:n})," FPS"]})}),className:"font-mono",id:"settings",subButtonPosition:"before",title:`${ed?"Hide":"Show"} camera controls`,onClick:()=>{ed&&(et(!1),Q(!1),K(!1),ei(!1)),eu(e=>!e)},isActive:ed}];return e},[n,ed]),eT=(0,s.useMemo)(()=>{let e=[{icon:k,id:"focus",parent:"settings",hidden:Y||en||J,name:"Z Focus",title:`${ee?"Hide":"Show"} focus controls`,children:i.jsx(FocusControls,{isVisible:ee,toggle:et}),onClick:()=>{et(e=>!e),Q(!1),K(!1),ei(!1)},isActive:ee},{icon:ExposureIcon,id:"exposure",parent:"settings",hidden:Y||en||ee,title:`${J?"Hide":"Show"} exposure controls`,name:"Exposure",onClick:()=>{Q(e=>!e),K(!1),ei(!1),et(!1)},isActive:J},{icon:j,id:"color",parent:"settings",title:`${Y?"Hide":"Show"} color controls`,hidden:J||en||ee,name:"Color",onClick:()=>{K(e=>!e),Q(!1),ei(!1),et(!1)},isActive:Y},{icon:w,id:"advanced-camera-controls",parent:"settings",title:`${en?"Hide":"Show"} advanced camera controls`,name:"Advanced",hidden:J||Y||ee,onClick:()=>{ei(e=>!e),Q(!1),K(!1),et(!1)},isActive:en}];return e.reverse()},[en,J,ee,Y]),e$=null==$?0:$[0]/el,eM=null==$?0:$[1]/el,eF=(0,s.useMemo)(()=>eN(.2),[eN]),eL=(0,s.useMemo)(()=>eb?eF:eN(A?A.outerNozzleDiameter/2:0),[eN,eb,eF,A]),eq=(0,s.useMemo)(()=>null==R.current||"connected"!==O?0:eL/R.current.getBoundingClientRect().width*100,[O,R,eL]),eV=(0,s.useMemo)(()=>null==R.current||"connected"!==O?0:eL/R.current.getBoundingClientRect().height*100,[O,R,eL]),eB=(0,s.useMemo)(()=>eN(.01),[eN]);return i.jsx("div",{className:"flex h-[calc(100vh_-_64px)] w-full select-none items-center",ref:E,children:(0,i.jsxs)("div",{className:"relative mx-auto flex h-full max-h-full min-h-[50vh] min-w-[50vw] max-w-fit items-center overflow-hidden object-contain shadow-lg",ref:R,children:[i.jsx("video",{ref:_,className:(0,d.m)("h-full max-h-full w-full min-w-full max-w-full transform-gpu touch-none",G&&"cursor-move",null==$&&"transition-transform ease-in-out"),style:{transform:`scale3d(${el*(A?.flipHorizontal?-1:1)}, ${el*(A?.flipVertical?-1:1)}, 1) translate3d(${e$*(A?.flipHorizontal?-1:1)}px, ${eM*(A?.flipVertical?-1:1)}px, 0)`},autoPlay:!0,muted:!0,playsInline:!0}),(0,i.jsxs)("div",{className:(0,c.d)("pointer-events-none absolute inset-0 flex items-center justify-center"),children:[i.jsx("div",{className:(0,c.d)("absolute inset-0",L.x&&L.x>0?"left-0 right-2/3 bg-gradient-to-r from-red-500/70 to-red-500/0":"left-2/3 right-0 bg-gradient-to-l from-red-500/70 to-red-500/0"),style:{opacity:L.x?Math.abs(L.x-($?.[0]??0))/200:0}}),i.jsx("div",{className:(0,c.d)("absolute inset-0",L.y&&L.y>0?"bottom-2/3 top-0 bg-gradient-to-b from-red-500/70 to-red-500/0":"bottom-0 top-2/3 bg-gradient-to-t from-red-500/70 to-red-500/0"),style:{opacity:L.y?Math.abs(L.y-($?.[1]??0))/200:0}}),(0,i.jsxs)("svg",{width:"100%",height:"100%",children:[(0,i.jsxs)("g",{className:(0,c.d)("connected"===O&&eL>0?"opacity-100":"opacity-0"),children:[i.jsx("rect",{x:"50%",y:`${50-eV}%`,height:`${2*eV}%`,width:eB,shapeRendering:"geometricPrecision",className:"fill-brand-500 transition-all ease-in-out",style:{transform:`translateX(-${eB/2})`}}),i.jsx("rect",{x:`${50-eq}%`,y:"50%",width:`${2*eq}%`,height:eB,shapeRendering:"geometricPrecision",className:"fill-brand-500 transition-all ease-in-out",style:{transform:`translateY(-${eB/2})`}})]}),i.jsx("circle",{cx:"50%",cy:"50%",r:eg?eL:1.5*eL,fill:"none",className:(0,c.d)("ease-out",eg?"fill-brand-300":"fill-brand-300/0 transition-all duration-700"),shapeRendering:"geometricPrecision",strokeWidth:0}),i.jsx("circle",{cx:"50%",cy:"50%",r:eF,fill:"none",className:(0,c.d)("stroke-brand-500 transition-all ease-in-out","connected"===O&&eL>0?"opacity-100":"opacity-0"),shapeRendering:"geometricPrecision",strokeWidth:eB}),i.jsx("circle",{cx:"50%",cy:"50%",r:eL,fill:"none",className:(0,c.d)("stroke-brand-500 transition-all ease-in-out","connected"===O&&eL>0?"opacity-100":"opacity-0"),shapeRendering:"geometricPrecision",strokeWidth:eB})]})]}),i.jsx("div",{className:"absolute bottom-24 left-1/4 right-1/4 max-h-[50%] overflow-y-scroll rounded-md bg-zinc-900/70 scrollbar-thin scrollbar-track-transparent scrollbar-thumb-zinc-400 scrollbar-thumb-rounded-md dark:scrollbar-thumb-zinc-600",children:(0,i.jsxs)("div",{ref:ex,children:[J&&V.filter(e=>e.key.toLowerCase().includes("gain")||e.key.toLowerCase().includes("exposure")||e.key.startsWith("Ae")||e.key.toLowerCase().includes("brightness")).filter(e=>"ColourGains"!==e.key).map(e=>(0,i.jsxs)("div",{className:"p-4",children:[i.jsx("label",{className:"block text-center text-base font-semibold capitalize text-zinc-200",children:e.key}),i.jsx(Slider,{isBoolean:"toggle"in e,min:"toggle"in e?0:"min"in e?e.min:0,initialValue:!0===e.value?1:!1===e.value?0:e.value,max:"toggle"in e?1:"max"in e?e.max:0,step:"float"in e&&e.float?"any":1,onChange:t=>B(e.key,"toggle"in e?!!t:t)})]},e.key)),Y&&V.filter(e=>e.key.toLowerCase().includes("saturation")||e.key.toLowerCase().includes("contrast")||e.key.startsWith("Awb")).map(e=>(0,i.jsxs)("div",{className:"p-4",children:[i.jsx("label",{className:"block text-center text-base font-semibold capitalize text-zinc-200",children:e.key}),i.jsx(Slider,{isBoolean:"toggle"in e,min:"toggle"in e?0:"min"in e?e.min:0,initialValue:!0===e.value?1:!1===e.value?0:e.value,max:"toggle"in e?1:"max"in e?e.max:0,step:"float"in e&&e.float?"any":1,onChange:t=>B(e.key,"toggle"in e?!!t:t)})]},e.key)),en&&V.map(e=>(0,i.jsxs)("div",{className:"p-4",children:[i.jsx("label",{className:"block text-center text-base font-semibold capitalize text-zinc-200",children:e.key}),i.jsx(Slider,{isBoolean:"toggle"in e,min:"toggle"in e?0:"min"in e?e.min:0,initialValue:!0===e.value?1:!1===e.value?0:e.value,max:"toggle"in e?1:"max"in e?e.max:0,step:"float"in e&&e.float?"any":1,onChange:t=>B(e.key,"toggle"in e?!!t:t)})]},e.key))]})}),(0,i.jsxs)("div",{className:(0,d.m)("pointer-events-none absolute inset-0 flex items-center justify-center"),children:[i.jsx("h3",{className:(0,d.m)("absolute inset-0 flex items-center justify-center text-xl font-semibold text-rose-500 transition-all dark:text-rose-500","failed"===O?"animate-pulse opacity-100":"opacity-0"),children:"Webcam stream not found"}),i.jsx(u.$,{noMargin:!0,className:(0,d.m)("h-1/3 w-1/3 animate-spin text-inherit transition-all","text-green-500 dark:text-green-500",("connected"===O||"failed"===O)&&"opacity-0","failed"===O&&"text-rose-500 dark:text-rose-500","connecting"===O&&"text-brand-500 dark:text-brand-500","closed"===O&&"text-yellow-500 dark:text-yellow-500","disconnected"===O&&"text-amber-500 dark:text-amber-500","new"===O&&"text-sky-500 dark:text-sky-500")})]}),(0,i.jsxs)("div",{className:"pointer-events-none absolute inset-0 top-1/2 -translate-y-1/2 transition-all",style:m?{aspectRatio:Math.max(m/el,z)}:{},children:[i.jsx(Toolbar,{className:"pointer-events-auto absolute left-5 top-5",buttons:eO}),i.jsx(Toolbar,{className:"pointer-events-auto absolute bottom-5 right-5 overflow-visible",buttons:eE,subButtons:eT}),i.jsx(Toolbar,{className:"pointer-events-auto absolute right-5 top-5",buttons:eA,subButtons:[{name:"1X",id:"1x",parent:"zoom",title:"Set zoom to 1X (100%)",className:"font-mono",onClick:()=>{ec(1)},isActive:!1},{name:"2X",id:"2x",parent:"zoom",title:"Set zoom to 2X (200%)",className:"font-mono",onClick:()=>{ec(2)},isActive:!1},{name:"4X",id:"4x",parent:"zoom",title:"Set zoom to 4X (400%)",className:"font-mono",onClick:()=>{ec(4)},isActive:!1}]}),i.jsx(Toolbar,{className:"pointer-events-auto absolute bottom-5 left-5",buttons:eR}),i.jsx(CameraSettingsDialog,{className:"pointer-events-auto",isVisible:H,toggle:I})]})]})})}},78796:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>WizardLayout});var i=n(86700),r=n(16239);function WizardLayout({children:e}){return(0,r.headers)().get("x-configurator"),i.jsx("main",{className:"",children:i.jsx("div",{className:"mx-auto max-w-full",children:e})})}},99024:(e,t,n)=>{"use strict";n.r(t),n.d(t,{$$typeof:()=>s,__esModule:()=>a,default:()=>l});var i=n(23646);let r=(0,i.createProxy)(String.raw`/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/calibration/page.tsx`),{__esModule:a,$$typeof:s}=r,o=r.default,l=o}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),n=t.X(0,[5793,8749,6212,2410,3971,4825],()=>__webpack_exec__(32942));module.exports=n})();