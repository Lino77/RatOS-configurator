"use strict";(()=>{var e={};e.id=1455,e.ids=[1455],e.modules={54230:e=>{e.exports=require("glob")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},58545:e=>{e.exports=require("pino")},38316:e=>{e.exports=require("zod")},57147:e=>{e.exports=require("fs")},73292:e=>{e.exports=require("fs/promises")},71017:e=>{e.exports=require("path")},63689:(e,r,t)=>{t.r(r),t.d(r,{config:()=>_,default:()=>h,routeModule:()=>w});var a={};t.r(a),t.d(a,{default:()=>handler});var n=t(93273),i=t(80424),o=t(77354),s=t(71017),l=t.n(s),g=t(74169),d=t(54230);let u=require("jszip");var p=t.n(u),f=t(73292),c=t(97926),m=t(57147);async function handler(e,r){try{if("GET"===e.method){if(null==process.env.RATOS_CONFIGURATION_PATH)return r.status(500).json({result:"error",data:{message:"RATOS_CONFIGURATION_PATH environment variable not set"}});let e=g.Rz.parse(process.env),t=await (0,d.glob)([`${e.RATOS_DATA_DIR}/*.+(cfg|json)`]);t=t.filter((e,r)=>t.indexOf(e)===r);let a=await (0,d.glob)([`${e.KLIPPER_CONFIG_PATH}/../logs/*.log`,`${e.LOG_FILE}`]);a=a.filter((e,r)=>a.indexOf(e)===r);let n=await (0,d.glob)([`${e.KLIPPER_CONFIG_PATH}/+([a-z|A-Z]|-)+(+([0-9])*(_|-)*([0-9])).cfg`]),i=(await (0,d.glob)([`${e.KLIPPER_CONFIG_PATH}/*.cfg`])).filter(e=>!n.includes(e));i=i.filter((e,r)=>i.indexOf(e)===r);let o=await (0,d.glob)(["/var/log/ratos-configurator.log"]),gatherInfo=async(e,r,t)=>{let a=await (0,f.stat)(e),n=e;return a.isSymbolicLink()&&(n=l().resolve(l().dirname(e),await (0,f.readlink)(e)),a=await (0,f.stat)(n)),{path:n,orgPath:e,name:l().basename(e),size:a.size,isFile:a.isFile(),dest:t,source:r}},s=(await Promise.all(t.map(e=>gatherInfo(e,"RatOS","RatOS")).concat(a.map(e=>gatherInfo(e,"logs","logs"))).concat(i.map(e=>gatherInfo(e,"configs","configs"))).concat(o.map(e=>gatherInfo(e,"var/log","var/log"))))).filter(e=>e.isFile),u=new(p());s.map((e,r)=>{(0,c.j)().info(e,`Adding file to zip... (${s.length-(r+1)} remaining)`),u.file(l().join(e.dest,e.name),(0,m.createReadStream)(e.path))});try{let e=u.generateNodeStream({type:"nodebuffer",streamFiles:!0});return r.setHeader("Content-Type","application/x-zip"),r.setHeader("Content-Disposition","attachment; filename=ratos-debug.zip"),r.status(200).send(e)}catch(e){return(0,c.j)().error(e instanceof Error?e.message:"Unknown error while generating debug zip"),r.status(200).json({result:"error",data:{message:"Something went wrong, the irony.."}})}}r.status(405).json({result:"error",data:{message:"Method not allowed"}})}catch(e){return(0,c.j)().error(e instanceof Error?e.message:"Unknown error while generating debug zip"),r.status(500).json({result:"error",data:{message:"Something went wrong, the irony.."}})}}let h=(0,o.l)(a,"default"),_=(0,o.l)(a,"config"),w=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/debug-zip",pathname:"/api/debug-zip",bundlePath:"",filename:""},userland:a})}};var r=require("../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[2716,7926],()=>__webpack_exec__(63689));module.exports=t})();