"use strict";exports.id=2618,exports.ids=[2618],exports.modules={42618:(e,t,a)=>{a.r(t),a.d(t,{default:()=>handler,getDebugZipFiles:()=>getDebugZipFiles});var r=a(71017),n=a.n(r),o=a(74169),i=a(54230),s=a(9227),l=a.n(s),g=a(73292),f=a(97926),c=a(57147);let getDebugZipFiles=async()=>{if(null==process.env.RATOS_CONFIGURATION_PATH)throw Error("RATOS_CONFIGURATION_PATH environment variable not set");let e=o.Rz.parse(process.env),t="+(cfg|json|ndjson|conf)",a=await (0,i.glob)([`${e.RATOS_DATA_DIR}/*.+(cfg|json|conf|log)`,`${e.RATOS_DATA_DIR}/**/*.+(cfg|json|conf|log)`]);a=a.filter((e,t)=>a.indexOf(e)===t);let r=await (0,i.glob)([`${e.KLIPPER_CONFIG_PATH}/../logs/*.${t}`,`${e.LOG_FILE}`]);r=r.filter((e,t)=>r.indexOf(e)===t);let s=await (0,i.glob)([`${e.KLIPPER_CONFIG_PATH}/+([a-z|A-Z]|-)+(+([0-9])*(_|-)*([0-9])).${t}`]),l=(await (0,i.glob)([`${e.KLIPPER_CONFIG_PATH}/*.${t}`,`${e.KLIPPER_CONFIG_PATH}/**/*.${t}`])).filter(e=>!s.includes(e));l=l.filter((e,t)=>l.indexOf(e)===t);let f=await (0,i.glob)(["/var/log/ratos-configurator.log"]),gatherInfo=async(e,t,a)=>{let r=await (0,g.stat)(e),o=e;return r.isSymbolicLink()&&(o=n().resolve(n().dirname(e),await (0,g.readlink)(e)),r=await (0,g.stat)(o)),{path:o,orgPath:e,name:n().basename(e),size:r.size,isFile:r.isFile(),dest:a,source:t}},c=(await Promise.all(a.map(e=>gatherInfo(e,"RatOS","RatOS")).concat(r.map(e=>gatherInfo(e,"logs","logs"))).concat(l.map(e=>gatherInfo(e,"configs","configs"))).concat(f.map(e=>gatherInfo(e,"var/log","var/log"))))).filter(e=>e.isFile);return c};async function handler(e,t){try{if("GET"===e.method){let e=await getDebugZipFiles(),a=new(l());e.map((t,r)=>{(0,f.j)().info(t,`Adding file to zip... (${e.length-(r+1)} remaining)`),a.file(n().join(t.dest,t.name),(0,c.createReadStream)(t.path))});try{return a.generateNodeStream({type:"nodebuffer",streamFiles:!0}),t.setHeader("Content-Type","application/x-zip"),t.setHeader("Content-Disposition","attachment; filename=ratos-debug.zip"),t.status(200).send(a.generateNodeStream({type:"nodebuffer",streamFiles:!0,compression:"DEFLATE"}))}catch(e){return(0,f.j)().error(e instanceof Error?e.message:"Unknown error while generating debug zip"),t.status(200).json({result:"error",data:{message:"Something went wrong, the irony.."}})}}t.status(405).json({result:"error",data:{message:"Method not allowed"}})}catch(e){return(0,f.j)().error(e instanceof Error?e.message:"Unknown error while generating debug zip"),t.status(500).json({result:"error",data:{message:"Something went wrong, the irony.."}})}}}};