exports.id=3971,exports.ids=[3971],exports.modules={26004:(e,t,r)=>{var i={"./caramba":[14158,4158],"./caramba-chonk":[89863,9863],"./caramba-chonk.ts":[89863,9863],"./caramba-hybrid":[78447,8447],"./caramba-hybrid.ts":[78447,8447],"./caramba-idex":[79173,9173],"./caramba-idex.ts":[79173,9173],"./caramba.ts":[14158,4158],"./extras/sensorless-homing":[61618,1618],"./extras/sensorless-homing.ts":[61618,1618],"./prusa-mini":[11877,1877],"./prusa-mini.ts":[11877,1877],"./prusa-mk3s":[81005,1005],"./prusa-mk3s.ts":[81005,1005],"./v-core-3":[26336,6336],"./v-core-3.ts":[26336,6336],"./v-core-pro":[62498,2498],"./v-core-pro.ts":[62498,2498],"./v-minion":[50122,122],"./v-minion.ts":[50122,122],"./voron-v01":[11287,1287],"./voron-v01.ts":[11287,1287],"./voron-v24":[84613,4613],"./voron-v24.ts":[84613,4613]};function webpackAsyncContext(e){if(!r.o(i,e))return Promise.resolve().then(()=>{var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t});var t=i[e],o=t[0];return r.e(t[1]).then(()=>r(o))}webpackAsyncContext.keys=()=>Object.keys(i),webpackAsyncContext.id=26004,e.exports=webpackAsyncContext},26079:(e,t,r)=>{Promise.resolve().then(r.bind(r,96737)),Promise.resolve().then(r.bind(r,77576))},18666:(e,t,r)=>{Promise.resolve().then(r.bind(r,96281))},83663:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,40065,23)),Promise.resolve().then(r.t.bind(r,78951,23)),Promise.resolve().then(r.t.bind(r,77813,23)),Promise.resolve().then(r.t.bind(r,73084,23)),Promise.resolve().then(r.t.bind(r,81597,23)),Promise.resolve().then(r.t.bind(r,35296,23))},96737:(e,t,r)=>{"use strict";r.r(t),r.d(t,{Redirecter:()=>Redirecter,useIsRouteActive:()=>useIsRouteActive,useLocalPathname:()=>useLocalPathname,useNavigation:()=>useNavigation});var i=r(97129),o=r(45004),n=r(3209),a=r(89105),s=r(3966);let useLocalPathname=()=>{let e=((0,a.usePathname)()??"/").replace("/configure","");return e},useIsRouteActive=()=>{let e=useLocalPathname();return(0,s.useCallback)(t=>e===t,[e])},l=[{name:"Setup Wizard",href:"/wizard",current:!1,icon:i},{name:"Dashboard",href:"/",current:!1,icon:o},{name:"Visual Calibration",href:"/calibration",current:!1,icon:n}],useNavigation=()=>{let e=useIsRouteActive();return l.map(t=>(t.current=e(t.href),t))},Redirecter=e=>{let t=(0,a.useRouter)(),r=useIsRouteActive();if(e.hasLastPrinterSettings||r("/wizard"))return e.children;t.replace("/wizard")}},96281:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>E});var i=r(28793),o=r(3966),n=r(17706),a=r(76871),s=r(50502),l=r(20259),d=r(33466),p=r(32300),c=r(78364),u=r(77913),h=r(38858),g=r(96737),_=r(23681),f=r(57748);let m={src:"/configure/_next/static/media/logo-white.6051cbc7.svg",height:443,width:1728,blurWidth:0,blurHeight:0};var b=r(30972),z=r.n(b),x=r(92515),T=r.n(x),v=r(16779),y=r(64554),P=r(47163),S=r(44592),R=r(48994);let C=[{name:"Donate",href:"https://github.com/sponsors/miklschmidt",icon:n},{name:"Documentation",href:"https://os.ratrig.com/docs/introduction",icon:n},{name:"Blog",href:"https://os.ratrig.com/blog",icon:n}],getCurrentTheme=()=>"dark",w=new S.S,E=v.SX.withTRPC(function({children:e}){let[t,r]=(0,o.useState)(null),[n,b]=(0,o.useState)(!1),x=(0,g.useNavigation)(),onThemeChange=()=>{"dark"===getCurrentTheme()?document.documentElement.classList.add("dark","scrollbar-thumb-zinc-600"):document.documentElement.classList.remove("dark","scrollbar-thumb-zinc-400")};(0,o.useEffect)(()=>{r(getCurrentTheme())},[]),(0,o.useEffect)(()=>{onThemeChange()},[t]);let setDarkMode=()=>{window.localStorage.theme="dark",r("dark")},setLightMode=()=>{window.localStorage.theme="light",r("light")};return i.jsx(R.aH,{client:w,children:i.jsx(y.RecoilRoot,{children:i.jsx(P.YG,{children:(0,i.jsxs)("div",{className:"min-h-full",children:[i.jsx(c.u.Root,{show:n,as:o.Fragment,children:(0,i.jsxs)(u.V,{as:"div",className:"relative z-50 lg:hidden",onClose:b,children:[i.jsx(c.u.Child,{as:o.Fragment,enter:"transition-opacity ease-linear duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"transition-opacity ease-linear duration-300",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:i.jsx("div",{className:"fixed inset-0 bg-zinc-900/80"})}),i.jsx("div",{className:"fixed inset-0 flex",children:i.jsx(c.u.Child,{as:o.Fragment,enter:"transition ease-in-out duration-300 transform",enterFrom:"-translate-x-full",enterTo:"translate-x-0",leave:"transition ease-in-out duration-300 transform",leaveFrom:"translate-x-0",leaveTo:"-translate-x-full",children:(0,i.jsxs)(u.V.Panel,{className:"relative mr-16 flex w-full max-w-xs flex-1",children:[i.jsx(c.u.Child,{as:o.Fragment,enter:"ease-in-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in-out duration-300",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:i.jsx("div",{className:"absolute left-full top-0 flex w-16 justify-center pt-5",children:(0,i.jsxs)("button",{type:"button",className:"-m-2.5 p-2.5",onClick:()=>b(!1),children:[i.jsx("span",{className:"sr-only",children:"Close sidebar"}),i.jsx(a,{className:"h-6 w-6 text-white","aria-hidden":"true"})]})})}),(0,i.jsxs)("div",{className:"flex grow flex-col gap-y-5 overflow-y-auto bg-zinc-900 px-6 pb-4 ring-1 ring-white/10",children:[i.jsx("div",{className:"flex h-16 shrink-0 items-center",children:i.jsx(z(),{width:160,height:40,className:"h-8 w-auto",src:m,alt:"Workflow"})}),i.jsx("nav",{className:"flex flex-1 flex-col",children:(0,i.jsxs)("ul",{role:"list",className:"flex flex-1 flex-col gap-y-7",children:[i.jsx("li",{children:i.jsx("ul",{role:"list",className:"-mx-2 space-y-1",children:x.map(e=>i.jsx("li",{children:(0,i.jsxs)(T(),{href:e.href,className:(0,_.m)(e.current?"bg-zinc-800 text-white":"text-zinc-400 hover:bg-zinc-800 hover:text-white","group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"),children:[i.jsx(e.icon,{className:(0,f.d)("h-6 w-6 shrink-0",e.iconClass),"aria-hidden":"true"}),e.name]})},e.name))})}),i.jsx("li",{className:"mt-auto",children:(0,i.jsxs)("a",{href:"/",className:"group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-zinc-400 hover:bg-zinc-800 hover:text-white",children:[i.jsx(s,{className:"h-6 w-6 shrink-0","aria-hidden":"true"}),"Mainsail"]})})]})})]})]})})})]})}),i.jsx("div",{className:"lg:z-1 hidden lg:fixed lg:inset-y-0 lg:flex lg:w-72 lg:flex-col",children:(0,i.jsxs)("div",{className:"flex grow flex-col gap-y-5 overflow-y-auto bg-zinc-900 px-6 pb-4",children:[i.jsx("div",{className:"flex h-16 shrink-0 items-center",children:i.jsx(z(),{width:160,height:40,className:"h-8 w-auto",src:m,alt:"Workflow"})}),i.jsx("nav",{className:"flex flex-1 flex-col",children:(0,i.jsxs)("ul",{role:"list",className:"flex flex-1 flex-col gap-y-7",children:[i.jsx("li",{children:i.jsx("ul",{role:"list",className:"-mx-2 space-y-1",children:x.map(e=>i.jsx("li",{children:(0,i.jsxs)(T(),{href:e.href,className:(0,_.m)(e.current?"bg-zinc-800 text-white":"text-zinc-400 hover:bg-zinc-800 hover:text-white","group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"),children:[i.jsx(e.icon,{className:(0,f.d)("h-6 w-6 shrink-0",e.iconClass),"aria-hidden":"true"}),e.name]})},e.name))})}),(0,i.jsxs)("li",{children:[i.jsx("div",{className:"text-xs font-semibold leading-6 text-zinc-400",children:"External Links"}),i.jsx("ul",{role:"list",className:"-mx-2 mt-2 space-y-1",children:C.map(e=>i.jsx("li",{children:(0,i.jsxs)("a",{href:e.href,target:"_blank",className:(0,f.d)("text-zinc-400 hover:bg-zinc-800 hover:text-white","group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6"),children:[i.jsx("span",{className:"flex h-6 w-6 shrink-0 items-center justify-center rounded-lg border border-zinc-700 bg-zinc-800 text-[0.625rem] font-medium text-zinc-400 group-hover:text-white",children:i.jsx(e.icon,{className:"h-4 w-4","aria-hidden":"true"})}),i.jsx("span",{className:"truncate",children:e.name})]})},e.name))})]}),i.jsx("li",{className:"mt-auto",children:(0,i.jsxs)("a",{href:"/",className:"group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-zinc-400 hover:bg-zinc-800 hover:text-white",children:[i.jsx(s,{className:"h-6 w-6 shrink-0","aria-hidden":"true"}),"Mainsail"]})})]})})]})}),i.jsx(h.p,{as:"nav",className:"bg-zinc-900 lg:ml-72",children:({open:e})=>(0,i.jsxs)(i.Fragment,{children:[i.jsx("div",{className:"mx-auto max-w-7xl sm:px-6",children:i.jsx("div",{className:"",children:(0,i.jsxs)("div",{className:"flex h-16 items-center justify-between px-4 sm:px-0",children:[i.jsx("div",{className:"-mr-2 flex lg:hidden",children:(0,i.jsxs)(h.p.Button,{className:"inline-flex items-center justify-center rounded-md bg-zinc-800 p-2 text-zinc-400 hover:bg-zinc-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-zinc-800",children:[i.jsx("span",{className:"sr-only",children:"Open main menu"}),e?i.jsx(a,{className:"block h-6 w-6","aria-hidden":"true"}):i.jsx(l,{className:"block h-6 w-6","aria-hidden":"true"})]})}),i.jsx("div",{className:"hidden lg:flex"}),(0,i.jsxs)("div",{className:"hidden items-center justify-between space-x-2 sm:flex",children:[i.jsx("a",{href:"https://github.com/sponsors/miklschmidt",target:"_blank",rel:"noreferrer",className:"inline-flex items-center justify-center rounded-md border border-transparent bg-zinc-300 px-4 py-2 text-sm font-medium text-black shadow-sm hover:bg-zinc-400 focus:outline-none",children:"Donate"}),i.jsx("a",{href:"https://os.ratrig.com/docs/introduction",target:"_blank",rel:"noreferrer",className:"inline-flex items-center justify-center rounded-md border border-transparent bg-transparent px-4 py-2 text-sm font-medium text-zinc-300 shadow-sm hover:bg-zinc-700 hover:text-white focus:outline-none",children:"Documentation"}),"light"===t?i.jsx(d,{className:"h-9 w-9 cursor-pointer rounded-md px-2 py-2 text-zinc-300 hover:bg-zinc-700 hover:text-brand-500",onClick:setDarkMode}):i.jsx(p,{className:"h-9 w-9 cursor-pointer rounded-md px-2 py-2 text-zinc-300 hover:bg-zinc-700 hover:text-brand-500",onClick:setLightMode})]})]})})}),i.jsx(h.p.Panel,{className:"lg:hidden",children:(0,i.jsxs)("div",{className:"space-y-1 pb-3 pt-2",children:[x.map(e=>i.jsx(h.p.Button,{as:"a",href:e.href,className:(0,_.m)(e.current?"bg-brand-50 border-brand-500 text-brand-500":"border-transparent text-zinc-300 hover:border-zinc-600 hover:bg-zinc-700 hover:text-zinc-100","block border-l-4 py-2 pl-3 pr-4 text-base font-medium"),"aria-current":e.current?"page":void 0,children:e.name},e.name)),i.jsx(h.p.Button,{as:"a",href:"https://github.com/sponsors/miklschmidt",className:"block border-l-4 border-transparent py-2 pl-3 pr-4 text-base font-medium text-zinc-300 hover:border-zinc-600 hover:bg-zinc-700 hover:text-zinc-100",children:"Donate"}),i.jsx(h.p.Button,{as:"a",href:"https://os.ratrig.com/docs/introduction",className:"block border-l-4 border-transparent py-2 pl-3 pr-4 text-base font-medium text-zinc-300 hover:border-zinc-600 hover:bg-zinc-700 hover:text-zinc-100",children:"Documentation"})]})})]})}),i.jsx("div",{className:"lg:ml-72",children:e})]})})})})})},47163:(e,t,r)=>{"use strict";r.d(t,{YG:()=>SyncWithMoonraker,rR:()=>moonrakerWriteEffect});var i=r(28793),o=r(3966),n=r(28874),a=r(89255),s=r(64554);let l=new EventTarget,DispatchSaveAtomEvent=(e,t)=>{l.dispatchEvent(new CustomEvent("saveAtom",{detail:{itemKey:e,value:t}}))},moonrakerWriteEffect=()=>e=>{e.onSet(t=>{console.debug(`RatOS Atom Sync Effect: new value was saved to moonraker "${e.trigger}"`,e.node.key,t),DispatchSaveAtomEvent(e.node.key,null==t?"null":t)})},SyncWithMoonraker=({children:e})=>{let t=(0,n.oK)(),r=(0,o.useCallback)(async e=>{let r=await t.getItem("RatOS",e);return null!=r&&"null"!=r?r:new s.DefaultValue},[t]),d=(0,o.useCallback)(async e=>{let{itemKey:r,value:i}=e.detail;await t.saveItem("RatOS",r,i)},[t]);return(0,o.useEffect)(()=>(l.addEventListener("saveAtom",d),()=>{l.removeEventListener("saveAtom",d)}),[d]),i.jsx(a.J1,{read:r,children:e})}},63469:(e,t,r)=>{"use strict";r.d(t,{N:()=>n});var i=r(13728),o=r(83908);let n=i.z.array(o.HB).parse([{id:"BTT-TMC2209-13",title:"BTT TMC2209 v1.3",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"BTT-TMC2226-10",title:"BTT TMC2226 v1.0",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"BTT-TMC5160-PRO-11",title:"BTT TMC5160(T) Pro v1.1",type:"TMC5160",protocol:"SPI",senseResistor:.075,voltages:[24,36,48,56],maxCurrent:3,coolingCurrentThreshold:1.5},{id:"BTT-TMC5160T-PLUS-10",title:"BTT TMC5160T Plus v1.0",type:"TMC5160",protocol:"SPI",senseResistor:.022,voltages:[24,36,48,56,60],maxCurrent:10.6,coolingCurrentThreshold:3,external:!0},{id:"BTT-EZ2209",title:"BTT EZ2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.3,voltages:[24],maxCurrent:2},{id:"BTT-EZ2226",title:"BTT EZ2226",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.3,voltages:[24],maxCurrent:2},{id:"BTT-EZ2130",title:"BTT EZ2130",type:"TMC2130",protocol:"SPI",senseResistor:.11,coolingCurrentThreshold:.9,voltages:[24],maxCurrent:2},{id:"BTT-EZ5160-PRO",title:"BTT EZ5160 Pro",type:"TMC5160",protocol:"SPI",senseResistor:.075,coolingCurrentThreshold:1.6,voltages:[24,36,48],maxCurrent:2.5},{id:"BTT-EZ5160-RGB",title:"BTT EZ5160 RGB",type:"TMC5160",protocol:"SPI",senseResistor:.05,coolingCurrentThreshold:3,voltages:[24,48,36,56],maxCurrent:4.7},{id:"MELLOW-FLY-HV-TMC5160-PRO-12",title:"Mellow FLY HV TMC5160 Pro v1.2",type:"TMC5160",protocol:"SPI",senseResistor:.033,coolingCurrentThreshold:3,voltages:[24,36,48],maxCurrent:4.25,external:!0},{id:"MELLOW-FLY-TMC2209",title:"Mellow FLY TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"PRUSA-EINSY-RAMBO-TMC2130",title:"Prusa Einsy Rambo TMC2130",type:"TMC2130",protocol:"SPI",senseResistor:.22,coolingCurrentThreshold:.9,voltages:[24],maxCurrent:2},{id:"PRUSA-BUDDY-TMC2209",title:"Prusa Buddy TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2}])},23036:(e,t,r)=>{"use strict";r.d(t,{Yo:()=>hotendFanOptions,gL:()=>partFanOptions,z2:()=>o});var i=r(83908);let partFanOptions=(e,t)=>{let r=[];return(null==t||t?.axis===i.po.x||t?.axis===null)&&(r.push({id:"2pin",title:"2-pin fan"}),r.push({id:"4pin",title:"4-pin fan"})),e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated",title:"4-pin fan (dedicated 4-pin header)"}),t?.toolboard!=null&&(r.push({id:"2pin-toolboard",title:"2-pin toolboard fan"}),r.push({id:"4pin-toolboard",title:"4-pin toolboard fan"}),t?.toolboard.fourPinFanConnectorCount!=null&&t.toolboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated-toolboard",title:"4-pin fan (dedicated 4-pin header on toolboard)"})),r},hotendFanOptions=(e,t)=>{let r=[];return(null==t||t?.axis===i.po.x)&&(r.push({id:"2pin",title:"2-pin fan"}),r.push({id:"4pin",title:"4-pin fan"})),(e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>2||e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>1&&e.controllerFan?.id!=="4pin-dedicated")&&r.push({id:"4pin-dedicated",title:"4-pin fan (dedicated 4-pin header)"}),t?.toolboard!=null&&(r.push({id:"2pin-toolboard",title:"2-pin toolboard fan"}),r.push({id:"4pin-toolboard",title:"4-pin toolboard fan"}),t?.toolboard.fourPinFanConnectorCount!=null&&t.toolboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated-toolboard",title:"4-pin fan (dedicated 4-pin header on toolboard)"})),r},o={id:"2pin",title:"2-pin fan"}},28409:(e,t,r)=>{"use strict";r.d(t,{S:()=>getDefaultNozzle});let getDefaultNozzle=()=>({diameter:.4,type:"Regular"})},15896:(e,t,r)=>{"use strict";r.d(t,{B:()=>n,a:()=>findPreset});var i=r(13728),o=r(83908);let findPreset=(e,t,r,i,o)=>e.presets?.slice().sort((e,t)=>o?t.run_current-e.run_current:e.run_current-t.run_current).find(e=>e.driver===t.type&&e.voltage===r&&e.sense_resistor===t.senseResistor&&(null==i||e.run_current===i)),n=i.z.array(o.vF).parse([{id:"generic",title:"Generic Stepper",maxPeakCurrent:2.8},{id:"BONDTECH-42H025H-0704-002",title:"Bondtech LGX Stepper",maxPeakCurrent:.7},{id:"LDO-42STH48-2504AC",title:"LDO-42STH48-2504AC",maxPeakCurrent:2.5,presets:[{run_current:1.1,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:1,driver_TOFF:3,driver_HEND:0,driver_HSTRT:0},{run_current:1.6,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:2,driver_TOFF:3,driver_HEND:0,driver_HSTRT:6},{run_current:1.6,voltage:24,driver:"TMC5160",sense_resistor:.075,driver_TBL:2,driver_TOFF:3,driver_HEND:0,driver_HSTRT:6},{run_current:1.768,voltage:48,driver:"TMC5160",sense_resistor:.075,driver_TBL:0,driver_TOFF:4,driver_HEND:0,driver_HSTRT:4}]},{id:"LDO-42STH40-1684AC",title:"LDO-42STH40-1684AC",maxPeakCurrent:1.68,presets:[{run_current:.4,voltage:24,driver:"TMC2130",sense_resistor:.22,driver_IHOLDDELAY:8,driver_TPOWERDOWN:0,driver_TBL:2,driver_TOFF:3,driver_HEND:1,driver_HSTRT:5,driver_PWM_FREQ:2,driver_PWM_GRAD:2,driver_PWM_AMPL:230,driver_PWM_AUTOSCALE:!0,driver_SGT:5},{run_current:.52,voltage:24,driver:"TMC2130",sense_resistor:.22,driver_IHOLDDELAY:8,driver_TPOWERDOWN:0,driver_TBL:2,driver_TOFF:3,driver_HEND:1,driver_HSTRT:5,driver_PWM_FREQ:2,driver_PWM_GRAD:4,driver_PWM_AMPL:240,driver_PWM_AUTOSCALE:!0,driver_SGT:3},{run_current:.8,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:1,driver_TOFF:3,driver_HEND:3,driver_HSTRT:0},{run_current:1.188,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:0,driver_TOFF:3,driver_HEND:0,driver_HSTRT:0}]},{id:"LDO-42STH48-2004MAH",title:"LDO-42STH48-2004MAH",maxPeakCurrent:2,fullStepsPerRotation:400},{id:"LDO-42STH48-2004AC",title:"LDO-42STH48-2004AC",maxPeakCurrent:2},{id:"LDO-42STH25-1404MAC",title:"LDO-42STH25-1404MAC",maxPeakCurrent:1.4,fullStepsPerRotation:400,presets:[{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:.85,driver_TBL:1,driver_TOFF:3,driver_HEND:2,driver_HSTRT:0}]},{id:"LDO-42STH25-1004CL200E",title:"LDO-42STH25-1004CL200E",maxPeakCurrent:1},{id:"LDO-36STH20-1004AHG",title:"LDO-36STH20-1004AHG",maxPeakCurrent:1,presets:[{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:.707,driver_TBL:0,driver_HEND:6,driver_HSTRT:7,driver_TOFF:4}]},{id:"LDO-36STH17-1004AHG",title:"LDO-36STH17-1004AHG",maxPeakCurrent:1},{id:"LDO-35STH48-1684AH",title:"LDO-35STH48-1684AH",maxPeakCurrent:1.68}])},58307:(e,t,r)=>{"use strict";r.d(t,{D:()=>ToolheadHelper});var i=r(50294),o=r(83908),n=r(32327),a=r(28409),s=r(32012),l=r.n(s);let ToolheadHelper=class ToolheadHelper{constructor(e){this.config=e}hasToolboard(){return null!=this.config.toolboard}getToolboard(){return this.config.toolboard}getMotionStepperName(){return this.config.axis===o.po.dual_carriage?"dual_carriage":`stepper_${this.getMotionAxis()}`}getToolboardName(){if(null==this.config.toolboard)throw Error(`Toolhead T${this.getTool()} does not have a toolboard`);return`toolboard_${this.getShortToolName()}`}getShortToolName(){return`t${this.getTool()}`}getDescription(){return this.config.description??"the printer's toolhead"}getMotionAxis(){return this.config.axis===o.po.dual_carriage?o.po.dual_carriage:o.po.x}getExtruderAxis(){return this.config.axis===o.po.dual_carriage?o.po.extruder1:o.po.extruder}getToolCommand(){return`T${this.getTool()}`}getTool(){return this.config.axis===o.po.dual_carriage?1:0}getSerialSuffix(){return`t${this.getTool()}`}getExtruder(){return this.config.extruder}getHotend(){return this.config.hotend}getNozzle(){return this.config.nozzle??(0,a.S)()}getThermistor(){return this.config.thermistor}getXEndstop(){return this.config.xEndstop}getYEndstop(){return this.config.yEndstop}getXAccelerometer(){return this.config.xAccelerometer}getYAccelerometer(){return this.config.yAccelerometer}getXAccelerometerName(){switch(this.getXAccelerometer()?.id){case"controlboard":return"controlboard";case"toolboard":if(this.hasToolboard())return this.getToolboardName();case"sbc":return"rpi";default:return"controlboard"}}getYAccelerometerName(){switch(this.getYAccelerometer()?.id){case"controlboard":return"controlboard";case"toolboard":if(this.hasToolboard())return this.getToolboardName();case"sbc":return"rpi";default:return"controlboard"}}getChangeSet(e){if(null==e)return null;let t={};Object.keys(e).forEach(r=>{let i=this.getConfig()[r],o=e[r];if(null!=i&&null==o||null==i&&null!=o){t[r]=o;return}i&&o&&("object"==typeof i&&"id"in i&&"object"==typeof o&&"id"in o?i.id!==o.id&&(t[r]=o):l()(i,o)||(t[r]=o))});let r=n.b2.safeParse(t);return r}getProbe(){return this.config.probe}getPartFan(){return this.config.partFan}getHotendFan(){return this.config.hotendFan}serialize(){return(0,i.m6)(this.config)}getConfig(){return{...this.config}}}},59983:(e,t,r)=>{"use strict";r.d(t,{S:()=>i.SX,u:()=>i.uF});var i=r(16779)},24874:(e,t,r)=>{"use strict";r.d(t,{X:()=>getHost});let getHost=()=>""!="".trim()?"":null},77576:(e,t,r)=>{"use strict";r.r(t),r.d(t,{ControllerFanState:()=>b,LoadablePrinterConfigurationState:()=>x,PerformanceModeState:()=>_,PrinterConfigurationState:()=>z,StandstillStealthState:()=>m,StealthchopState:()=>f,serializePartialPrinterConfiguration:()=>serializePartialPrinterConfiguration,serializePrinterConfiguration:()=>serializePrinterConfiguration,usePrinterConfiguration:()=>usePrinterConfiguration,useSerializedPrinterConfiguration:()=>useSerializedPrinterConfiguration});var i=r(64554),o=r(13728),n=r(34637),a=r(86982),s=r(89255),l=r(77654),d=r(3966),p=r(50294),c=r(5951),u=r(26596),h=r(23036),g=r(47163);let _=(0,i.atom)({key:"PerformanceMode",default:!1,effects:[(0,g.rR)(),(0,s.ok)({refine:(0,l.getRefineCheckerForZodSchema)(o.z.boolean().optional().nullable())})]}),f=(0,i.atom)({key:"Stealchop",default:!1,effects:[(0,g.rR)(),(0,s.ok)({refine:(0,l.getRefineCheckerForZodSchema)(o.z.boolean().optional().nullable())})]}),m=(0,i.atom)({key:"StandstillStealth",default:!1,effects:[(0,g.rR)(),(0,s.ok)({refine:(0,l.getRefineCheckerForZodSchema)(o.z.boolean().optional().nullable())})]}),b=(0,i.atom)({key:"ControllerFan",default:h.z2,effects:[(0,g.rR)(),(0,s.ok)({refine:(0,l.getRefineCheckerForZodSchema)(n.XG.nullable())})]}),z=(0,i.selector)({key:"PrinterConfiguration",get:async({get:e})=>{let{printer:t,printerSize:r,performanceMode:o,stealthchop:n,standstillStealth:s,rails:l,controlboard:d,controllerFan:h,toolheads:g}=e((0,i.waitForAll)({printer:c.H6,printerSize:c.hq,performanceMode:_,stealthchop:f,standstillStealth:m,rails:c.q7,controlboard:c.OS,controllerFan:b,toolheads:u.$T})),z=a.jz.safeParse({printer:null==t?null:{...t,defaults:{...t.defaults,toolheads:t?.defaults.toolheads.map(e=>p.m6(e))}},size:r,performanceMode:o,stealthchop:n,standstillStealth:s,rails:l,controlboard:d,controllerFan:h,toolheads:g});return!1===z.success&&console.error(z.error.flatten().fieldErrors),z.success?z.data:null}}),x=(0,i.selector)({key:"LoadablePrinterConfigurationState",get:async({get:e})=>{let t=e((0,i.noWait)(z));return({hasValue:()=>t.contents,hasError:()=>null,loading:()=>null})[t.state]()}}),serializePrinterConfiguration=e=>{let t={printer:e.printer.id,toolheads:e.toolheads.map(e=>(0,p.m6)(e)),size:e.size,controlboard:e.controlboard.id,controllerFan:e.controllerFan.id,performanceMode:e.performanceMode,stealthchop:e.stealthchop,standstillStealth:e.standstillStealth,rails:e.rails.map(e=>(0,p.Yz)(e))};return a.q_.parse(t)},serializePartialPrinterConfiguration=e=>{let t=e?.toolheads?.map(e=>p.od(e)),r={printer:e?.printer?.id,toolheads:t,size:e?.size,controlboard:e?.controlboard?.id,controllerFan:e?.controllerFan?.id,performanceMode:e?.performanceMode,stealthchop:e?.stealthchop,standstillStealth:e?.standstillStealth};return a.NN.parse(r)},useSerializedPrinterConfiguration=()=>{let e=(0,i.useRecoilValue)(z),t=(0,d.useMemo)(()=>serializePartialPrinterConfiguration(e??{}),[e]);return t},usePrinterConfiguration=()=>{let[e,t]=(0,i.useRecoilState)(c.H6),[r,o]=(0,i.useRecoilState)(c.hq),[n,s]=(0,i.useRecoilState)(c.OS),[l,d]=(0,i.useRecoilState)(_),[p,u]=(0,i.useRecoilState)(f),[h,g]=(0,i.useRecoilState)(m),[x,T]=(0,i.useRecoilState)(b),v=(0,i.useRecoilValue)(c.q7),y=(0,i.useRecoilValue)(z),P=useSerializedPrinterConfiguration(),S=a.dl.safeParse(y);return{selectedPrinter:e,setSelectedPrinter:t,selectedPrinterOption:r,setSelectedPrinterOption:o,selectedBoard:n,setSelectedBoard:s,performanceMode:l,setPerformanceMode:d,stealthchop:p,setStealthchop:u,standstillStealth:h,setStandstillStealth:g,selectedPrinterRails:v,selectedControllerFan:x,setSelectedControllerFan:T,partialPrinterConfiguration:y,serializedPrinterConfiguration:P,parsedPrinterConfiguration:S}}},28874:(e,t,r)=>{"use strict";r.d(t,{oK:()=>useMoonraker,xH:()=>useMoonrakerMutation,DS:()=>useMoonrakerQuery,Fu:()=>useMoonrakerState,A4:()=>useNamespacedItemQuery,hS:()=>usePrinterObjectQuery,Q:()=>usePrinterObjectSubscription});var i=r(3966),o=r(97972),n=r(27651),a=r(45184),s=r(24874);let l=[{version:1,description:"Undo double JSON encoding of RatOS's data",up:async()=>{let e=await window.fetch(`http://${(0,s.X)()}/server/database/item?namespace=RatOS`);if(!e.ok)return{result:"Nothing to migrate"};{let t=await e.json();if("error"in t)throw Error(t.error.message);let r=[];if(null==t.result.value)return{result:"Nothing to migrate"};for await(let[e,r]of Object.entries(t.result.value))try{let t=JSON.parse(r);console.log("Migrating",e,"from",r,"to",t),await window.fetch(`http://${(0,s.X)()}/server/database/item`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})})}catch(t){console.error("Error migrating",e,r,"clearing key"),await window.fetch(`http://${(0,s.X)()}/server/database/item?namespace=RatOS&key=${encodeURIComponent(e)}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e})});continue}return{result:`Succesfully decoded ${r.length} keys.
${r.join("\n")}`}}},down:async()=>{let e=await window.fetch(`http://${(0,s.X)()}/server/database/item?namespace=RatOS`);if(e.ok){let t=await e.json();if("error"in t)throw Error(t.error.message);if(null==t.result.value)return{result:"Nothing to migrate"};let r=[];for await(let[e,i]of Object.entries(t.result.value)){let t=JSON.stringify(i);await window.fetch(`http://${(0,s.X)()}/server/database/item`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:e,value:t})}),r.push(`Re-encoded ${e}`)}return{result:`Succesfully re-encoded ${r.length} keys.
${r.join("\n")}`}}return{result:"Nothing to migrate"}}}],getCurrentVersion=async()=>{let e=await window.fetch(`http://${(0,s.X)()}/server/database/item?namespace=RatOS&key=__db_version`);if(e.ok){let t=await e.json();return"error"in t?0:t.result.value}return 0},setCurrentVersion=async e=>{await window.fetch(`http://${(0,s.X)()}/server/database/item`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({namespace:"RatOS",key:"__db_version",value:e})})},d=!1,migrate=async(e,t)=>{if(d)return console.log("Already migrating, ignoring..");if(e===t)return console.log("Already at target version");d=!0;try{let r=l.filter(r=>r.version>=e&&r.version<=t).sort((r,i)=>e<=t?r.version-i.version:i.version-r.version);for await(let i of r){let r=await (e<t?i.up():i.down());console.log(`Migrated to version ${i.version}: ${r.result}`)}await setCurrentVersion(t)}finally{d=!1}},p=!1,migrateToLatest=async()=>{if(p)return console.log("Already migrated, ignoring..");let e=await getCurrentVersion(),t=Math.max(...l.map(e=>e.version));if(e===t){console.log("Already at latest version");return}if(d){console.log("Already migrating, ignoring..");return}console.log("Migrating to latest version...",e,t),await migrate(e,t),p=!0,console.log("Migration complete.")};var c=r(73992),u=r(32012),h=r.n(u);let g=0,getWsURL=()=>{let e=(0,s.X)();return null==e||""==e.trim()?null:`ws://${e}/websocket`},_={},useMoonraker=e=>{let t=(0,i.useRef)({}),r=(0,i.useRef)({}),o=(0,i.useRef)([]),n=(0,i.useRef)([]),[s,l]=(0,i.useState)(getWsURL());(0,i.useEffect)(()=>{l(getWsURL())},[]);let d=(0,i.useCallback)(e=>{if("notify_status_update"===e.method&&null!=e.params){let t=e.params[0];if(null!=t)for(let e of o.current){let r=_[e];if(null!=r){for(let e in r)if(null!=t[e])return!0}}}return!1},[]),{lastJsonMessage:p,sendJsonMessage:c,readyState:u}=(0,a.ZP)(s,{filter:e=>{if("connected"!==f)return!0;try{let r=JSON.parse(e.data);if(null!=t.current[r.id])return!0}catch(t){console.warn("Filter: Failed to parse message",t,e.data)}return!1},onMessage:t=>{if(e?.onStatusUpdate)try{let r=JSON.parse(t.data);if(d(r)){let t=r.params[0];e.onStatusUpdate?.(t)}}catch(e){console.warn("OnMessage: Failed to parse message",e,t.data)}},shouldReconnect:e=>!0,reconnectAttempts:1/0,reconnectInterval:3e3,share:!0}),h=(0,i.useRef)(u);h.current=u;let[f,m]=(0,i.useState)(1===u?"connected":"connecting"),b=(0,i.useCallback)((e,t)=>{1===h.current?e():n.current.push({resolve:e,reject:t})},[]),z=(0,i.useCallback)(()=>new Promise((e,t)=>{b(e,t)}),[b]),x=(0,i.useCallback)(async(e,i={})=>{let o=++g;return await z(),new Promise((n,a)=>{t.current[o]=(e,t)=>e?a(e):t?.error?a(t.error):void n(t);let s=1e4;"printer.gcode.script"===e&&(s=6e4),r.current[o]=window.setTimeout(()=>{t.current[o]?.(Error("Request timed out"),null),delete t.current[o],delete r.current[o]},s),c({jsonrpc:"2.0",method:e,params:i,id:o})})},[z,c]),T=(0,i.useCallback)(async(...e)=>{let t=Object.fromEntries(e.map(e=>[e,null])),r=Object.assign({},t,...Object.values(_).filter(e=>null!=e)),i=x("printer.objects.subscribe",{objects:r}),n=g;_[n]=t,o.current.push(n);let a=(await i).status;return{res:a,unsuscribe:async()=>{if(o.current=o.current.filter(e=>e!==n),null==_[n]){delete _[n];let e=Object.assign({},...Object.values(_).filter(e=>null!=e));await x("printer.objects.subscribe",{objects:e})}}}},[x]),v=(0,i.useCallback)(async(e,t,r)=>(await z(),await x("server.database.post_item",{namespace:e,key:t,value:r})),[x,z]),y=(0,i.useCallback)(async(e,t)=>{await z();try{let r=await x("server.database.get_item",{namespace:e,key:t});return r?.value??null}catch(e){return console.log(e),null}},[x,z]);return(0,i.useEffect)(()=>{1===u?(async()=>{await migrateToLatest(),n.current.forEach(e=>e.resolve()),n.current=[],m("connected")})():m("connecting")},[u]),(0,i.useEffect)(()=>{p?.id&&t.current[p.id]&&(window.clearTimeout(r.current[p.id]),t.current[p.id](null,p.result),delete r.current[p.id],delete t.current[p.id])},[p]),(0,i.useEffect)(()=>()=>{for(let e in r.current)delete r.current[e],delete t.current[e];if(o.current.length>0){o.current.forEach(e=>{delete _[e]}),o.current=[];let e=Object.assign({},...Object.values(_).filter(e=>null!=e));x("printer.objects.subscribe",{objects:Object.keys(e).length>0?e:null}).catch(e=>{})}n.current.forEach(e=>e.reject()),n.current=[]},[]),{query:x,saveItem:v,getItem:y,subscribeToObject:T,status:f,lastMessage:p,isReady:1===u}},useNamespacedItemQuery=(e,t,r)=>{let{getItem:i}=useMoonraker();return(0,o.a)({...r,queryKey:[e,t],queryFn:async()=>i(e,t)})},useMoonrakerQuery=(...e)=>{let{query:t}=useMoonraker(),r=3===e.length?e[2]:e[1],i=3===e.length?e[1]:void 0,n=e[0],a=3===e.length?[n,i]:[n];return(0,o.a)({...r??{},queryKey:[e[0]],queryFn:async()=>t(...a)})},useMoonrakerMutation=(...e)=>{let{query:t}=useMoonraker(),r=e[1],i=e[0];return(0,n.D)({...r,mutationKey:[e[0]],mutationFn:async e=>{let r=e?[i,e]:[i];return t(...r)}})},usePrinterObjectQuery=(...e)=>{let{query:t}=useMoonraker();return(0,o.a)({queryKey:e,queryFn:async()=>{let r=Object.fromEntries(e.map(e=>[e,null]));return(await t("printer.objects.query",{objects:r})).status}})},usePrinterObjectSubscription=(e,...t)=>{let[r,o]=(0,i.useState)(null),n=(0,i.useRef)(r);n.current=r;let a=(0,i.useRef)(e);a.current=e;let s=(0,i.useCallback)(e=>null==a.current?e:a.current?.(e),[]),l=(0,i.useMemo)(()=>Object.fromEntries(t.map(e=>[e,null])),[JSON.stringify(t.sort())]),{subscribeToObject:d}=useMoonraker({onStatusUpdate:(0,i.useCallback)(e=>{let t={};for(let r in l)null!=e[r]&&(t[r]=e[r]);let r=s(t);if(null==r||"object"!=typeof r)throw Error("Invalid selection function, must return object, got "+typeof r);Object.keys(t).length>0&&!1===h()(r,n.current)&&o(e=>(0,c.T)(e??{},r))},[s,l])});return(0,i.useEffect)(()=>{let e=d(...Object.keys(l));return e.then(e=>{o(s(e.res))}).catch(e=>{e instanceof Error&&console.error(e)}),()=>{e.then(e=>e.unsuscribe()).catch(e=>{e instanceof Error&&console.error(e)})}},[s,l,d]),r},useNamespacedItemMutation=(e,t,r)=>{let{saveItem:i}=useMoonraker();return(0,n.D)({...r,mutationKey:[e,t],mutationFn:r=>i(e,t,r)})},useMoonrakerState=(e,t,r=null)=>{let o=useNamespacedItemQuery(e,t,{initialData:r}),n=useNamespacedItemMutation(e,t),a=(0,i.useCallback)(async e=>{let t="function"==typeof e?e(o.data??r):e;await n.mutateAsync(t,{onSuccess:()=>{o.refetch()}})},[r,n,o]);return[o.data??r,a,o,n]}},5951:(e,t,r)=>{"use strict";r.d(t,{H6:()=>_,OS:()=>b,Xu:()=>f,ew:()=>z,hq:()=>m,q7:()=>x});var i=r(89255),o=r(53107),n=r(59983),a=r(64554),s=r(13728),l=r(77654),d=r(50294),p=r(83908),c=r(32719),u=r(47163),h=r(86982);let g={},readPrinterAtom=async({read:e})=>{let t=await e(_.key);if(null!=t){let e=s.z.object({id:o.Ox.shape.id}).safeParse(t);if(e.success){let t=g[e.data.id];return null==t&&(t=await n.u.printer.printer.query(e.data.id,{}))&&(g[e.data.id]=t),t??null}}return null},readPrinterRailAtom=e=>async({read:t})=>{let r=await t(z(e).key);if(null!=r){let i=p.Ah.safeParse(r);if(i.success)return i.data;let o=await readPrinterAtom({read:t}),n=o?.defaults.rails.find(t=>t.axis===e);if(null!=n){let e=p.Ah.safeParse({...n,...r});if(e.success)return e.data}}return null},_=(0,a.atom)({key:"Printer",default:null,effects:[(0,u.rR)(),(0,i.ok)({read:readPrinterAtom,write:async({write:e},t)=>{await new Promise(r=>{t instanceof a.DefaultValue?e(_.key,null):e(_.key,t??null),setTimeout(()=>{},500)})},refine:(0,l.getRefineCheckerForZodSchema)(o.Ox.nullable())})]}),f=(0,a.selector)({key:"LoadablePrinterState",get:async({get:e})=>{let t=e((0,a.noWait)(_));return({hasValue:()=>t.contents,hasError:()=>[],loading:()=>[]})[t.state]()}}),m=(0,a.atom)({key:"PrinterOption",default:null,effects:[(0,u.rR)(),(0,i.ok)({refine:(0,l.getRefineCheckerForZodSchema)(h.LN.nullable())})]}),b=(0,a.atom)({key:"Controlboard",default:null,effects:[(0,u.rR)(),(0,i.ok)({read:async({read:e})=>{let t=await e(b.key);if(null!=t){let e=s.z.object({path:c.Ui}).safeParse(t);if(e.success){let t=await n.u.mcu.boards.query({boardFilters:{toolboard:!1}}),r=t.find(t=>t.path===e.data.path);return r??null}}return null},refine:(0,l.getRefineCheckerForZodSchema)(c.$l.nullable())})]}),z=(0,a.atomFamily)({key:"PrinterRail",default:null,effects:e=>[(0,u.rR)(),(0,i.ok)({read:readPrinterRailAtom(e),refine:(0,l.getRefineCheckerForZodSchema)(p.Ah.nullable())})]}),x=(0,a.selector)({key:"PrinterRails",get:({get:e})=>{let t=e(_),r=t?.defaults.rails.map(t=>{let r=e(z(t.axis));return d.Ak(r??t)});return r??[]},set:({set:e},t)=>{if(t instanceof a.DefaultValue){Object.values(p.po).forEach(t=>{e(z(t),null)});return}t.forEach(t=>{e(z(t.axis),(0,d.Yz)(t))})}});(0,a.selector)({key:"LoadablePrinterRailsState",get:async({get:e})=>{let t=e((0,a.noWait)(x));return({hasValue:()=>t.contents,hasError:()=>[],loading:()=>[]})[t.state]()}})},26596:(e,t,r)=>{"use strict";r.d(t,{$T:()=>h,AF:()=>u,wm:()=>g});var i=r(64554),o=r(89255),n=r(13728),a=r(77654),s=r(59983),l=r(32719);r(83908);var d=r(32327),p=r(5951),c=r(47163);let u=(0,i.atomFamily)({key:"PrinterToolhead",default:null,effects:e=>[(0,c.rR)(),(0,o.ok)({read:async({read:t})=>{let r=await t(u(e).key);if("object"!=typeof r||null==r)return null;let{toolNumber:i,...o}=r;if(null!=o){let t=d.x8.safeParse(o);if(t.success){let r=t.data.toolboard;if(r&&null!=r){let e=n.z.object({path:l.Ui}).safeParse(r);if(e.success){let t=await s.u.mcu.boards.query({boardFilters:{toolboard:!0}}),i=t.find(t=>t.path===e.data.path);i&&(r=l.MG.parse(i))}}return{...t.data,toolboard:r,toolNumber:e}}console.debug("RecoilSync: failed to read toolhead!",u(e).key,t.error,o)}return null},refine:(0,a.getRefineCheckerForZodSchema)(d.PY.extend({toolNumber:d.Qr}).nullable())})]});(0,i.selectorFamily)({key:"DeserializeToolheadQuery",get:e=>async({get:t})=>{let r=d.x8.safeParse(await s.u.printer.deserializeToolheadConfiguration.query({config:e.th,printerConfig:{controlboard:e.boardId}}));return r.success?{...r.data,toolNumber:e.toolNumber}:null}});let h=(0,i.selector)({key:"PrinterToolheadsState",get:({get:e})=>{let t=e(p.H6);return null==t?[]:e((0,i.waitForAll)(t.defaults.toolheads.map((e,t)=>u(t)))).filter(Boolean)},set:({set:e,reset:t},r)=>{if(r instanceof i.DefaultValue)throw Error("ToolheadsState cannot be reset, please reset the individual ToolheadState instead");r.forEach(t=>{e(u(t.toolNumber),{...t,toolNumber:t.toolNumber})})}}),g=(0,i.selector)({key:"LoadablePrinterToolheadsState",get:async({get:e})=>{let t=e((0,i.noWait)(h));return({hasValue:()=>t.contents,hasError:()=>[],loading:()=>[]})[t.state]()}})},50294:(e,t,r)=>{"use strict";r.d(t,{Ak:()=>deserializePrinterRail,DX:()=>stringToTitleObject,Df:()=>deserializeDriver,Oj:()=>deserializePrinterRailDefinition,WZ:()=>deserializeStepper,Yz:()=>serializePrinterRail,m6:()=>serializeToolheadConfiguration,od:()=>serializePartialToolheadConfiguration});var i=r(63469),o=r(83908),n=r(15896);r(32327),r(58307);let deserializeDriver=e=>i.N.find(t=>t.id===e)??null,deserializeStepper=e=>n.B.find(t=>t.id===e)??null,deserializePrinterRail=e=>{let t=deserializeStepper(e.stepper),r=deserializeDriver(e.driver);if(null==t)throw Error(`Stepper ${e.stepper} not found in database`);if(null==r)throw Error(`Driver ${e.driver} not found in database`);return o.g6.parse({...e,stepper:t,driver:r})},deserializePrinterRailDefinition=e=>{let t=deserializeStepper(e.stepper),r=deserializeDriver(e.driver);if(null==t)throw Error(`Stepper ${e.stepper} not found in database`);if(null==r)throw Error(`Driver ${e.driver} not found in database`);return o.P6.parse({...e,stepper:t,driver:r})},stringToTitleObject=e=>({id:e,title:e}),serializePrinterRail=e=>o.Ah.parse({...e,driver:e.driver.id,stepper:e.stepper.id}),serializeToolheadConfiguration=e=>({...e,toolboard:e.toolboard?.id,hotend:e.hotend.id,thermistor:e.thermistor,extruder:e.extruder.id,probe:e.probe?.id,xEndstop:e.xEndstop.id,yEndstop:e.yEndstop.id,partFan:e.partFan.id,hotendFan:e.hotendFan.id,xAccelerometer:e.xAccelerometer?.id,yAccelerometer:e.yAccelerometer?.id}),serializePartialToolheadConfiguration=e=>null==e?void 0:{...e,toolboard:e.toolboard?.id,hotend:e.hotend?.id,thermistor:e.thermistor,extruder:e.extruder?.id,probe:e.probe?.id,xEndstop:e.xEndstop?.id,yEndstop:e.yEndstop?.id,partFan:e.partFan?.id,hotendFan:e.hotendFan?.id,xAccelerometer:e.xAccelerometer?.id,yAccelerometer:e.yAccelerometer?.id}},16779:(e,t,r)=>{"use strict";r.d(t,{SX:()=>n,uF:()=>a});var i=r(68445),o=r(27716);function getBaseUrl(){return process.env.RENDER_INTERNAL_HOSTNAME?`http://${process.env.RENDER_INTERNAL_HOSTNAME}:${process.env.PORT}/configure`:`http://127.0.0.1:${process.env.PORT??3e3}/configure`}let n=(0,o.t)({config:()=>({links:[(0,i.N8)({url:`${getBaseUrl()}/api/trpc`,maxURLLength:2083})]}),ssr:!1}),a=(0,i.K5)({links:[(0,i.N8)({url:`${getBaseUrl()}/api/trpc`,maxURLLength:2083})]})},32719:(e,t,r)=>{"use strict";r.d(t,{$l:()=>b,MG:()=>z,Ui:()=>g,WQ:()=>h});var i,o=r(13728),n=r(83908);let a=o.z.object({x_step_pin:o.z.string().optional(),x_dir_pin:o.z.string().optional(),x_enable_pin:o.z.string().optional(),x_uart_pin:o.z.string().optional(),x_diag_pin:o.z.string().optional(),x_endstop_pin:o.z.string().optional(),x1_step_pin:o.z.string().optional(),x1_dir_pin:o.z.string().optional(),x1_enable_pin:o.z.string().optional(),x1_uart_pin:o.z.string().optional(),x1_diag_pin:o.z.string().optional(),x1_endstop_pin:o.z.string().optional(),dual_carriage_step_pin:o.z.string().optional(),dual_carriage_dir_pin:o.z.string().optional(),dual_carriage_enable_pin:o.z.string().optional(),dual_carriage_uart_pin:o.z.string().optional(),dual_carriage_diag_pin:o.z.string().optional(),dual_carriage_endstop_pin:o.z.string().optional(),y_step_pin:o.z.string().optional(),y_dir_pin:o.z.string().optional(),y_enable_pin:o.z.string().optional(),y_uart_pin:o.z.string().optional(),y_diag_pin:o.z.string().optional(),y_endstop_pin:o.z.string().optional(),y1_step_pin:o.z.string().optional(),y1_dir_pin:o.z.string().optional(),y1_enable_pin:o.z.string().optional(),y1_uart_pin:o.z.string().optional(),y1_diag_pin:o.z.string().optional(),y1_endstop_pin:o.z.string().optional(),y2_step_pin:o.z.string().optional(),y2_dir_pin:o.z.string().optional(),y2_enable_pin:o.z.string().optional(),y2_uart_pin:o.z.string().optional(),y2_diag_pin:o.z.string().optional(),y2_endstop_pin:o.z.string().optional(),z0_step_pin:o.z.string().optional(),z0_dir_pin:o.z.string().optional(),z0_enable_pin:o.z.string().optional(),z0_uart_pin:o.z.string().optional(),z0_diag_pin:o.z.string().optional(),z1_step_pin:o.z.string().optional(),z1_dir_pin:o.z.string().optional(),z1_enable_pin:o.z.string().optional(),z1_uart_pin:o.z.string().optional(),z1_diag_pin:o.z.string().optional(),z2_step_pin:o.z.string().optional(),z2_dir_pin:o.z.string().optional(),z2_enable_pin:o.z.string().optional(),z2_uart_pin:o.z.string().optional(),z2_diag_pin:o.z.string().optional(),z3_step_pin:o.z.string().optional(),z3_dir_pin:o.z.string().optional(),z3_enable_pin:o.z.string().optional(),z3_uart_pin:o.z.string().optional(),z3_diag_pin:o.z.string().optional(),e_step_pin:o.z.string().optional(),e_dir_pin:o.z.string().optional(),e_enable_pin:o.z.string().optional(),e_uart_pin:o.z.string().optional(),e_diag_pin:o.z.string().optional(),e_heater_pin:o.z.string().optional(),e_sensor_pin:o.z.string().optional(),stepper_spi_mosi_pin:o.z.string().optional(),stepper_spi_miso_pin:o.z.string().optional(),stepper_spi_sclk_pin:o.z.string().optional(),adxl345_cs_pin:o.z.string().optional(),bltouch_sensor_pin:o.z.string().optional(),bltouch_control_pin:o.z.string().optional(),probe_pin:o.z.string().optional(),fan_part_cooling_pin:o.z.string().optional(),fan_toolhead_cooling_pin:o.z.string().optional(),fan_controller_board_pin:o.z.string().optional(),heater_bed_heating_pin:o.z.string().optional(),heater_bed_sensor_pin:o.z.string().optional(),"4p_fan_part_cooling_pin":o.z.string().optional(),"4p_fan_part_cooling_tach_pin":o.z.string().optional(),"4p_toolhead_cooling_pin":o.z.string().optional(),"4p_toolhead_cooling_tach_pin":o.z.string().optional(),"4p_controller_board_pin":o.z.string().optional(),"4p_controller_board_tach_pin":o.z.string().optional()});!function(e){e.x="x",e.x1="x1",e.y="y",e.y1="y1",e.y2="y2",e.z0="z0",e.z1="z1",e.z2="z2",e.z3="z3",e.e="e",e.dual_carriage="dual_carriage"}(i||(i={}));let s={x:n.po.x,x1:n.po.x1,y:n.po.y,y1:n.po.y1,y2:n.po.y2,z0:n.po.z,z1:n.po.z1,z2:n.po.z2,z3:n.po.z3,e:n.po.extruder,dual_carriage:n.po.dual_carriage};o.z.nativeEnum(i).transform(e=>s[e]??null),o.z.nativeEnum(n.po).transform(e=>Object.keys(s).find(t=>s[t]===e)??null),a.extend({x_step_pin:o.z.string(),x_dir_pin:o.z.string(),x_enable_pin:o.z.string(),x_uart_pin:o.z.string(),x_endstop_pin:o.z.string(),y_step_pin:o.z.string(),y_dir_pin:o.z.string(),y_enable_pin:o.z.string(),y_uart_pin:o.z.string(),y_endstop_pin:o.z.string(),z0_step_pin:o.z.string(),z0_dir_pin:o.z.string(),z0_enable_pin:o.z.string(),z0_uart_pin:o.z.string(),e_step_pin:o.z.string(),e_dir_pin:o.z.string(),e_enable_pin:o.z.string(),e_uart_pin:o.z.string(),e_heater_pin:o.z.string(),e_sensor_pin:o.z.string(),probe_pin:o.z.string(),heater_bed_heating_pin:o.z.string(),heater_bed_sensor_pin:o.z.string()}).and(o.z.object({fan_part_cooling_pin:o.z.string(),fan_toolhead_cooling_pin:o.z.string()}).or(o.z.object({"4p_fan_part_cooling_pin":o.z.string(),"4p_fan_part_cooling_tach_pin":o.z.string(),"4p_toolhead_cooling_pin":o.z.string(),"4p_toolhead_cooling_tach_pin":o.z.string()}))),a.extend({x_step_pin:o.z.string(),x_dir_pin:o.z.string(),x_enable_pin:o.z.string(),x_uart_pin:o.z.string(),x_endstop_pin:o.z.string(),y_step_pin:o.z.string(),y_dir_pin:o.z.string(),y_enable_pin:o.z.string(),y_uart_pin:o.z.string(),y_endstop_pin:o.z.string(),z0_step_pin:o.z.string(),z0_dir_pin:o.z.string(),z0_enable_pin:o.z.string(),z0_uart_pin:o.z.string(),z1_step_pin:o.z.string(),z1_dir_pin:o.z.string(),z1_enable_pin:o.z.string(),z1_uart_pin:o.z.string(),z2_step_pin:o.z.string(),z2_dir_pin:o.z.string(),z2_enable_pin:o.z.string(),z2_uart_pin:o.z.string(),probe_pin:o.z.string(),heater_bed_heating_pin:o.z.string(),heater_bed_sensor_pin:o.z.string()}).and(o.z.object({fan_part_cooling_pin:o.z.string(),fan_toolhead_cooling_pin:o.z.string()}).or(o.z.object({"4p_fan_part_cooling_pin":o.z.string(),"4p_fan_part_cooling_tach_pin":o.z.string(),"4p_toolhead_cooling_pin":o.z.string(),"4p_toolhead_cooling_tach_pin":o.z.string()}))),a.extend({e_step_pin:o.z.string(),e_dir_pin:o.z.string(),e_enable_pin:o.z.string(),e_uart_pin:o.z.string(),e_heater_pin:o.z.string(),e_sensor_pin:o.z.string(),adxl345_cs_pin:o.z.string(),probe_pin:o.z.string()}).and(o.z.object({fan_part_cooling_pin:o.z.string(),fan_toolhead_cooling_pin:o.z.string()}).or(o.z.object({"4p_fan_part_cooling_pin":o.z.string(),"4p_fan_part_cooling_tach_pin":o.z.string(),"4p_toolhead_cooling_pin":o.z.string(),"4p_toolhead_cooling_tach_pin":o.z.string()})));let l=o.z.object({uart_pin:o.z.string(),uart_address:o.z.string().optional(),rx_pin:o.z.string().optional(),tx_pin:o.z.string().optional()}),d=o.z.object({cs_pin:o.z.string()}).and(o.z.object({spi_bus:o.z.string()}).or(o.z.object({spi_software_mosi_pin:o.z.string().optional(),spi_software_miso_pin:o.z.string().optional(),spi_software_sclk_pin:o.z.string().optional()}))),hasSPI=e=>d.safeParse(e).success,hasUART=e=>l.safeParse(e).success,p=o.z.object({step_pin:o.z.string(),dir_pin:o.z.string(),enable_pin:o.z.string(),diag_pin:o.z.string().optional(),endstop_pin:o.z.string().optional(),uart_pin:o.z.string().optional(),rx_pin:o.z.string().optional(),tx_pin:o.z.string().optional(),cs_pin:o.z.string().optional()}),c=p.extend({title:o.z.string(),uart_address:o.z.string().optional(),spi_bus:o.z.string().optional(),spi_software_mosi_pin:o.z.string().optional(),spi_software_miso_pin:o.z.string().optional(),spi_software_sclk_pin:o.z.string().optional()}).refine(e=>hasSPI(e)||hasUART(e),{message:"Motor slot must have either SPI or UART pins"});c.innerType().omit({title:!0}).partial();let u=o.z.string(),h=o.z.string().brand("BoardID"),g=o.z.string().brand("BoardPath"),_=o.z.string().brand("BoardSerialPath"),f=o.z.record(o.z.nativeEnum(n.po),o.z.string()),m=o.z.record(u,c),b=o.z.object({id:h,isToolboard:o.z.boolean().optional(),isHost:o.z.boolean().optional(),serialPath:_.optional(),name:o.z.string(),manufacturer:o.z.string(),firmwareBinaryName:o.z.string(),compileScript:o.z.string(),flashScript:o.z.string().optional(),flashInstructions:o.z.string().optional(),disableAutoFlash:o.z.boolean().optional(),documentationLink:o.z.string().optional(),hasQuirksFiles:o.z.boolean().optional(),driverCount:o.z.number(),integratedDrivers:f.optional(),extruderlessConfig:o.z.string().optional(),fourPinFanConnectorCount:o.z.number().optional(),driverVoltages:n.v6.array().default([24]),hasMcuTempSensor:o.z.boolean().default(!0),alternativePT1000Resistor:o.z.number().optional(),motorSlots:o.z.record(u,c).optional(),outputPins:o.z.array(o.z.object({pin:o.z.string(),name:o.z.string(),value:o.z.number().min(0).max(1)})).optional(),dfu:o.z.object({dfuBootImage:o.z.string(),flashDevice:o.z.string(),instructions:o.z.array(o.z.string()),reminder:o.z.string().optional(),hasBoot0Jumper:o.z.boolean()}).optional(),stepperSPI:o.z.object({software:o.z.object({sclk:o.z.string(),mosi:o.z.string(),miso:o.z.string()})}).or(o.z.object({hardware:o.z.object({bus:o.z.string()})})).optional(),ADXL345SPI:o.z.object({cs_pin:o.z.string()}).and(o.z.object({software:o.z.object({sclk:o.z.string(),mosi:o.z.string(),miso:o.z.string()})}).or(o.z.object({hardware:o.z.object({bus:o.z.string()})}))).optional(),path:g}).and(o.z.object({isToolboard:o.z.literal(!0),motorSlots:o.z.undefined()}).or(o.z.object({motorSlots:m})).or(o.z.object({isHost:o.z.literal(!0),motorSlots:o.z.undefined()})));b.and(o.z.object({detected:o.z.boolean()})),o.z.object({id:o.z.string(),disableAutoFlash:o.z.literal(!1).optional(),isToolboard:o.z.boolean().optional(),compileScript:o.z.string(),flashScript:o.z.string(),path:g});let z=b.and(o.z.object({isToolboard:o.z.literal(!0),isHost:o.z.literal(!1).optional(),integratedDrivers:f.and(o.z.object({[n.po.extruder]:o.z.string()}))}));z.and(o.z.object({detected:o.z.boolean()}))},34637:(e,t,r)=>{"use strict";r.d(t,{M3:()=>_,Mf:()=>d,U3:()=>u,Uy:()=>p,XG:()=>f,lV:()=>h,ow:()=>c,ws:()=>g});var i=r(13728),o=r(83547),n=r(83908);let a=["EPCOS 100K B57560G104F","ATC Semitec 104GT-2","ATC Semitec 104NT-4-R025H42G","Generic 3950","Honeywell 100K 135-104LAG-J01","NTC 100K MGB18-104F39050L32","SliceEngineering 450","TDK NTCG104LH104JT1","PT1000"],s="";if(process.env.RATOS_CONFIGURATION_PATH){let e=o.Rz.parse(process.env);s=e.RATOS_CONFIGURATION_PATH}let l=i.z.object({path:i.z.string().startsWith(s).endsWith(".cfg"),id:i.z.string()}),d=i.z.enum(a),p=l.extend({type:i.z.literal("hotend"),title:i.z.string(),thermistor:i.z.enum(a),flowType:i.z.union([i.z.literal("sf"),i.z.literal("hf"),i.z.literal("uhf")])}),c=i.z.object({type:i.z.enum(["Regular","CHT"]),diameter:i.z.number().min(.2).max(1.8)}),u=l.extend({type:i.z.literal("extruder"),stepper:n.vF.shape.id.optional(),current:n.P6.shape.current.optional(),title:i.z.string()}),h=l.extend({type:i.z.literal("static-probe").or(i.z.literal("stowable-probe")),title:i.z.string()}),g=i.z.object({id:i.z.enum(["endstop","endstop-toolboard","sensorless"]),title:i.z.string()}),_=i.z.object({id:i.z.enum(["toolboard","controlboard","sbc","none"]),title:i.z.string()}),f=i.z.object({id:i.z.enum(["2pin","4pin","4pin-dedicated","2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard","none"]),title:i.z.string()})},83908:(e,t,r)=>{"use strict";r.d(t,{Ah:()=>_,HB:()=>l,JQ:()=>g,P6:()=>u,R_:()=>matchesDefaultRail,Wx:()=>getSupportedVoltages,g6:()=>c,po:()=>o,r:()=>h,v6:()=>s,vF:()=>p});var i,o,n=r(13728);!function(e){e[e["24V"]=24]="24V",e[e["36V"]=36]="36V",e[e["48V"]=48]="48V",e[e["56V"]=56]="56V",e[e["60V"]=60]="60V"}(i||(i={}));let a=[{id:24,title:"24V"},{id:36,title:"36V"},{id:48,title:"48V"},{id:56,title:"56V"},{id:60,title:"60V"}],getSupportedVoltages=(e,t)=>t?.external?a.filter(e=>t?.voltages?.includes(e.id)||24===e.id):a.filter(t=>e?.driverVoltages?.includes(t.id)||24===t.id).filter(e=>t?.voltages?.includes(e.id)||24===e.id),matchesDefaultRail=(e,t,r)=>e.axis===t.axis&&e.driver.id===t.driver.id&&e.stepper.id===t.stepper.id&&(r&&t.performanceMode&&e.voltage===t.performanceMode?.voltage&&e.current===t.performanceMode?.current||!r&&e.voltage===t.voltage&&e.current===t.current),s=n.jb(i),l=n.Ry({id:n.Z_(),title:n.Z_(),type:n.Km(["TMC2209","TMC2226","TMC5160","TMC2130","TMC2240"]),protocol:n.Km(["SPI","UART"]),senseResistor:n.Rx().min(0),coolingCurrentThreshold:n.Rx(),voltages:s.array(),maxCurrent:n.Rx().min(0),external:n.O7().optional()}),d=n.Ry({voltage:s,run_current:n.Rx(),driver:l.shape.id,sense_resistor:n.Rx()}),p=n.Ry({id:n.Z_(),title:n.Z_(),fullStepsPerRotation:n.Rx().default(200),maxPeakCurrent:n.Rx().min(0),presets:n.IX(n.VK("driver",[d.extend({driver:n.Km(["TMC2130","TMC5160","TMC2240"]),driver_MSLUT0:n.Rx().optional(),driver_MSLUT1:n.Rx().optional(),driver_MSLUT2:n.Rx().optional(),driver_MSLUT3:n.Rx().optional(),driver_MSLUT4:n.Rx().optional(),driver_MSLUT5:n.Rx().optional(),driver_MSLUT6:n.Rx().optional(),driver_MSLUT7:n.Rx().optional(),driver_W0:n.Rx().optional(),driver_W1:n.Rx().optional(),driver_W2:n.Rx().optional(),driver_W3:n.Rx().optional(),driver_X1:n.Rx().optional(),driver_X2:n.Rx().optional(),driver_X3:n.Rx().optional(),driver_START_SIN:n.Rx().optional(),driver_START_SIN90:n.Rx().optional(),driver_IHOLDDELAY:n.Rx().optional(),driver_TPOWERDOWN:n.Rx().optional(),driver_TBL:n.Rx().optional(),driver_TOFF:n.Rx().optional(),driver_HEND:n.Rx().optional(),driver_HSTRT:n.Rx().optional(),driver_PWM_AUTOSCALE:n.O7().optional(),driver_PWM_FREQ:n.Rx().optional(),driver_PWM_GRAD:n.Rx().optional(),driver_PWM_AMPL:n.Rx().optional(),driver_SGT:n.Rx().optional()}),d.extend({driver:n.Km(["TMC2209"]),driver_TBL:n.Rx().optional(),driver_TOFF:n.Rx().optional(),driver_HEND:n.Rx().optional(),driver_HSTRT:n.Rx().optional()})])).optional().describe("Stepper presets are tightly coupled to the driver type, sense_resistor, stepper, voltage and current.")});!function(e){e.x="x",e.dual_carriage="dual_carriage",e.x1="x1",e.y="y",e.y1="y1",e.y2="y2",e.z="z",e.z1="z1",e.z2="z2",e.z3="z3",e.extruder="extruder",e.extruder1="extruder1"}(o||(o={}));let c=n.Ry({axis:n.jb(o).describe("Axis of the rail"),axisDescription:n.Z_().optional().describe("Description of the axis"),driver:l.describe("Stepper driver used on this axis"),voltage:s.default(24).describe("Voltage of the stepper driver"),stepper:p.describe("Stepper motor connected to this axis"),motorSlot:n.Z_().optional().describe("Optional board motor slot of the stepper driver"),current:n.Rx().min(0),rotationDistance:n.Rx().min(0).describe("Distance in mm the axis travels per stepper rotation"),gearRatio:n.Z_().regex(/^\d+:\d+$/).optional().describe("Optional gear ratio of the axis"),homingSpeed:n.Rx().min(0).default(10).describe("Axis speed during homing in mm/s"),microstepping:n.Rx().min(16).max(256).default(64).describe("Microstepping of the stepper driver, higher values increase resolution and lower noise but increases load on the MCU")}),u=c.extend({motorSlot:n.S1(),performanceMode:n.Ry({current:n.Rx().min(0),voltage:s.default(24).describe("Voltage of the stepper driver in performance mode"),homingSpeed:n.Rx().min(0).optional().describe("Axis speed during homing in mm/s in performance mode")}).optional()}),h=u.extend({driver:l.shape.id,stepper:p.shape.id}),g=c.refine(e=>e.current<=e.driver.maxCurrent,"Current must be less than max current of the driver"),_=c.extend({driver:l.shape.id,stepper:p.shape.id});n.Ry({min:n.Rx(),max:n.Rx(),endstop:n.Rx()})},86982:(e,t,r)=>{"use strict";r.d(t,{LN:()=>p,NN:()=>_,dl:()=>u,jz:()=>g,q_:()=>h});var i=r(32719),o=r(34637),n=r(53107),a=r(83908),s=r(32327),l=r(58307),d=r(13728);let p=d.z.union([n.A5,d.z.number(),d.z.string()]).nullable().optional(),c=d.z.object({printer:n.Qu,controlboard:i.$l,toolheads:d.z.array(s.x8).min(1).max(2),size:p,controllerFan:o.XG,performanceMode:d.z.boolean().default(!1),stealthchop:d.z.boolean().default(!1),standstillStealth:d.z.boolean().default(!1),rails:d.z.array(a.JQ)}).strict().transform((e,t)=>{if(null==e.size)e.size=e.printer.sizes[Object.keys(e.printer.sizes)[0]];else if("number"==typeof e.size||"string"==typeof e.size){let r=e.printer.sizes[e.size.toString()];if(null==r)return t.addIssue({code:d.z.ZodIssueCode.custom,message:`Size ${e.size} is not a valid size for a ${e.printer.name} config`}),d.z.NEVER;e.size=r}return e}),u=c.superRefine((e,t)=>{let r=e.toolheads.map(e=>e.toolboard).filter(Boolean).length;r+e.controlboard.driverCount<e.printer.driverCountRequired&&t.addIssue({code:d.z.ZodIssueCode.too_small,message:`Your combination of controlboard and toolboards do not have enough stepper drivers for a ${e.printer.name} config`,minimum:e.printer.driverCountRequired,inclusive:!0,type:"number"})}).superRefine((e,t)=>{let r=e.toolheads.map(e=>new l.D(e)),i=e.rails.map((i,o)=>{let n=r.find(e=>e.getExtruderAxis()===i.axis);if(null!=i.motorSlot){let s=e.rails.filter(e=>{let t=r.find(t=>t.getExtruderAxis()===e.axis);return e.axis!==i.axis&&n?.hasToolboard()==null&&t?.hasToolboard==null&&e.motorSlot===i.motorSlot}),railName=e=>"extruder"===e?"Extruder T0":e===a.po.extruder1?"Extruder T1":"Stepper "+e.toLocaleUpperCase();return 1===s.length?t.addIssue({code:d.z.ZodIssueCode.custom,message:`Motor slot ${i.motorSlot} is already in use on ${railName(s[0].axis)}`,path:["rails",o,"motorSlot"]}):s.length>1&&t.addIssue({code:d.z.ZodIssueCode.custom,message:`Motor slot ${i.motorSlot} is already in use on ${s.slice(0,-1).map(e=>railName(e.axis)).join(", ")} and ${railName(s[s.length-1].axis)}`,path:["rails",o,"motorSlot"]}),s.length>0?{rail:i,conflicts:s}:0}return null}).filter(Boolean);i.length>0&&t.addIssue({code:d.z.ZodIssueCode.custom,message:"Motor slot conflicts detected"})}),h=c.innerType().extend({printer:n.Qu.shape.id,controlboard:i.WQ,toolheads:d.z.array(s.Qk).min(1).max(2),controllerFan:o.XG.shape.id,rails:d.z.array(a.Ah)}).strict(),g=c.innerType().extend({toolheads:d.z.array(s.b2).min(1).max(2)}).strict().partial().optional(),_=h.extend({toolheads:d.z.array(s.ZF).min(1).max(2)}).strict().partial()},53107:(e,t,r)=>{"use strict";r.d(t,{A5:()=>h,Ox:()=>_,Qu:()=>g});var i=r(13728),o=r(83547),n=r(71017),a=r.n(n),s=r(83908),l=r(32327),d=r(34637),p=r(32719);let c="";if(process.env.RATOS_CONFIGURATION_PATH){let e=o.Rz.parse(process.env);c=a().join(e.RATOS_CONFIGURATION_PATH,"printers")}let u=i.z.object({velocity:i.z.number().min(0).describe("Maximum velocity for this printer"),accel:i.z.number().min(0).describe("Maximum acceleration for this printer"),z_velocity:i.z.number().min(0).describe("Maximum z velocity for this printer"),z_accel:i.z.number().min(0).describe("Maximum z acceleration for this printer"),square_corner_velocity:i.z.number().min(0).default(5).describe("Maximum square corner velocity for this printer"),travel_velocity:i.z.number().min(0).default(200).describe("Maximum travel velocity for this printer"),travel_accel:i.z.number().min(0).default(3e3).describe("Maximum travel velocity for this printer")}).strict(),h=i.z.object({x:i.z.number().min(0).describe("The print volume in X"),y:i.z.number().min(0).describe("The print volume in Y"),z:i.z.number().min(0).describe("The print volume in Z")}).describe("The print volume of a printer"),g=i.z.object({id:i.z.string(),name:i.z.string().describe("The name of the printer"),description:i.z.string().describe("A description of the printer"),manufacturer:i.z.string().describe("The name of the manufacturer of this printer"),documentationLink:i.z.string().describe("Link to the RatOS documentation for this printer"),image:i.z.string().describe("Link to an image of the printer"),sizes:i.z.record(i.z.string(),h).describe("Size options for this printer"),template:i.z.string().describe("Printer.cfg template for this printer"),path:i.z.string().startsWith(c),driverCountRequired:i.z.number().describe("Number of drivers required for this printer"),kinematics:i.z.union([i.z.literal("cartesian"),i.z.literal("corexy"),i.z.literal("hybrid-corexy"),i.z.literal("hybrid-corexy-idex")]).optional(),bedMargin:i.z.object({x:i.z.tuple([i.z.number().default(0),i.z.number().default(0)]),y:i.z.tuple([i.z.number().default(0),i.z.number().default(0)])}).describe("Margin of available movement around the bed for this printer").default({x:[0,0],y:[0,0]}),speedLimits:i.z.object({basic:u,performance:u.optional()}).strict().describe("Speed limits for this printer"),defaults:i.z.object({toolheads:i.z.array(l.Qk).describe("Default toolheads for this printer"),board:p.WQ.describe("Default board for this printer. Should be the name of the board directory."),rails:i.z.array(s.r).describe("Default rails for this printer"),controllerFan:d.XG.shape.id.optional().describe("Default controller fan for this printer")}).strict().describe("Default hardware for this printer")}).describe("A RatOS supported 3d printer"),_=g.extend({defaults:g.shape.defaults.extend({toolheads:i.z.array(l.x8)}).strict()})},32327:(e,t,r)=>{"use strict";r.d(t,{PY:()=>l,Qk:()=>h,Qr:()=>d,ZF:()=>g,b2:()=>u,x8:()=>c});var i=r(13728),o=r(32719),n=r(34637),a=r(83908),s=r(28409);let l=i.z.object({hotend:n.Uy,thermistor:n.Mf,extruder:n.U3,xEndstop:n.ws,yEndstop:n.ws,hotendFan:n.XG,partFan:n.XG,nozzle:n.ow.default((0,s.S)()),xAccelerometer:n.M3.optional().nullable(),yAccelerometer:n.M3.optional().nullable(),toolboard:o.MG.nullable(),probe:n.lV.optional(),axis:i.z.literal(a.po.x).or(i.z.literal(a.po.dual_carriage)),description:i.z.string().optional(),toolNumber:i.z.number().optional()}).strict(),d=i.z.union([i.z.literal(0),i.z.literal(1)]),p=i.z.union([i.z.literal(a.po.x),i.z.literal(a.po.dual_carriage),i.z.literal(a.po.extruder),i.z.literal(a.po.extruder1)]);i.z.union([p,d]);let c=l.refine(e=>null!==e.toolboard||"endstop-toolboard"!==e.xEndstop.id,"Cannot use toolboard endstop without a toolboard").refine(e=>null!==e.toolboard||!["2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard"].includes(e.hotendFan.id),"Cannot use toolboard hotend fan without a toolboard").refine(e=>null!==e.toolboard||!["2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard"].includes(e.partFan.id),"Cannot use toolboard part cooling fan without a toolboard"),u=l.partial().optional(),h=l.extend({hotend:n.Uy.shape.id,extruder:n.U3.shape.id,thermistor:n.Mf,xEndstop:n.ws.shape.id,yEndstop:n.ws.shape.id,hotendFan:n.XG.shape.id,partFan:n.XG.shape.id,xAccelerometer:n.M3.shape.id.optional().nullable(),yAccelerometer:n.M3.shape.id.optional().nullable(),toolboard:o.WQ.optional().nullable(),probe:n.lV.shape.id.optional().nullable()}).strict(),g=h.partial().optional()},25419:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>RootLayout});var i,o,n,a,s,l,d=r(86700),p=r(57147),c=r.n(p),u=r(11466);let h=u.z.object({NODE_ENV:u.z.enum(["development","test","production"]),RATOS_CONFIGURATION_PATH:u.z.string(),RATOS_SCRIPT_DIR:u.z.string(),KLIPPER_CONFIG_PATH:u.z.string(),KLIPPER_DIR:u.z.string(),KLIPPER_ENV:u.z.string(),MOONRAKER_DIR:u.z.string(),LOG_FILE:u.z.string(),RATOS_DATA_DIR:u.z.string()});u.z.object({NEXT_PUBLIC_KLIPPER_HOSTNAME:u.z.string().optional()});var g=r(49684),_=r.n(g);let f=null,getLogger=()=>{if(null!=f)return f;let e=h.parse(process.env),t={target:"pino/file",options:{destination:e.LOG_FILE,append:!0}};return f=_()({timestamp:!0,transport:t})};var m=r(32081),b=r(71017),z=r.n(b),x=r(14521),T=r(73837);!function(e){e[e["24V"]=24]="24V",e[e["36V"]=36]="36V",e[e["48V"]=48]="48V",e[e["56V"]=56]="56V",e[e["60V"]=60]="60V"}(a||(a={}));let matchesDefaultRail=(e,t,r)=>e.axis===t.axis&&e.driver.id===t.driver.id&&e.stepper.id===t.stepper.id&&(r&&t.performanceMode&&e.voltage===t.performanceMode?.voltage&&e.current===t.performanceMode?.current||!r&&e.voltage===t.voltage&&e.current===t.current),v=u.jb(a),y=u.Ry({id:u.Z_(),title:u.Z_(),type:u.Km(["TMC2209","TMC2226","TMC5160","TMC2130","TMC2240"]),protocol:u.Km(["SPI","UART"]),senseResistor:u.Rx().min(0),coolingCurrentThreshold:u.Rx(),voltages:v.array(),maxCurrent:u.Rx().min(0),external:u.O7().optional()}),P=u.Ry({voltage:v,run_current:u.Rx(),driver:y.shape.id,sense_resistor:u.Rx()}),S=u.Ry({id:u.Z_(),title:u.Z_(),fullStepsPerRotation:u.Rx().default(200),maxPeakCurrent:u.Rx().min(0),presets:u.IX(u.VK("driver",[P.extend({driver:u.Km(["TMC2130","TMC5160","TMC2240"]),driver_MSLUT0:u.Rx().optional(),driver_MSLUT1:u.Rx().optional(),driver_MSLUT2:u.Rx().optional(),driver_MSLUT3:u.Rx().optional(),driver_MSLUT4:u.Rx().optional(),driver_MSLUT5:u.Rx().optional(),driver_MSLUT6:u.Rx().optional(),driver_MSLUT7:u.Rx().optional(),driver_W0:u.Rx().optional(),driver_W1:u.Rx().optional(),driver_W2:u.Rx().optional(),driver_W3:u.Rx().optional(),driver_X1:u.Rx().optional(),driver_X2:u.Rx().optional(),driver_X3:u.Rx().optional(),driver_START_SIN:u.Rx().optional(),driver_START_SIN90:u.Rx().optional(),driver_IHOLDDELAY:u.Rx().optional(),driver_TPOWERDOWN:u.Rx().optional(),driver_TBL:u.Rx().optional(),driver_TOFF:u.Rx().optional(),driver_HEND:u.Rx().optional(),driver_HSTRT:u.Rx().optional(),driver_PWM_AUTOSCALE:u.O7().optional(),driver_PWM_FREQ:u.Rx().optional(),driver_PWM_GRAD:u.Rx().optional(),driver_PWM_AMPL:u.Rx().optional(),driver_SGT:u.Rx().optional()}),P.extend({driver:u.Km(["TMC2209"]),driver_TBL:u.Rx().optional(),driver_TOFF:u.Rx().optional(),driver_HEND:u.Rx().optional(),driver_HSTRT:u.Rx().optional()})])).optional().describe("Stepper presets are tightly coupled to the driver type, sense_resistor, stepper, voltage and current.")});!function(e){e.x="x",e.dual_carriage="dual_carriage",e.x1="x1",e.y="y",e.y1="y1",e.y2="y2",e.z="z",e.z1="z1",e.z2="z2",e.z3="z3",e.extruder="extruder",e.extruder1="extruder1"}(s||(s={}));let R=u.Ry({axis:u.jb(s).describe("Axis of the rail"),axisDescription:u.Z_().optional().describe("Description of the axis"),driver:y.describe("Stepper driver used on this axis"),voltage:v.default(24).describe("Voltage of the stepper driver"),stepper:S.describe("Stepper motor connected to this axis"),motorSlot:u.Z_().optional().describe("Optional board motor slot of the stepper driver"),current:u.Rx().min(0),rotationDistance:u.Rx().min(0).describe("Distance in mm the axis travels per stepper rotation"),gearRatio:u.Z_().regex(/^\d+:\d+$/).optional().describe("Optional gear ratio of the axis"),homingSpeed:u.Rx().min(0).default(10).describe("Axis speed during homing in mm/s"),microstepping:u.Rx().min(16).max(256).default(64).describe("Microstepping of the stepper driver, higher values increase resolution and lower noise but increases load on the MCU")}),C=R.extend({motorSlot:u.S1(),performanceMode:u.Ry({current:u.Rx().min(0),voltage:v.default(24).describe("Voltage of the stepper driver in performance mode"),homingSpeed:u.Rx().min(0).optional().describe("Axis speed during homing in mm/s in performance mode")}).optional()}),w=C.extend({driver:y.shape.id,stepper:S.shape.id}),E=R.refine(e=>e.current<=e.driver.maxCurrent,"Current must be less than max current of the driver"),A=R.extend({driver:y.shape.id,stepper:S.shape.id});u.Ry({min:u.Rx(),max:u.Rx(),endstop:u.Rx()});let N=u.z.object({x_step_pin:u.z.string().optional(),x_dir_pin:u.z.string().optional(),x_enable_pin:u.z.string().optional(),x_uart_pin:u.z.string().optional(),x_diag_pin:u.z.string().optional(),x_endstop_pin:u.z.string().optional(),x1_step_pin:u.z.string().optional(),x1_dir_pin:u.z.string().optional(),x1_enable_pin:u.z.string().optional(),x1_uart_pin:u.z.string().optional(),x1_diag_pin:u.z.string().optional(),x1_endstop_pin:u.z.string().optional(),dual_carriage_step_pin:u.z.string().optional(),dual_carriage_dir_pin:u.z.string().optional(),dual_carriage_enable_pin:u.z.string().optional(),dual_carriage_uart_pin:u.z.string().optional(),dual_carriage_diag_pin:u.z.string().optional(),dual_carriage_endstop_pin:u.z.string().optional(),y_step_pin:u.z.string().optional(),y_dir_pin:u.z.string().optional(),y_enable_pin:u.z.string().optional(),y_uart_pin:u.z.string().optional(),y_diag_pin:u.z.string().optional(),y_endstop_pin:u.z.string().optional(),y1_step_pin:u.z.string().optional(),y1_dir_pin:u.z.string().optional(),y1_enable_pin:u.z.string().optional(),y1_uart_pin:u.z.string().optional(),y1_diag_pin:u.z.string().optional(),y1_endstop_pin:u.z.string().optional(),y2_step_pin:u.z.string().optional(),y2_dir_pin:u.z.string().optional(),y2_enable_pin:u.z.string().optional(),y2_uart_pin:u.z.string().optional(),y2_diag_pin:u.z.string().optional(),y2_endstop_pin:u.z.string().optional(),z0_step_pin:u.z.string().optional(),z0_dir_pin:u.z.string().optional(),z0_enable_pin:u.z.string().optional(),z0_uart_pin:u.z.string().optional(),z0_diag_pin:u.z.string().optional(),z1_step_pin:u.z.string().optional(),z1_dir_pin:u.z.string().optional(),z1_enable_pin:u.z.string().optional(),z1_uart_pin:u.z.string().optional(),z1_diag_pin:u.z.string().optional(),z2_step_pin:u.z.string().optional(),z2_dir_pin:u.z.string().optional(),z2_enable_pin:u.z.string().optional(),z2_uart_pin:u.z.string().optional(),z2_diag_pin:u.z.string().optional(),z3_step_pin:u.z.string().optional(),z3_dir_pin:u.z.string().optional(),z3_enable_pin:u.z.string().optional(),z3_uart_pin:u.z.string().optional(),z3_diag_pin:u.z.string().optional(),e_step_pin:u.z.string().optional(),e_dir_pin:u.z.string().optional(),e_enable_pin:u.z.string().optional(),e_uart_pin:u.z.string().optional(),e_diag_pin:u.z.string().optional(),e_heater_pin:u.z.string().optional(),e_sensor_pin:u.z.string().optional(),stepper_spi_mosi_pin:u.z.string().optional(),stepper_spi_miso_pin:u.z.string().optional(),stepper_spi_sclk_pin:u.z.string().optional(),adxl345_cs_pin:u.z.string().optional(),bltouch_sensor_pin:u.z.string().optional(),bltouch_control_pin:u.z.string().optional(),probe_pin:u.z.string().optional(),fan_part_cooling_pin:u.z.string().optional(),fan_toolhead_cooling_pin:u.z.string().optional(),fan_controller_board_pin:u.z.string().optional(),heater_bed_heating_pin:u.z.string().optional(),heater_bed_sensor_pin:u.z.string().optional(),"4p_fan_part_cooling_pin":u.z.string().optional(),"4p_fan_part_cooling_tach_pin":u.z.string().optional(),"4p_toolhead_cooling_pin":u.z.string().optional(),"4p_toolhead_cooling_tach_pin":u.z.string().optional(),"4p_controller_board_pin":u.z.string().optional(),"4p_controller_board_tach_pin":u.z.string().optional()});!function(e){e.x="x",e.x1="x1",e.y="y",e.y1="y1",e.y2="y2",e.z0="z0",e.z1="z1",e.z2="z2",e.z3="z3",e.e="e",e.dual_carriage="dual_carriage"}(l||(l={}));let O={x:s.x,x1:s.x1,y:s.y,y1:s.y1,y2:s.y2,z0:s.z,z1:s.z1,z2:s.z2,z3:s.z3,e:s.extruder,dual_carriage:s.dual_carriage},$=u.z.nativeEnum(l).transform(e=>O[e]??null),F=u.z.nativeEnum(s).transform(e=>Object.keys(O).find(t=>O[t]===e)??null),j=N.extend({x_step_pin:u.z.string(),x_dir_pin:u.z.string(),x_enable_pin:u.z.string(),x_uart_pin:u.z.string(),x_endstop_pin:u.z.string(),y_step_pin:u.z.string(),y_dir_pin:u.z.string(),y_enable_pin:u.z.string(),y_uart_pin:u.z.string(),y_endstop_pin:u.z.string(),z0_step_pin:u.z.string(),z0_dir_pin:u.z.string(),z0_enable_pin:u.z.string(),z0_uart_pin:u.z.string(),e_step_pin:u.z.string(),e_dir_pin:u.z.string(),e_enable_pin:u.z.string(),e_uart_pin:u.z.string(),e_heater_pin:u.z.string(),e_sensor_pin:u.z.string(),probe_pin:u.z.string(),heater_bed_heating_pin:u.z.string(),heater_bed_sensor_pin:u.z.string()}).and(u.z.object({fan_part_cooling_pin:u.z.string(),fan_toolhead_cooling_pin:u.z.string()}).or(u.z.object({"4p_fan_part_cooling_pin":u.z.string(),"4p_fan_part_cooling_tach_pin":u.z.string(),"4p_toolhead_cooling_pin":u.z.string(),"4p_toolhead_cooling_tach_pin":u.z.string()}))),M=N.extend({x_step_pin:u.z.string(),x_dir_pin:u.z.string(),x_enable_pin:u.z.string(),x_uart_pin:u.z.string(),x_endstop_pin:u.z.string(),y_step_pin:u.z.string(),y_dir_pin:u.z.string(),y_enable_pin:u.z.string(),y_uart_pin:u.z.string(),y_endstop_pin:u.z.string(),z0_step_pin:u.z.string(),z0_dir_pin:u.z.string(),z0_enable_pin:u.z.string(),z0_uart_pin:u.z.string(),z1_step_pin:u.z.string(),z1_dir_pin:u.z.string(),z1_enable_pin:u.z.string(),z1_uart_pin:u.z.string(),z2_step_pin:u.z.string(),z2_dir_pin:u.z.string(),z2_enable_pin:u.z.string(),z2_uart_pin:u.z.string(),probe_pin:u.z.string(),heater_bed_heating_pin:u.z.string(),heater_bed_sensor_pin:u.z.string()}).and(u.z.object({fan_part_cooling_pin:u.z.string(),fan_toolhead_cooling_pin:u.z.string()}).or(u.z.object({"4p_fan_part_cooling_pin":u.z.string(),"4p_fan_part_cooling_tach_pin":u.z.string(),"4p_toolhead_cooling_pin":u.z.string(),"4p_toolhead_cooling_tach_pin":u.z.string()}))),I=N.extend({e_step_pin:u.z.string(),e_dir_pin:u.z.string(),e_enable_pin:u.z.string(),e_uart_pin:u.z.string(),e_heater_pin:u.z.string(),e_sensor_pin:u.z.string(),adxl345_cs_pin:u.z.string(),probe_pin:u.z.string()}).and(u.z.object({fan_part_cooling_pin:u.z.string(),fan_toolhead_cooling_pin:u.z.string()}).or(u.z.object({"4p_fan_part_cooling_pin":u.z.string(),"4p_fan_part_cooling_tach_pin":u.z.string(),"4p_toolhead_cooling_pin":u.z.string(),"4p_toolhead_cooling_tach_pin":u.z.string()}))),L=u.z.object({uart_pin:u.z.string(),uart_address:u.z.string().optional(),rx_pin:u.z.string().optional(),tx_pin:u.z.string().optional()}),D=u.z.object({cs_pin:u.z.string()}).and(u.z.object({spi_bus:u.z.string()}).or(u.z.object({spi_software_mosi_pin:u.z.string().optional(),spi_software_miso_pin:u.z.string().optional(),spi_software_sclk_pin:u.z.string().optional()}))),hasSPI=e=>D.safeParse(e).success,hasUART=e=>L.safeParse(e).success,k=u.z.object({step_pin:u.z.string(),dir_pin:u.z.string(),enable_pin:u.z.string(),diag_pin:u.z.string().optional(),endstop_pin:u.z.string().optional(),uart_pin:u.z.string().optional(),rx_pin:u.z.string().optional(),tx_pin:u.z.string().optional(),cs_pin:u.z.string().optional()}),H=k.extend({title:u.z.string(),uart_address:u.z.string().optional(),spi_bus:u.z.string().optional(),spi_software_mosi_pin:u.z.string().optional(),spi_software_miso_pin:u.z.string().optional(),spi_software_sclk_pin:u.z.string().optional()}).refine(e=>hasSPI(e)||hasUART(e),{message:"Motor slot must have either SPI or UART pins"});H.innerType().omit({title:!0}).partial();let B=u.z.string(),reversePinLookup=(e,t)=>{let r=Object.entries(t.motorSlots??{});for(let[t,i]of r)if(Object.entries(e).every(([e,t])=>i[e]===t))return t},U=u.z.string().brand("BoardID"),W=u.z.string().brand("BoardPath"),G=u.z.string().brand("BoardSerialPath"),q=u.z.record(u.z.nativeEnum(s),u.z.string()),V=u.z.record(B,H),X=u.z.object({id:U,isToolboard:u.z.boolean().optional(),isHost:u.z.boolean().optional(),serialPath:G.optional(),name:u.z.string(),manufacturer:u.z.string(),firmwareBinaryName:u.z.string(),compileScript:u.z.string(),flashScript:u.z.string().optional(),flashInstructions:u.z.string().optional(),disableAutoFlash:u.z.boolean().optional(),documentationLink:u.z.string().optional(),hasQuirksFiles:u.z.boolean().optional(),driverCount:u.z.number(),integratedDrivers:q.optional(),extruderlessConfig:u.z.string().optional(),fourPinFanConnectorCount:u.z.number().optional(),driverVoltages:v.array().default([24]),hasMcuTempSensor:u.z.boolean().default(!0),alternativePT1000Resistor:u.z.number().optional(),motorSlots:u.z.record(B,H).optional(),outputPins:u.z.array(u.z.object({pin:u.z.string(),name:u.z.string(),value:u.z.number().min(0).max(1)})).optional(),dfu:u.z.object({dfuBootImage:u.z.string(),flashDevice:u.z.string(),instructions:u.z.array(u.z.string()),reminder:u.z.string().optional(),hasBoot0Jumper:u.z.boolean()}).optional(),stepperSPI:u.z.object({software:u.z.object({sclk:u.z.string(),mosi:u.z.string(),miso:u.z.string()})}).or(u.z.object({hardware:u.z.object({bus:u.z.string()})})).optional(),ADXL345SPI:u.z.object({cs_pin:u.z.string()}).and(u.z.object({software:u.z.object({sclk:u.z.string(),mosi:u.z.string(),miso:u.z.string()})}).or(u.z.object({hardware:u.z.object({bus:u.z.string()})}))).optional(),path:W}).and(u.z.object({isToolboard:u.z.literal(!0),motorSlots:u.z.undefined()}).or(u.z.object({motorSlots:V})).or(u.z.object({isHost:u.z.literal(!0),motorSlots:u.z.undefined()}))),K=X.and(u.z.object({detected:u.z.boolean()})),Y=u.z.object({id:u.z.string(),disableAutoFlash:u.z.literal(!1).optional(),isToolboard:u.z.boolean().optional(),compileScript:u.z.string(),flashScript:u.z.string(),path:W}),Z=X.and(u.z.object({isToolboard:u.z.literal(!0),isHost:u.z.literal(!1).optional(),integratedDrivers:q.and(u.z.object({[s.extruder]:u.z.string()}))})),Q=Z.and(u.z.object({detected:u.z.boolean()}));var J=r(73292),ee=r(22037);let getScriptRoot=()=>process.env.RATOS_SCRIPT_DIR??__dirname.split("configurator/")[0]+"configurator/scripts/",replaceInFileByLine=async(e,t,r)=>{if(!(0,p.existsSync)(e))throw Error("Firmware config file does not exist: "+e);let i=(0,p.createReadStream)(e),o=(0,p.createWriteStream)(e+".tmp"),n=(0,x.createInterface)({input:i,crlfDelay:1/0});for await(let e of n){if(null==r){if(t instanceof RegExp?e.match(t):e.includes(t))continue;o.write(e+ee.EOL);continue}o.write(e.replace(t,r)+ee.EOL)}n.close(),await new Promise((e,t)=>{o.close(r=>{if(r)throw t(r);e(null)})}),await new Promise((e,t)=>{i.close(r=>{if(r)throw t(r);e(null)})}),await (0,J.copyFile)(e+".tmp",e),await (0,J.unlink)(e+".tmp")},searchFileByLine=async(e,t)=>{if(!(0,p.existsSync)(e))throw Error("Firmware config file does not exist: "+e);let r=(0,p.createReadStream)(e),i=(0,x.createInterface)({input:r,crlfDelay:1/0}),o=!1,n=0;for await(let e of i)!o&&(n++,(t instanceof RegExp?e.match(t):e.includes(t))&&(o=n));return await new Promise((e,t)=>{r.close(r=>{if(r)throw t(r);e(null)})}),o},extractLinesFromFile=async(e,t,r)=>{if(!(0,p.existsSync)(e))throw Error("Firmware config file does not exist: "+e);let i=(0,p.createReadStream)(e),o=(0,x.createInterface)({input:i,crlfDelay:1/0}),n=[],a=0;for await(let e of o)++a>=t&&a<=(r??1/0)&&n.push(e);return await new Promise((e,t)=>{i.close(r=>{if(r)throw t(r);e(null)})}),n.join("\n")};var et=r(24769),er=r.n(et);let ei=new(er())({useClones:!1}),eo=new Map,en=new(er())({useClones:!1}),ea=new Map;new Date().getTime();let cacheAsyncMetadataFn=(e,t,r)=>async i=>{let o=r.get(`${t}-${i}`);if(null==o){let o=ea.get(`${t}-${i}`);null==o&&(o=e(i),ea.set(`${t}-${i}`,o));let n=await o;return r.set(`${t}-${i}`,n),n}return o},parseMetadata=async(e,t)=>{if(""===e.trim())return null;let r=await (0,T.promisify)(m.exec)(`sed -n '/^# {/{:a; N; /\\n# }/!ba; p}' ${e}`),i=r.stdout.split("\n").map(e=>e.trim()).filter(e=>""!==e).map(e=>0===e.indexOf("#")?e.substring(1):e);if(0===i.length)return null;try{let r=JSON.parse(i.join("\n"));r.path=e;let o=e.split("/").pop();if(null==o)throw Error("File name couldn't be parsed from path: "+e);return r.id=o.replace(/\.cfg$/g,""),t.parse(r)}catch(t){throw t instanceof Error&&getLogger().error(t.message),Error("Failed to parse JSON from file: "+e+" with content: "+i.join("\n"))}},parsePinValue=e=>{if(!("null"===e||e.startsWith("<")&&e.endsWith(">")))return e},es=cacheAsyncMetadataFn(async e=>{let t=getScriptRoot(),r=await (0,T.promisify)(m.exec)(`python3 ${z().join(t,"initojson.py")} ${e}`),i=JSON.parse(r.stdout);if(null==i)throw Error("Failed to parse config file: "+e);let o=Object.keys(i).find(e=>e.startsWith("board_pins"));if(null==o)throw Error("Failed to find board pin section in config file: "+e);let n=i[o].aliases.map(e=>e.replace(",","")),a=i[o].aliases.filter(e=>!e.includes("="));if(a.length>0)throw Error('Board pin aliases do not parse correctly, got "'+a.join(", ")+'"');let s={};return n.forEach(e=>{let t=e.split("=");if(t.length>2)throw Error('Board pin aliases do not parse correctly, got "'+e+'"');s[t[0]]=parsePinValue(t[1])}),s},"parsePinAlias",en),parseBoardPinConfig=async(e,t)=>{let r=z().join(e.path,e.isToolboard?"toolboard-config.cfg":t&&null!=e.extruderlessConfig?e.extruderlessConfig:"config.cfg"),i=e.isToolboard?I:t?M:j;return i.parse(await es(r))};cacheAsyncMetadataFn(async e=>{if(!(0,p.existsSync)(e))throw Error("Firmware config file does not exist: "+e);let t=(0,p.createReadStream)(e),r=(0,x.createInterface)({input:t,crlfDelay:1/0}),i='CONFIG_MCU="';for await(let e of r)if(e.startsWith(i))return e.substring(i.length,e.length-2);throw Error("Failed to find MCU in firmware config file: "+e)},"extractMcuFromFirmwareConfig",en);let el=(i=e=>{let t=h.parse(process.env),r=z().join(t.RATOS_CONFIGURATION_PATH,"extruders",e+".cfg"),i=getScriptRoot(),o=(0,m.execSync)(`python3 ${z().join(i,"initojson.py")} ${r}`),n=JSON.parse(o.toString());if(null==n)throw Error("Failed to parse config file: "+r);let a=Object.keys(n).find(e=>e.startsWith("extruder"));if(null==a)throw Error("Failed to find extruder section in config file: "+r);let s=n[a];if(null==s||null==s.rotation_distance)throw Error("Failed to find extruder rotation distance");return s.rotation_distance},o="getExtruderRotationDistance",e=>{let t=en.get(`${o}-${e}`);if(null==t){let t=i(e);return en.set(`${o}-${e}`,t),t}return t}),readInclude=e=>{let t=h.parse(process.env),r=z().join(t.RATOS_CONFIGURATION_PATH,e);if(!(0,p.existsSync)(r))throw Error("Included file doesn't exist: "+e);return(0,p.readFileSync)(r,"utf-8")},stripIncludes=e=>stripLinesStartingWith(e,"[include"),stripCommentLines=e=>stripLinesStartingWith(e,"#"),stripLinesStartingWith=(e,t)=>e.split("\n").filter(e=>!e.trim().startsWith(t)).join("\n"),stripDriverSections=e=>{let t=!1;return e.split("\n").map(e=>{if(e.trim().startsWith("[tmc")&&(t=!0),t){if(!e.trim().startsWith("["))return null;t=!1}return e}).filter(e=>null!=e).join("\n")},replaceLinesStartingWith=(e,t,r)=>e.split("\n").map(e=>e.trim().startsWith(t)?r:e).join("\n"),ed=["EPCOS 100K B57560G104F","ATC Semitec 104GT-2","ATC Semitec 104NT-4-R025H42G","Generic 3950","Honeywell 100K 135-104LAG-J01","NTC 100K MGB18-104F39050L32","SliceEngineering 450","TDK NTCG104LH104JT1","PT1000"],ep="";if(process.env.RATOS_CONFIGURATION_PATH){let e=h.parse(process.env);ep=e.RATOS_CONFIGURATION_PATH}let ec=u.z.object({path:u.z.string().startsWith(ep).endsWith(".cfg"),id:u.z.string()}),eu=u.z.enum(ed),eh=ec.extend({type:u.z.literal("hotend"),title:u.z.string(),thermistor:u.z.enum(ed),flowType:u.z.union([u.z.literal("sf"),u.z.literal("hf"),u.z.literal("uhf")])}),eg=u.z.object({type:u.z.enum(["Regular","CHT"]),diameter:u.z.number().min(.2).max(1.8)}),e_=ec.extend({type:u.z.literal("extruder"),stepper:S.shape.id.optional(),current:C.shape.current.optional(),title:u.z.string()}),ef=ec.extend({type:u.z.literal("static-probe").or(u.z.literal("stowable-probe")),title:u.z.string()}),em=u.z.object({id:u.z.enum(["endstop","endstop-toolboard","sensorless"]),title:u.z.string()}),eb=u.z.object({id:u.z.enum(["toolboard","controlboard","sbc","none"]),title:u.z.string()}),ez=u.z.object({id:u.z.enum(["2pin","4pin","4pin-dedicated","2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard","none"]),title:u.z.string()}),getDefaultNozzle=()=>({diameter:.4,type:"Regular"}),ex=u.z.object({hotend:eh,thermistor:eu,extruder:e_,xEndstop:em,yEndstop:em,hotendFan:ez,partFan:ez,nozzle:eg.default(getDefaultNozzle()),xAccelerometer:eb.optional().nullable(),yAccelerometer:eb.optional().nullable(),toolboard:Z.nullable(),probe:ef.optional(),axis:u.z.literal(s.x).or(u.z.literal(s.dual_carriage)),description:u.z.string().optional(),toolNumber:u.z.number().optional()}).strict(),eT=u.z.union([u.z.literal(0),u.z.literal(1)]),ev=u.z.union([u.z.literal(s.x),u.z.literal(s.dual_carriage),u.z.literal(s.extruder),u.z.literal(s.extruder1)]),ey=u.z.union([ev,eT]),eP=ex.refine(e=>null!==e.toolboard||"endstop-toolboard"!==e.xEndstop.id,"Cannot use toolboard endstop without a toolboard").refine(e=>null!==e.toolboard||!["2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard"].includes(e.hotendFan.id),"Cannot use toolboard hotend fan without a toolboard").refine(e=>null!==e.toolboard||!["2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard"].includes(e.partFan.id),"Cannot use toolboard part cooling fan without a toolboard"),eS=ex.partial().optional(),eR=ex.extend({hotend:eh.shape.id,extruder:e_.shape.id,thermistor:eu,xEndstop:em.shape.id,yEndstop:em.shape.id,hotendFan:ez.shape.id,partFan:ez.shape.id,xAccelerometer:eb.shape.id.optional().nullable(),yAccelerometer:eb.shape.id.optional().nullable(),toolboard:U.optional().nullable(),probe:ef.shape.id.optional().nullable()}).strict(),eC=eR.partial().optional(),ew="";if(process.env.RATOS_CONFIGURATION_PATH){let e=h.parse(process.env);ew=z().join(e.RATOS_CONFIGURATION_PATH,"printers")}let eE=u.z.object({velocity:u.z.number().min(0).describe("Maximum velocity for this printer"),accel:u.z.number().min(0).describe("Maximum acceleration for this printer"),z_velocity:u.z.number().min(0).describe("Maximum z velocity for this printer"),z_accel:u.z.number().min(0).describe("Maximum z acceleration for this printer"),square_corner_velocity:u.z.number().min(0).default(5).describe("Maximum square corner velocity for this printer"),travel_velocity:u.z.number().min(0).default(200).describe("Maximum travel velocity for this printer"),travel_accel:u.z.number().min(0).default(3e3).describe("Maximum travel velocity for this printer")}).strict(),eA=u.z.object({x:u.z.number().min(0).describe("The print volume in X"),y:u.z.number().min(0).describe("The print volume in Y"),z:u.z.number().min(0).describe("The print volume in Z")}).describe("The print volume of a printer"),eN=u.z.object({id:u.z.string(),name:u.z.string().describe("The name of the printer"),description:u.z.string().describe("A description of the printer"),manufacturer:u.z.string().describe("The name of the manufacturer of this printer"),documentationLink:u.z.string().describe("Link to the RatOS documentation for this printer"),image:u.z.string().describe("Link to an image of the printer"),sizes:u.z.record(u.z.string(),eA).describe("Size options for this printer"),template:u.z.string().describe("Printer.cfg template for this printer"),path:u.z.string().startsWith(ew),driverCountRequired:u.z.number().describe("Number of drivers required for this printer"),kinematics:u.z.union([u.z.literal("cartesian"),u.z.literal("corexy"),u.z.literal("hybrid-corexy"),u.z.literal("hybrid-corexy-idex")]).optional(),bedMargin:u.z.object({x:u.z.tuple([u.z.number().default(0),u.z.number().default(0)]),y:u.z.tuple([u.z.number().default(0),u.z.number().default(0)])}).describe("Margin of available movement around the bed for this printer").default({x:[0,0],y:[0,0]}),speedLimits:u.z.object({basic:eE,performance:eE.optional()}).strict().describe("Speed limits for this printer"),defaults:u.z.object({toolheads:u.z.array(eR).describe("Default toolheads for this printer"),board:U.describe("Default board for this printer. Should be the name of the board directory."),rails:u.z.array(w).describe("Default rails for this printer"),controllerFan:ez.shape.id.optional().describe("Default controller fan for this printer")}).strict().describe("Default hardware for this printer")}).describe("A RatOS supported 3d printer"),eO=eN.extend({defaults:eN.shape.defaults.extend({toolheads:u.z.array(eP)}).strict()}),e$=u.z.array(y).parse([{id:"BTT-TMC2209-13",title:"BTT TMC2209 v1.3",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"BTT-TMC2226-10",title:"BTT TMC2226 v1.0",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"BTT-TMC5160-PRO-11",title:"BTT TMC5160(T) Pro v1.1",type:"TMC5160",protocol:"SPI",senseResistor:.075,voltages:[24,36,48,56],maxCurrent:3,coolingCurrentThreshold:1.5},{id:"BTT-TMC5160T-PLUS-10",title:"BTT TMC5160T Plus v1.0",type:"TMC5160",protocol:"SPI",senseResistor:.022,voltages:[24,36,48,56,60],maxCurrent:10.6,coolingCurrentThreshold:3,external:!0},{id:"BTT-EZ2209",title:"BTT EZ2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.3,voltages:[24],maxCurrent:2},{id:"BTT-EZ2226",title:"BTT EZ2226",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.3,voltages:[24],maxCurrent:2},{id:"BTT-EZ2130",title:"BTT EZ2130",type:"TMC2130",protocol:"SPI",senseResistor:.11,coolingCurrentThreshold:.9,voltages:[24],maxCurrent:2},{id:"BTT-EZ5160-PRO",title:"BTT EZ5160 Pro",type:"TMC5160",protocol:"SPI",senseResistor:.075,coolingCurrentThreshold:1.6,voltages:[24,36,48],maxCurrent:2.5},{id:"BTT-EZ5160-RGB",title:"BTT EZ5160 RGB",type:"TMC5160",protocol:"SPI",senseResistor:.05,coolingCurrentThreshold:3,voltages:[24,48,36,56],maxCurrent:4.7},{id:"MELLOW-FLY-HV-TMC5160-PRO-12",title:"Mellow FLY HV TMC5160 Pro v1.2",type:"TMC5160",protocol:"SPI",senseResistor:.033,coolingCurrentThreshold:3,voltages:[24,36,48],maxCurrent:4.25,external:!0},{id:"MELLOW-FLY-TMC2209",title:"Mellow FLY TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"PRUSA-EINSY-RAMBO-TMC2130",title:"Prusa Einsy Rambo TMC2130",type:"TMC2130",protocol:"SPI",senseResistor:.22,coolingCurrentThreshold:.9,voltages:[24],maxCurrent:2},{id:"PRUSA-BUDDY-TMC2209",title:"Prusa Buddy TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2}]),findPreset=(e,t,r,i,o)=>e.presets?.slice().sort((e,t)=>o?t.run_current-e.run_current:e.run_current-t.run_current).find(e=>e.driver===t.type&&e.voltage===r&&e.sense_resistor===t.senseResistor&&(null==i||e.run_current===i)),eF=u.z.array(S).parse([{id:"generic",title:"Generic Stepper",maxPeakCurrent:2.8},{id:"BONDTECH-42H025H-0704-002",title:"Bondtech LGX Stepper",maxPeakCurrent:.7},{id:"LDO-42STH48-2504AC",title:"LDO-42STH48-2504AC",maxPeakCurrent:2.5,presets:[{run_current:1.1,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:1,driver_TOFF:3,driver_HEND:0,driver_HSTRT:0},{run_current:1.6,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:2,driver_TOFF:3,driver_HEND:0,driver_HSTRT:6},{run_current:1.6,voltage:24,driver:"TMC5160",sense_resistor:.075,driver_TBL:2,driver_TOFF:3,driver_HEND:0,driver_HSTRT:6},{run_current:1.768,voltage:48,driver:"TMC5160",sense_resistor:.075,driver_TBL:0,driver_TOFF:4,driver_HEND:0,driver_HSTRT:4}]},{id:"LDO-42STH40-1684AC",title:"LDO-42STH40-1684AC",maxPeakCurrent:1.68,presets:[{run_current:.4,voltage:24,driver:"TMC2130",sense_resistor:.22,driver_IHOLDDELAY:8,driver_TPOWERDOWN:0,driver_TBL:2,driver_TOFF:3,driver_HEND:1,driver_HSTRT:5,driver_PWM_FREQ:2,driver_PWM_GRAD:2,driver_PWM_AMPL:230,driver_PWM_AUTOSCALE:!0,driver_SGT:5},{run_current:.52,voltage:24,driver:"TMC2130",sense_resistor:.22,driver_IHOLDDELAY:8,driver_TPOWERDOWN:0,driver_TBL:2,driver_TOFF:3,driver_HEND:1,driver_HSTRT:5,driver_PWM_FREQ:2,driver_PWM_GRAD:4,driver_PWM_AMPL:240,driver_PWM_AUTOSCALE:!0,driver_SGT:3},{run_current:.8,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:1,driver_TOFF:3,driver_HEND:3,driver_HSTRT:0},{run_current:1.188,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:0,driver_TOFF:3,driver_HEND:0,driver_HSTRT:0}]},{id:"LDO-42STH48-2004MAH",title:"LDO-42STH48-2004MAH",maxPeakCurrent:2,fullStepsPerRotation:400},{id:"LDO-42STH48-2004AC",title:"LDO-42STH48-2004AC",maxPeakCurrent:2},{id:"LDO-42STH25-1404MAC",title:"LDO-42STH25-1404MAC",maxPeakCurrent:1.4,fullStepsPerRotation:400,presets:[{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:.85,driver_TBL:1,driver_TOFF:3,driver_HEND:2,driver_HSTRT:0}]},{id:"LDO-42STH25-1004CL200E",title:"LDO-42STH25-1004CL200E",maxPeakCurrent:1},{id:"LDO-36STH20-1004AHG",title:"LDO-36STH20-1004AHG",maxPeakCurrent:1,presets:[{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:.707,driver_TBL:0,driver_HEND:6,driver_HSTRT:7,driver_TOFF:4}]},{id:"LDO-36STH17-1004AHG",title:"LDO-36STH17-1004AHG",maxPeakCurrent:1},{id:"LDO-35STH48-1684AH",title:"LDO-35STH48-1684AH",maxPeakCurrent:1.68}]),deserializeDriver=e=>e$.find(t=>t.id===e)??null,deserializeStepper=e=>eF.find(t=>t.id===e)??null,deserializePrinterRail=e=>{let t=deserializeStepper(e.stepper),r=deserializeDriver(e.driver);if(null==t)throw Error(`Stepper ${e.stepper} not found in database`);if(null==r)throw Error(`Driver ${e.driver} not found in database`);return R.parse({...e,stepper:t,driver:r})},deserializePrinterRailDefinition=e=>{let t=deserializeStepper(e.stepper),r=deserializeDriver(e.driver);if(null==t)throw Error(`Stepper ${e.stepper} not found in database`);if(null==r)throw Error(`Driver ${e.driver} not found in database`);return C.parse({...e,stepper:t,driver:r})},stringToTitleObject=e=>({id:e,title:e}),serializeToolheadConfiguration=e=>({...e,toolboard:e.toolboard?.id,hotend:e.hotend.id,thermistor:e.thermistor,extruder:e.extruder.id,probe:e.probe?.id,xEndstop:e.xEndstop.id,yEndstop:e.yEndstop.id,partFan:e.partFan.id,hotendFan:e.hotendFan.id,xAccelerometer:e.xAccelerometer?.id,yAccelerometer:e.yAccelerometer?.id}),extractToolheadsFromPrinterConfiguration=e=>{let t=e?.toolheads?.map(e=>{if(null==e)throw Error("Toolhead can not be null");return new ToolheadHelper(eP.parse(e))}).filter(Boolean);if(null==t)throw Error("No toolheads found");return t},extractToolheadFromPrinterConfiguration=(e,t)=>{if(t?.toolheads==null||0===t.toolheads.length)throw Error("No toolheads preset in supplied printer config");let r=extractToolheadsFromPrinterConfiguration(t),i="number"==typeof e?r.find(t=>t.getTool()===e):r.find(t=>t.getExtruderAxis()===e||t.getMotionAxis()===e);return i};var ej=r(43699),eM=r.n(ej);let ToolheadHelper=class ToolheadHelper{constructor(e){this.config=e}hasToolboard(){return null!=this.config.toolboard}getToolboard(){return this.config.toolboard}getMotionStepperName(){return this.config.axis===s.dual_carriage?"dual_carriage":`stepper_${this.getMotionAxis()}`}getToolboardName(){if(null==this.config.toolboard)throw Error(`Toolhead T${this.getTool()} does not have a toolboard`);return`toolboard_${this.getShortToolName()}`}getShortToolName(){return`t${this.getTool()}`}getDescription(){return this.config.description??"the printer's toolhead"}getMotionAxis(){return this.config.axis===s.dual_carriage?s.dual_carriage:s.x}getExtruderAxis(){return this.config.axis===s.dual_carriage?s.extruder1:s.extruder}getToolCommand(){return`T${this.getTool()}`}getTool(){return this.config.axis===s.dual_carriage?1:0}getSerialSuffix(){return`t${this.getTool()}`}getExtruder(){return this.config.extruder}getHotend(){return this.config.hotend}getNozzle(){return this.config.nozzle??getDefaultNozzle()}getThermistor(){return this.config.thermistor}getXEndstop(){return this.config.xEndstop}getYEndstop(){return this.config.yEndstop}getXAccelerometer(){return this.config.xAccelerometer}getYAccelerometer(){return this.config.yAccelerometer}getXAccelerometerName(){switch(this.getXAccelerometer()?.id){case"controlboard":return"controlboard";case"toolboard":if(this.hasToolboard())return this.getToolboardName();case"sbc":return"rpi";default:return"controlboard"}}getYAccelerometerName(){switch(this.getYAccelerometer()?.id){case"controlboard":return"controlboard";case"toolboard":if(this.hasToolboard())return this.getToolboardName();case"sbc":return"rpi";default:return"controlboard"}}getChangeSet(e){if(null==e)return null;let t={};Object.keys(e).forEach(r=>{let i=this.getConfig()[r],o=e[r];if(null!=i&&null==o||null==i&&null!=o){t[r]=o;return}i&&o&&("object"==typeof i&&"id"in i&&"object"==typeof o&&"id"in o?i.id!==o.id&&(t[r]=o):eM()(i,o)||(t[r]=o))});let r=eS.safeParse(t);return r}getProbe(){return this.config.probe}getPartFan(){return this.config.partFan}getHotendFan(){return this.config.hotendFan}serialize(){return serializeToolheadConfiguration(this.config)}getConfig(){return{...this.config}}};let eI=u.z.union([eA,u.z.number(),u.z.string()]).nullable().optional(),eL=u.z.object({printer:eN,controlboard:X,toolheads:u.z.array(eP).min(1).max(2),size:eI,controllerFan:ez,performanceMode:u.z.boolean().default(!1),stealthchop:u.z.boolean().default(!1),standstillStealth:u.z.boolean().default(!1),rails:u.z.array(E)}).strict().transform((e,t)=>{if(null==e.size)e.size=e.printer.sizes[Object.keys(e.printer.sizes)[0]];else if("number"==typeof e.size||"string"==typeof e.size){let r=e.printer.sizes[e.size.toString()];if(null==r)return t.addIssue({code:u.z.ZodIssueCode.custom,message:`Size ${e.size} is not a valid size for a ${e.printer.name} config`}),u.z.NEVER;e.size=r}return e}),eD=eL.superRefine((e,t)=>{let r=e.toolheads.map(e=>e.toolboard).filter(Boolean).length;r+e.controlboard.driverCount<e.printer.driverCountRequired&&t.addIssue({code:u.z.ZodIssueCode.too_small,message:`Your combination of controlboard and toolboards do not have enough stepper drivers for a ${e.printer.name} config`,minimum:e.printer.driverCountRequired,inclusive:!0,type:"number"})}).superRefine((e,t)=>{let r=e.toolheads.map(e=>new ToolheadHelper(e)),i=e.rails.map((i,o)=>{let n=r.find(e=>e.getExtruderAxis()===i.axis);if(null!=i.motorSlot){let a=e.rails.filter(e=>{let t=r.find(t=>t.getExtruderAxis()===e.axis);return e.axis!==i.axis&&n?.hasToolboard()==null&&t?.hasToolboard==null&&e.motorSlot===i.motorSlot}),railName=e=>"extruder"===e?"Extruder T0":e===s.extruder1?"Extruder T1":"Stepper "+e.toLocaleUpperCase();return 1===a.length?t.addIssue({code:u.z.ZodIssueCode.custom,message:`Motor slot ${i.motorSlot} is already in use on ${railName(a[0].axis)}`,path:["rails",o,"motorSlot"]}):a.length>1&&t.addIssue({code:u.z.ZodIssueCode.custom,message:`Motor slot ${i.motorSlot} is already in use on ${a.slice(0,-1).map(e=>railName(e.axis)).join(", ")} and ${railName(a[a.length-1].axis)}`,path:["rails",o,"motorSlot"]}),a.length>0?{rail:i,conflicts:a}:0}return null}).filter(Boolean);i.length>0&&t.addIssue({code:u.z.ZodIssueCode.custom,message:"Motor slot conflicts detected"})}),ek=eL.innerType().extend({printer:eN.shape.id,controlboard:U,toolheads:u.z.array(eR).min(1).max(2),controllerFan:ez.shape.id,rails:u.z.array(A)}).strict(),eH=eL.innerType().extend({toolheads:u.z.array(eS).min(1).max(2)}).strict().partial().optional(),eB=ek.extend({toolheads:u.z.array(eC).min(1).max(2)}).strict().partial(),xEndstopOptions=(e,t)=>{let r=[];return t?.toolboard!=null&&r.push({id:"endstop-toolboard",title:"Physical Endstop (toolboard)"}),t?.axis===s.x&&(r.push({id:"endstop",title:"Physical Endstop"}),r.push({id:"sensorless",title:"Sensorless Homing"})),r},yEndstopOptions=(e,t)=>[{id:"endstop",title:"Physical Endstop"},{id:"sensorless",title:"Sensorless Homing"}],sensorlessXTemplate=(e,t)=>`
# Sensorless homing.
#
# Tune the sensorless_x_current variable and the SGTHRS/SGT value in this file untill you get reliable homing.
# Beware of false instant triggering which can make it look like the homing procedure is skipping an axis, when in fact it's not.
# This is especially true for the Y axis on CoreXY machines.
#
# Read the klipper documentation for more info: https://www.klipper3d.org/TMC_Drivers.html#sensorless-homing
#
# Note: if your board has diag jumpers, you would need to insert them for the specific drivers you want to use for sensorless homing on.
# Note: Sensorless homing does NOT work if you drivers have a missing DIAG pins.    
# Check https://www.klipper3d.org/TMC_Drivers.html#sensorless-homing for tuning instructions.

[${t.getAxisDriverSectionName(s.x)}]
${t.getAxisDriverDiagConfig(s.x)}
${t.getAxisDriverStallGuardThreshold(s.x,.5)}

[${t.getAxisStepperName(s.x)}]
endstop_pin: ${t.getAxisVirtualEndstop(s.x)}
homing_retract_dist: 0

[gcode_macro RatOS]
variable_homing_x: "sensorless"
variable_sensorless_x_current: ${t.getAxisDriverHomingCurrent(s.x,.35)}
`,sensorlessYTemplate=(e,t)=>`
# Sensorless homing.
#
# Tune the current variable and the SGTHRS value in the included file(s) untill you get reliable homing.
# Beware of false instant triggering which can make it look like the homing procedure is skipping an axis, when in fact it's not.
# This is especially true for the Y axis on CoreXY machines.
#
# Read the klipper documentation for more info: https://www.klipper3d.org/TMC_Drivers.html#sensorless-homing
#
# Note: if your board has diag jumpers, you would need to insert them for the specific drivers you want to use for sensorless homing on.
# Note: Sensorless homing does NOT work if you drivers have a missing DIAG pins.
# Check https://www.klipper3d.org/TMC_Drivers.html#sensorless-homing for tuning instructions.

[${t.getAxisDriverSectionName(s.y)}]
${t.getAxisDriverDiagConfig(s.y)}
${t.getAxisDriverStallGuardThreshold(s.y,.5)}

[stepper_y]
endstop_pin: ${t.getAxisVirtualEndstop(s.y)}
homing_retract_dist: 0

[gcode_macro RatOS]
variable_homing_y: "sensorless"
variable_sensorless_y_current: ${t.getAxisDriverHomingCurrent(s.y,.51)}
`,getBoardSerialPath=(e,t)=>e.isHost&&"serialPath"in e&&null!=e.serialPath?e.serialPath:"/dev/RatOS/"+getBoardChipId(e,t),getBoardChipId=(e,t)=>{if(e.isHost)throw Error("Cannot get chip ID for a host board");return e.id+(t?`-${t.getSerialSuffix()}`:"")};let ToolheadGenerator=class ToolheadGenerator extends ToolheadHelper{static async fromConfig(e,t,r,i){let o=e.toolboard?await parseBoardPinConfig(e.toolboard):null;return new ToolheadGenerator(e,o,t,r,i)}constructor(e,t,r,i,o){super(e),this.toolboardPins=t,this.controlboardPins=r,this.printer=i,this.size=o}requireControlboardPin(e){if(this.controlboardPins?.[e]==null)throw Error(`Toolhead ${this.getTool()} is configured to use the controlboard for ${e}, but the controlboard does not define a pin with that name.`)}requireToolboardPin(e){if(this.toolboardPins?.[e]==null)throw Error(`Toolhead ${this.getTool()} is configured to use the toolboard for ${e}, but the toolboard does not define a pin with that name.`)}getExtruderToolAxisPinPrefix(){return 0===this.getTool()?"":this.getTool()}getToolboardPins(){if(null==this.toolboardPins)throw Error(`Toolboard pins not available for toolhead ${this.getToolCommand()}`);return this.toolboardPins}getToolheadPin(e,t){let r=e===this.getExtruderAxis()?this.getPinPrefix():"",i=e===s.z?"z0":e!==this.getExtruderAxis()?e:null!=this.getToolboard()?"e":"e"+this.getExtruderToolAxisPinPrefix(),o=i+t,n=null;try{n=this.getPinFromAlias(o)}catch(e){n=null}if(null==n)throw Error(`Pin name "${o}" constructed from axis "${e}" and alias "${t}" not found on toolhead ${this.getToolCommand()} with extruder axis ${this.getExtruderAxis()}. Resolved axis alias ${i}. Searched in ${this.getToolboard()?"toolboard":"controlboard"}`);return r+n}getPinFromAlias(e){let t=null;if(this.getToolboard()){if(this.toolboardPins?.[e]!=null)t=this.toolboardPins[e];else throw Error(`Alias "${e}" not found in toolboard pin definition.`)}else this.controlboardPins?.[e]!=null&&(t=this.controlboardPins[e]);if(null!=t)return t;throw Error(`Unknown pin alias ${e}`)}getPinFromToolboardAlias(e){let t=null,r="e1"===e.split("_")[0]?"e"+this.getExtruderToolAxisPinPrefix():e;if(!this.hasToolboard())throw Error(`Toolhead ${this.getTool()} is not configured to use a toolboard`);if(this.toolboardPins?.[r]!=null)t=this.toolboardPins[r];else throw Error(`Alias "${r}" not found in toolboard pin definition.`);if(null!=t)return t;throw Error(`Unknown pin alias ${r}`)}getXEndstopPin(){let e;switch(this.getXEndstop().id){case"endstop":if(this.controlboardPins?.x_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use the controlboard for the x endstop, but the controlboard has no x_endstop_pin`);e=this.controlboardPins.x_endstop_pin;break;case"endstop-toolboard":if(this.toolboardPins?.x_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use a toolboard for the x endstop, but the toolboard has no x_endstop_pin`);e=this.getPinPrefix()+this.toolboardPins.x_endstop_pin;break;default:throw Error(`Unknown endstop type ${this.getXEndstop().id}`)}return e}getYEndstopPin(){let e;switch(this.getYEndstop().id){case"endstop":if(this.controlboardPins?.y_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use the controlboard for the x endstop, but the controlboard has no y_endstop_pin`);e=this.controlboardPins.y_endstop_pin;break;case"endstop-toolboard":if(this.toolboardPins?.y_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use a toolboard for the x endstop, but the toolboard has no y_endstop_pin`);e=this.getPinPrefix()+this.toolboardPins.y_endstop_pin;break;default:throw Error(`Unknown endstop type ${this.getXEndstop().id}`)}return e}getPinPrefix(){return this.config.toolboard?`${this.getToolboardName()}:`:""}renderToolboard(e){let t=this.toolboardPins,r=this.config.toolboard;if(null==r||null==t)return"";if(null==e)throw Error("exportPinsFn is required when rendering toolboard");let i=["",e(this.getToolboardName(),r,this,this.getToolboardName()),"",`[mcu ${this.getToolboardName()}]`,`serial: ${getBoardSerialPath(r,this)}`];return r.hasMcuTempSensor&&(i.push(""),i.push(`[temperature_sensor ${r.name.replace(/\s/g,"_")}_${this.getToolCommand()}]`),i.push("sensor_type: temperature_mcu"),i.push(`sensor_mcu: ${this.getToolboardName()}`)),null!=r.ADXL345SPI&&(i.push(""),i.push(`[adxl345 ${this.getToolboardName()}]`),i.push(`cs_pin: ${this.getPinPrefix()}${r.ADXL345SPI.cs_pin}`),"hardware"in r.ADXL345SPI?i.push(`spi_bus: ${r.ADXL345SPI.hardware.bus}`):(i.push(`spi_software_mosi_pin: ${this.getPinPrefix()}${r.ADXL345SPI.software.mosi}`),i.push(`spi_software_miso_pin: ${this.getPinPrefix()}${r.ADXL345SPI.software.miso}`),i.push(`spi_software_sclk_pin: ${this.getPinPrefix()}${r.ADXL345SPI.software.sclk}`))),null!=r.outputPins&&r.outputPins.forEach(e=>{i.push(""),i.push(`[output_pin ${e.name}]`),i.push(`pin: ${this.getPinPrefix()}${e.pin}`),i.push(`value: ${e.value}`)}),i.join("\n")}renderHotend(){let e=[],t=readInclude(`hotends/${this.getHotend().id}.cfg`);return t=replaceLinesStartingWith(t=stripIncludes(t=stripCommentLines(t)),"[extruder]",`[${this.getExtruderAxis()}]`),t=replaceLinesStartingWith(t,"heater_pin",`heater_pin: ${this.getToolheadPin(this.getExtruderAxis(),"_heater_pin")}`),t=replaceLinesStartingWith(t,"sensor_pin",`sensor_pin: ${this.getToolheadPin(this.getExtruderAxis(),"_sensor_pin")}`),t=(t="PT1000"===this.getThermistor()&&this.getToolboard()?.alternativePT1000Resistor!=null?t.split("\n").some(e=>e.trim().startsWith("pullup_resistor"))?replaceLinesStartingWith(t,"pullup_resistor",`pullup_resistor: ${this.getToolboard()?.alternativePT1000Resistor}`):replaceLinesStartingWith(t,"sensor_type",`sensor_type: ${this.getThermistor()}
pullup_resistor: ${this.getToolboard()?.alternativePT1000Resistor}`):replaceLinesStartingWith(t,"sensor_type",`sensor_type: ${this.getThermistor()}`)).split("\n").some(e=>e.trim().startsWith("nozzle_diameter"))?replaceLinesStartingWith(t,"nozzle_diameter",`nozzle_diameter: ${this.getNozzle().diameter}`):replaceLinesStartingWith(t,`[${this.getExtruderAxis()}]`,`[${this.getExtruderAxis()}]
nozzle_diameter: ${this.getNozzle().diameter}`),e.push(`# ${this.getToolCommand()} ${this.getHotend().title} definition (from RatOS/hotends/${this.getHotend().id}.cfg)`),e.push(t.trim()),e.join("\n")}renderExtruder(){let e=[];e.push(`# ${this.getToolCommand()} ${this.getExtruder().title} definition (from RatOS/extruders/${this.getExtruder().id}.cfg)`);let t=stripCommentLines(stripIncludes(stripDriverSections(readInclude(`extruders/${this.getExtruder().id}.cfg`))));return e.push((t=replaceLinesStartingWith(t,"[extruder]",`[${this.getExtruderAxis()}]`)).trim()),e.join("\n")}renderPartFan(e=!1){let t=[];if(e){let e=`part_fan_${this.getShortToolName()}`;t.push(`[fan_generic ${e}]`)}else t.push("[fan]");switch(this.getPartFan().id){case"2pin":this.requireControlboardPin("fan_part_cooling_pin"),t.push("# 2-pin fan connected to the controller board"),t.push(`pin: ${this.controlboardPins?.fan_part_cooling_pin}`);break;case"4pin":this.requireControlboardPin("fan_part_cooling_pin"),t.push("# 4-pin fan connected to the controller board"),t.push(`pin: !${this.controlboardPins?.fan_part_cooling_pin}`),t.push("cycle_time:  0.00004");break;case"4pin-dedicated":this.requireControlboardPin("4p_fan_part_cooling_pin"),t.push("# 4-pin fan connected to a dedicated 4-pin fan header on the controller board"),t.push(`pin: ${this.controlboardPins?.["4p_fan_part_cooling_pin"]}`),t.push("cycle_time:  0.00004"),this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]!=null&&(t.push(`tachometer_pin: ${this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]}`),t.push("tachometer_poll_interval: 0.0005"));break;case"2pin-toolboard":this.requireToolboardPin("fan_part_cooling_pin"),t.push(`# 2-pin fan connected to the toolboard on T${this.getTool()} (${this.getToolboardName()})`),t.push(`pin: ${this.getPinPrefix()}${this.toolboardPins?.fan_part_cooling_pin}`);break;case"4pin-toolboard":this.requireToolboardPin("fan_part_cooling_pin"),t.push(`# 4-pin fan connected to the toolboard on T${this.getTool()} (${this.getToolboardName()})`),t.push(`pin: !${this.getPinPrefix()}${this.toolboardPins?.fan_part_cooling_pin}`),t.push("cycle_time:  0.00004");break;case"4pin-dedicated-toolboard":this.requireToolboardPin("4p_fan_part_cooling_tach_pin"),t.push(`# 4-pin fan connected to a dedicated 4-pin fan header on the toolboard on T${this.getTool()} (${this.getToolboardName()})`),t.push(`pin: ${this.getPinPrefix()}${this.toolboardPins?.["4p_fan_part_cooling_tach_pin"]}`),t.push("cycle_time:  0.00004"),this.toolboardPins?.["4p_fan_part_cooling_tach_pin"]!=null&&(t.push(`tachometer_pin: ${this.toolboardPins?.["4p_fan_part_cooling_tach_pin"]}`),t.push("tachometer_poll_interval: 0.0005"));break;default:throw Error(`Unsupported part cooling fan option "${this.getHotendFan().title}"`)}return t.join("\n")}renderHotendFan(){let e=[`[heater_fan toolhead_cooling_fan${this.getTool()>0?`_${this.getShortToolName()}`:""}]`,`heater: ${this.getExtruderAxis().toLocaleLowerCase()}`];switch(this.getHotendFan().id){case"2pin":this.requireControlboardPin("fan_toolhead_cooling_pin"),e.push("# 2-pin fan connected to the controller board"),e.push(`pin: ${this.controlboardPins?.fan_toolhead_cooling_pin}`);break;case"4pin":this.requireControlboardPin("fan_toolhead_cooling_pin"),e.push("# 4-pin fan connected to the controller board"),e.push(`pin: !${this.controlboardPins?.fan_toolhead_cooling_pin}`),e.push("cycle_time:  0.00004");break;case"4pin-dedicated":this.requireControlboardPin("4p_fan_part_cooling_tach_pin"),e.push("# 4-pin fan connected to a dedicated 4-pin fan header on the controller board"),e.push(`pin: ${this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]}`),e.push("cycle_time:  0.00004"),this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]!=null&&(e.push(`tachometer_pin: ^${this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]}`),e.push("tachometer_poll_interval: 0.0005"));break;case"2pin-toolboard":this.requireToolboardPin("fan_toolhead_cooling_pin"),e.push(`# 2-pin fan connected to the toolboard on T${this.getTool()} (${this.getToolboardName()})`),e.push(`pin: ${this.getPinPrefix()}${this.toolboardPins?.fan_toolhead_cooling_pin}`);break;case"4pin-toolboard":this.requireToolboardPin("fan_toolhead_cooling_pin"),e.push(`# 4-pin fan connected to the toolboard on T${this.getTool()} (${this.getToolboardName()})`),e.push(`pin: !${this.getPinPrefix()}${this.toolboardPins?.fan_toolhead_cooling_pin}`),e.push("cycle_time:  0.00004");break;case"4pin-dedicated-toolboard":this.requireToolboardPin("4p_toolhead_cooling_pin"),e.push(`# 4-pin fan connected to a dedicated 4-pin fan header on the toolboard on T${this.getTool()} (${this.getToolboardName()})`),e.push(`pin: ${this.getPinPrefix()}${this.toolboardPins?.["4p_toolhead_cooling_pin"]}`),e.push("cycle_time:  0.00004"),this.toolboardPins?.["4p_toolhead_cooling_tach_pin"]!=null&&(e.push(`tachometer_pin: ^${this.toolboardPins?.["4p_toolhead_cooling_tach_pin"]}`),e.push("tachometer_poll_interval: 0.0005"));break;default:throw Error(`Unsupported hotend fan option "${this.getHotendFan().title}"`)}return e.join("\n")}renderToolheadMacro(){let e=null;if(this.getMotionAxis()===s.x?e=this.printer.bedMargin.x[0]+5:this.getMotionAxis()===s.dual_carriage&&(e=this.size.x+this.printer.bedMargin.x[1]-5),null==e||isNaN(e))throw getLogger().debug("renderToolheadMacro:",this.printer.bedMargin.x[0],this.size,this.printer.bedMargin.x[1]),Error(`Failed to generate parking position for toolhead ${this.getToolCommand()}. Generated: ${e}`);let t=[`[gcode_macro ${this.getToolCommand()}]`,`variable_active: ${0===this.getTool()?"True":"False"}`,`variable_color: "${0===this.getTool()?"7bff33":"0ea5e9"}"              # Used in frontends`,`variable_hotend_type: "${this.getHotend().flowType.toUpperCase()}"`,`variable_has_cht_nozzle: ${"CHT"===this.getNozzle().type?"True":"False"}`,"variable_cooling_position_to_nozzle_distance: 40 # heatbreak length from cold zone to nozzle","variable_tooolhead_sensor_to_extruder_gear_distance: 15 # distance in mm from the sensor to the extruder gear","variable_extruder_gear_to_cooling_position_distance: 30 # distance in mm from the extruder gear to the end of the hotend cold zone","variable_filament_loading_nozzle_offset: -5","variable_filament_grabbing_length: 5","variable_filament_grabbing_speed: 1","variable_unload_after_runout: True # unload filament after a runout has been detected","variable_resume_after_insert: True # resumes the print after inserting new filament","variable_purge_after_load: 0","variable_purge_before_unload: 0","variable_extruder_load_speed: 60","variable_filament_load_speed: 10"];return"hybrid-corexy-idex"==this.printer.kinematics&&t.push(`variable_loading_position: ${0===this.getTool()?e+25:e-25} # filament load x position`,`variable_parking_position: ${e} # parking x position`),t.push("gcode:",`	{% set x = params.X|default(-1.0)|float %}`,`	{% set y = params.Y|default(-1.0)|float %}`,`	{% set z = params.Z|default(0.0)|float %}`,`	{% set s = params.S|default(1)|int %}`,`	_SELECT_TOOL T=${this.getTool()} X={x} Y={y} Z={z} TOOLSHIFT={s}`),t.join("\n")}};let constructKlipperConfigUtils=async e=>{let t=e.toolheads.reduce((e,t)=>e+(t.toolboard?.driverCount??0),0),r=null!=e.controlboard.extruderlessConfig?1:0,i=e.printer.driverCountRequired>e.controlboard.driverCount,o=await parseBoardPinConfig(e.controlboard,i),n=await Promise.all(e.toolheads.map(async t=>{if(null==t.toolboard&&i)throw Error("A toolboard is required when using an extruderless controlboard configuration (your controlboard alone does not have enough drivers for this printer). Please add a toolboard to your configuration.");return await ToolheadGenerator.fromConfig(t,o,e.printer,e.size)}));return{extruderLessConfigBonus:r,isExtruderlessBoard:i,toolboardDriverCount:t,getControlboardPins:()=>({...o}),requireControlboardPin(e){if(null==this.getControlboardPins()[e])throw Error(`The controlboard has no "${e}" defined in its config.`)},isExtruderToolheadAxis:e=>n.some(t=>t.getExtruderAxis()===e),getToolhead:e=>{let t="number"==typeof e?n.find(t=>t.getTool()===e):n.find(t=>t.getExtruderAxis()===e||t.getMotionAxis()===e);if(null==t)throw Error(`No toolhead found for tool/axis ${e}`);return t},renderCommentHeader(e,t=[]){let r="------------------------------------------------------------------------------------------------------------",i=(r.length-e.length-2)/2,o=`#${"-".repeat(Math.floor(i))} ${e} ${"-".repeat(Math.ceil(i))}`;return[o,...t.length?t.concat(`#${r}`):[]]},getToolheads:()=>n.slice(),getRail(t){let r=e.rails.find(e=>e.axis===t);if(null==r)throw Error(`No rail found for axis ${t}`);return r},getRailPinValue(t,r,i=["controlboard","toolboard"],n=!0){let a=this.printerAxisToPinAliasPrefix(t)+"_"+(r.startsWith("_")?r.substring(1):r),s=null;if(this.isExtruderToolheadAxis(t)&&i.includes("toolboard")){let e=this.getToolhead(t);s=n?e.getToolheadPin(t,r):e.getPinFromToolboardAlias(a)}else if(i.includes("controlboard")){let i=this.getRail(t),n=r.startsWith("_")?r.substring(1):r;if(null!=e.controlboard.motorSlots&&null!=i.motorSlot&&n in e.controlboard.motorSlots[i.motorSlot]){if(null==(s=e.controlboard.motorSlots[i.motorSlot][n]))throw Error(`Motor slot was selected, but pin ${n} wasn't found in motor slot config.`)}else s=o[a]}if(null==s)throw Error(`Pin name "${a}" constructed from axis "${t}" and alias "${r}" not found in board pin configs.`);return s},getAxisStepperName:e=>e===s.extruder?"extruder":e===s.extruder1?"extruder1":e===s.dual_carriage?"dual_carriage":"stepper_"+e,getAxisDriverType(e){return this.getRail(e).driver.type.toLowerCase()},getAxisDriverVariables(t,r=!1,i=[]){let o=e.rails.filter(e=>(r?e.axis.startsWith(t):e.axis===t)||i.includes(e.axis)),n=[];return n.push(`variable_${t}_driver_types: [${o.map(e=>`"${e.driver.type.toLowerCase()}"`).join(", ")}]`),n.push(`variable_${t}_axes: [${o.map(e=>`"${e.axis}"`).join(", ")}]`),n.join("\n")},isSensorless:e=>n.find(t=>t.getMotionAxis()===e)?.getXEndstop().id==="sensorless"||e===s.y&&n.some(e=>"sensorless"===e.getYEndstop().id),getAxisHomingSpeed(e){let t=this.getRail(e),r=this.isSensorless(e)?50:t.homingSpeed;return r},getAxisDriverSectionName(e){return`${this.getAxisDriverType(e)} ${this.getAxisStepperName(e)}`},getAxisVirtualEndstop(e){return`${this.getAxisDriverType(e)}_${this.getAxisStepperName(e)}:virtual_endstop`},getAxisDriverStallGuardThreshold(e,t){let r=this.getRail(e);return(t=Math.max(0,Math.min(1,t)),["TMC2130","TMC5160","TMC2240"].includes(r.driver.type))?`driver_SGT: ${Math.round(127*t)-64} # Lower value = higher sensitity, range -64 to 63`:`driver_SGTHRS: ${Math.round(255*t)} # Lower value = lower sensitivity, range 0 to 255`},getAxisDriverDiagConfig(e){return"UART"===this.getRail(e).driver.protocol?`diag_pin: ^${this.printerAxisToPinAliasPrefix(e)}_diag_pin`:"SPI"===this.getRail(e).driver.protocol?`diag1_pin: ^!${this.printerAxisToPinAliasPrefix(e)}_diag_pin`:""},getAxisDriverHomingCurrent(e,t){let r=this.getRail(e);return t=Math.max(0,Math.min(1,t)),.71*r.stepper.maxPeakCurrent*t},getExtruderPinPrefix(e=0){let t=this.getToolhead(e);if(null==t)throw Error(`No toolhead found for tool ${e}`);return t.getPinPrefix()},formatInlineComments(e,t="#"){let r=e.reduce((e,r)=>Math.max(e,r.substring(0,r.indexOf(t)).trim().length),0);return e.map(e=>{let i=e.indexOf(t),o=e.lastIndexOf(t);if((-1===i||e.trim().startsWith(t))&&o===i)return e;i!==o&&(i=e.indexOf(t,i+1));let n=e.substring(i),a=e.substring(0,i).trim(),s=r-a.length+2;return a+" ".repeat(s)+" "+n})},isPrinterAxis:e=>Object.values(s).includes(e),pinAliasPrefixToPrinterAxis(e){let t=$.safeParse(e);return t.success?t.data:null},printerAxisToPinAliasPrefix(e){let t=F.safeParse(e);return t.success?t.data:null},getMotorComments(t,r){let i="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==i)throw Error(`No rail found for axis ${t}`);let o=[`# ${i.axisDescription}`];if(this.isExtruderToolheadAxis(i.axis)){let t=this.getToolhead(i.axis);if(null==t)throw Error(`No toolhead found for ${i.axis}`);o.push(`# Connected to ${(t.getToolboard()||e.controlboard).name}`)}else i.motorSlot&&e.controlboard.motorSlots&&o.push(`# Connected to ${e.controlboard.motorSlots[i.motorSlot].title} on ${e.controlboard.name}`);return this.renderCommentHeader(r??i.axis.toUpperCase(),o)},getMotorPinComments(t,r,i){let o="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==o)throw Error(`No rail found for axis ${t}`);let n=[];return o.motorSlot&&r.motorSlots&&n.push(`# Assigned to slot: "${r.motorSlots[o.motorSlot].title}"`),this.renderCommentHeader(i??o.axis.toUpperCase(),n)}}},constructKlipperConfigExtrasGenerator=(e,t)=>{let r=[],i=[];return{getFilesToWrite:()=>r.slice(),addFileToRender(e){r.push(e)},getReminders:()=>i.slice(),generateSaveVariables(){let e=h.parse(process.env);return[{fileName:"ratos-variables.cfg",content:"[Variables]\nidex_applied_offset = 1\nidex_xcontrolpoint = 150.0\nidex_xoffset = 0.0\nidex_ycontrolpoint = 50.0\nidex_yoffset = 0.0\nidex_zcontrolpoint = 50.0\nidex_zoffset = 0.0\nidex_zoffsetcontrolpoint = 25.0",overwrite:!1}].map(t=>(this.addFileToRender(t),`[save_variables]
filename: ${z().join(e.KLIPPER_CONFIG_PATH,t.fileName)}`))},generateSensorlessHomingIncludes(){let r=[];if(t.isSensorless(s.x)&&r.push({fileName:"sensorless-homing-x.cfg",content:sensorlessXTemplate(e,t),overwrite:!1}),t.isSensorless(s.y)&&r.push({fileName:"sensorless-homing-y.cfg",content:sensorlessYTemplate(e,t),overwrite:!1}),r.length>0){let e=[];e.push("# REMEMBER TO TUNE SENSORLESS HOMING BEFORE ATTEMPTING TO PRINT!"),e.push("# You'll find instructions in the generated sensorless-homing-*.cfg file(s),","# where you should keep your sensorless homing settings."),this.addReminder(e.join("\n"))}return r.map(e=>(this.addFileToRender(e),`[include ${e.fileName}]`)).join("\n")},addReminder(e){i.push(e)}}},constructKlipperConfigHelpers=async(e,t,r)=>({renderToolboards(){return r.getToolheads().map(e=>e.renderToolboard(this.renderBoardPinAlias)).join("\n")},renderControlboard(){let t=["",this.renderBoardPinAlias(e.controlboard.id,e.controlboard),"","[mcu]",`serial: ${getBoardSerialPath(e.controlboard)}`];return e.controlboard.hasMcuTempSensor&&(t.push(""),t.push(`[temperature_sensor ${e.controlboard.name.replace(/\s/g,"_")}]`),t.push("sensor_type: temperature_mcu")),null!=e.controlboard.ADXL345SPI&&(t.push(""),t.push("[adxl345 controlboard]"),t.push(`cs_pin: ${e.controlboard.ADXL345SPI.cs_pin}`),"hardware"in e.controlboard.ADXL345SPI?t.push(`spi_bus: ${e.controlboard.ADXL345SPI.hardware.bus}`):(t.push(`spi_software_mosi_pin: ${e.controlboard.ADXL345SPI.software.mosi}`),t.push(`spi_software_miso_pin: ${e.controlboard.ADXL345SPI.software.miso}`),t.push(`spi_software_sclk_pin: ${e.controlboard.ADXL345SPI.software.sclk}`))),null!=e.controlboard.outputPins&&e.controlboard.outputPins.forEach(e=>{t.push(""),t.push(`[output_pin ${e.name}]`),t.push(`pin: ${e.pin}`),t.push(`value: ${e.value}`)}),t.join("\n")},renderBoards(){if(e.printer.driverCountRequired>e.controlboard.driverCount&&e.controlboard.driverCount+r.toolboardDriverCount+r.extruderLessConfigBonus<e.printer.driverCountRequired)throw Error("Your control and toolboard combination does not make up enough drivers for this printer.");let t=["[include RatOS/boards/rpi/config.cfg]",this.renderControlboard(),this.renderToolboards()];return t.join("\n")},renderStepperSections(){return e.rails.map(e=>this.renderStepperSection(e)).join("\n")},renderMotorSections(){let t=e.rails.map(e=>r.getMotorComments(e).join("\n")+"\n"+this.renderDriverSection(e,!0)+"\n"+this.renderStepperSection(e,!0));return t.push(this.renderBoardQuirks()),t.join("\n")},renderStepperSection(t,i=!1){let o="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==o)throw Error(`No rail found for axis ${t}`);let n=i?[]:r.getMotorComments(o);if(n.push(`[${r.getAxisStepperName(o.axis)}]`,`step_pin: ${r.getRailPinValue(o.axis,"_step_pin")}`,`dir_pin: ${r.getRailPinValue(o.axis,"_dir_pin")}`,`enable_pin: !${r.getRailPinValue(o.axis,"_enable_pin")}`,`microsteps: ${o.microstepping}`),o.axis===s.extruder||o.axis===s.extruder1){let e=r.getToolhead(o.axis);if(null==e)throw Error(`No toolhead found for ${o.axis}`);n.push(`rotation_distance: ${el(e.getExtruder().id)}`)}else n.push(`rotation_distance: ${o.rotationDistance}`);if(o.axis===s.z&&n.push("position_min: -5"),[s.x,s.y,s.z,s.dual_carriage].includes(o.axis)&&n.push(`homing_speed: ${r.getAxisHomingSpeed(o.axis)}`),null!=o.gearRatio&&n.push(`gear_ratio: ${o.gearRatio}`),o.axis===s.z){let t=e.toolheads.find(e=>null!=e.probe);t?.probe!=null&&n.push("endstop_pin: probe:z_virtual_endstop")}return n.join("\n")+"\n"},renderUserStepperSections(t){return r.formatInlineComments(e.rails.map(e=>{let r=t[e.axis],{directionInverted:i,rotationComment:o,additionalLines:n}=r??{},a=null!=r&&"limits"in r?r.limits:null,s=null!=r&&"safeDistance"in r?r.safeDistance:void 0;return this.renderUserStepperSection(e.axis,i,a,s,o,n)}).join("\n").split("\n")).join("\n")},renderUserStepperSection(t,i=!1,o,n,a,l){let d="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==d)throw Error(`No rail found for axis ${t}`);let p=i?`# Remove ! in front of pin name to reverse the direction of ${r.getAxisStepperName(d.axis)}`:`# Add ! in front of pin name to reverse the direction of ${r.getAxisStepperName(d.axis)}`,c=r.getMotorComments(d).concat([`[${r.getAxisStepperName(d.axis)}]`,`dir_pin: ${i?"!":""}${d.axis.startsWith("extruder")?r.getExtruderPinPrefix():""}${r.printerAxisToPinAliasPrefix(d.axis)}_dir_pin ${p}`]);if(d.axis===s.extruder||d.axis===s.extruder1){let e=r.getToolhead(d.axis);if(null==e)throw Error(`No toolhead found for ${d.axis}`);c.push(`rotation_distance: ${el(e.getExtruder().id)} # ${e.getExtruder().title} default`)}else c.push(`rotation_distance: ${d.rotationDistance} ${a?`# ${a}`:""}`);if([s.x,s.y,s.z].includes(d.axis)&&c.push(`homing_speed: ${r.getAxisHomingSpeed(d.axis)}`),o){let t=d.axis!==s.y?e.printer.bedMargin.x[0]:e.printer.bedMargin.y[0],r=d.axis!==s.y?e.printer.bedMargin.x[1]:e.printer.bedMargin.y[1];Object.entries("function"==typeof o?o({min:t,max:r}):o).forEach(([e,t])=>{c.push(`position_${e}: ${d.axis===s.z&&"min"===e?Math.min(t,-5):t}`)})}return n&&c.push(`safe_distance: ${n}`),null!=l&&c.push(...l),c.join("\n")+"\n"},renderDriverSections(){let t=e.rails.map(e=>this.renderDriverSection(e));return t.push(this.renderBoardQuirks()),t.join("\n")},renderDriverSection(t,i=!1){let o="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==o)throw Error(`No rail found for axis ${t}`);let n=findPreset(o.stepper,o.driver,o.voltage,o.current),a=i?[]:r.getMotorComments(o);if(a.push(`[${r.getAxisDriverSectionName(o.axis)}]`,`stealthchop_threshold: ${e.stealthchop?"9999999":e.standstillStealth?"1":"0"}`,`interpolate: ${o.microstepping<64||e.stealthchop?"True":"False"}`),"UART"===o.driver.protocol){if(o.motorSlot&&!(r.isExtruderToolheadAxis(o.axis)&&r.getToolhead(o.axis).hasToolboard())){let t=e.controlboard.motorSlots?.[o.motorSlot];if(null==t||!hasUART(e.controlboard.motorSlots?.[o.motorSlot]))throw Error(`No controlboard motor slot UART pins defined for motor slot ${o.motorSlot}`);Object.entries(L.parse(t)).forEach(([e,t])=>{a.push(`${e}: ${t}`)})}else a.push(`uart_pin: ${r.getRailPinValue(o.axis,"_uart_pin")}`)}if("SPI"===o.driver.protocol){if(o.motorSlot){let t=e.controlboard.motorSlots?.[o.motorSlot];if(null==t||!hasSPI(e.controlboard.motorSlots?.[o.motorSlot]))throw Error(`No controlboard motor slot SPI pins defined for motor slot ${o.motorSlot}`);Object.entries(D.parse(t)).forEach(([e,t])=>{a.push(`${e}: ${t}`)})}else a.push(`cs_pin: ${r.getRailPinValue(o.axis,"_uart_pin")}`),null!=e.controlboard.stepperSPI?"hardware"in e.controlboard.stepperSPI?a.push(`spi_bus: ${e.controlboard.stepperSPI.hardware.bus}`):(a.push(`spi_software_mosi_pin: ${e.controlboard.stepperSPI.software.mosi}`),a.push(`spi_software_miso_pin: ${e.controlboard.stepperSPI.software.miso}`),a.push(`spi_software_sclk_pin: ${e.controlboard.stepperSPI.software.sclk}`)):(a.push("spi_software_mosi_pin: stepper_spi_mosi_pin"),a.push("spi_software_miso_pin: stepper_spi_miso_pin"),a.push("spi_software_sclk_pin: stepper_spi_sclk_pin"))}if(n){let{driver:e,voltage:t,...r}=n;Object.entries(r).forEach(([e,t])=>{a.push(`${e}: ${t}`)})}else a.push(`run_current: ${o.current}`);return a.join("\n")+"\n"},renderSpeedLimits(){let t=e.performanceMode&&e.printer.speedLimits.performance?e.printer.speedLimits.performance:e.printer.speedLimits.basic;return`[printer]
max_velocity: ${e.stealthchop?"135":t.velocity}
max_accel: ${t.accel/(e.stealthchop?2:1)}
max_accel_to_decel: ${t.accel/(e.stealthchop?4:2)}
max_z_velocity: ${t.z_velocity}
max_z_accel: ${t.z_accel}
square_corner_velocity: ${t.square_corner_velocity}

[gcode_macro RatOS]
variable_macro_travel_speed: ${this.getMacroTravelSpeed()}
variable_macro_travel_accel: ${this.getMacroTravelAccel()}`},getMacroTravelSpeed(){let t=e.performanceMode&&e.printer.speedLimits.performance?e.printer.speedLimits.performance:e.printer.speedLimits.basic;return e.stealthchop?"135":t.travel_velocity},getMacroTravelAccel(){let t=e.performanceMode&&e.printer.speedLimits.performance?e.printer.speedLimits.performance:e.printer.speedLimits.basic;return e.stealthchop?"1000":t.travel_accel},renderBoardQuirks(){let t=[];return e.controlboard.hasQuirksFiles&&(t.push("# Include controlboard quirk file"),null!=r.getToolhead(s.extruder)?t.push(`[include RatOS/boards/${e.controlboard.id}/quirks-toolboard.cfg]`):t.push(`[include RatOS/boards/${e.controlboard.id}/quirks.cfg]`)),r.getToolheads().forEach(e=>{let r=e.getToolboard();r?.hasQuirksFiles&&(t.push("# Include toolboard quirk file"),t.push(`[include RatOS/boards/${r.id}/quirks.cfg]`))}),t.join("\n")},renderHotend:()=>r.getToolheads().map(e=>e.renderHotend()).join("\n"),renderExtruder:()=>r.getToolheads().map(e=>e.renderExtruder()).join("\n"),renderInputShaper(e){let t=[],i=r.getToolhead(s.x);return[i.getYAccelerometerName(),i.getXAccelerometerName()].includes("rpi")&&(t.push("[include RatOS/sensors/rpi-adxl345.cfg]"),t.push("")),t.push("[resonance_tester]"),t.push(`accel_chip_x: adxl345 ${i.getXAccelerometerName()}`),t.push(`accel_chip_y: adxl345 ${i.getYAccelerometerName()}`),t.push("probe_points:"),t.push(`	${e.x/2},${e.y/2},20`),t.join("\n")},renderProbeIncludes(){let e=[],t=r.getToolheads().find(e=>null!=e.getProbe());return t&&e.push(`[include RatOS/z-probe/${t.getProbe()?.id+".cfg"}]`),e.push(this.renderProbePinSection(!0)),e.join("\n")},renderProbePinSection(e=!1){let i=[],o=r.getToolheads().find(e=>null!=e.getProbe());if(o)switch(o.getProbe()?.id){case"bltouch":let n=o.getPinPrefix()+(e?o.getPinFromAlias("bltouch_control_pin"):"bltouch_control_pin"),a=o.getPinPrefix()+(e?o.getPinFromAlias("bltouch_sensor_pin"):"bltouch_sensor_pin");i.push("# BLTouch configuration"),i.push("[bltouch]"),i.push("control_pin: "+n),i.push("sensor_pin: ^"+a),e||i.push("z_offset: 0");break;case"beacon":if(!e){let e=[];e.push("# REMEMBER TO CALIBRATE YOUR BEACON!"),e.push("# Follow along from step 6 in the official beacon guide https://docs.beacon3d.com/quickstart/#6-calibrate-beacon"),t.addReminder(e.join("\n"))}break;default:let s=o.getPinPrefix()+(e?o.getPinFromAlias("probe_pin"):"probe_pin");i.push("# Probe configuration"),i.push("[probe]"),e||i.push("z_offset: 0.0 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG"),i.push(`pin: ^${s}# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.`),e||(i.push(`#pin: ^!${s} # NPN NO (refer to the specs of your probe)`),i.push(`#pin: ${s} # PNP NO (refer to the specs of your probe)`),i.push(`#pin: !${s} # PNP NC (refer to the specs of your probe)`))}return i.join("\n")},renderEndstopSection(i){let o=[],n=r.getToolheads(),a="sensorless";if(n.forEach(e=>{if("sensorless"!==e.getXEndstop().id&&(o.push(""),o.push("# Physical X endstop configuration"),o.push(`[${e.getMotionStepperName()}]`),o.push(`endstop_pin: ${e.getXEndstopPin()}`),o.push("[gcode_macro RatOS]"),o.push('variable_homing_x: "endstop"')),"sensorless"!==e.getYEndstop().id){if("sensorless"==a)a=e.getYEndstopPin();else if(a!==e.getYEndstopPin())throw Error("Multiple toolheads configured with different y endstops is currently not supported.")}}),"sensorless"!==a&&(o.push(""),o.push("# Physical Y endstop configuration"),o.push("[stepper_y]"),o.push(`endstop_pin: ${a}`),o.push("[gcode_macro RatOS]"),o.push('variable_homing_y: "endstop"')),n.some(e=>"sensorless"===e.getXEndstop().id||"sensorless"===e.getYEndstop().id)){let n=e.printer.defaults.rails.find(e=>e.axis===s.x),a=e.printer.defaults.rails.find(e=>e.axis===s.dual_carriage),l=e.printer.defaults.rails.find(e=>e.axis===s.y);o.push(""),n&&l&&null!=i&&matchesDefaultRail(r.getRail(s.x),deserializePrinterRailDefinition(n),e.performanceMode)&&matchesDefaultRail(r.getRail(s.y),deserializePrinterRailDefinition(l),e.performanceMode)&&(null==a||matchesDefaultRail(r.getRail(s.dual_carriage),deserializePrinterRailDefinition(a),e.performanceMode))?o.push(`[include ${i}]`):o.push(t.generateSensorlessHomingIncludes())}return r.getToolheads().every(e=>null==e.getProbe())&&(o.push(""),o.push("# Physical Z endstop configuration"),o.push("[stepper_z]"),o.push("pin: z_endstop_pin"),o.push("position_endstop: -0.1"),o.push("second_homing_speed: 3.0"),o.push("homing_retract_dist: 3.0")),o.join("\n")},renderMacroVariableOverrides(t){let i=[`variable_bed_margin_x: [${e.printer.bedMargin.x[0]}, ${e.printer.bedMargin.x[1]}]`,`variable_bed_margin_y: [${e.printer.bedMargin.y[0]}, ${e.printer.bedMargin.y[1]}]`],o=r.getToolheads(),n=o.some(e=>e.getMotionAxis()===s.dual_carriage);if(n){let e=o.find(e=>null!=e.getProbe())?.getTool();i.push(`variable_default_toolhead: ${e}                             # the toolhead with the z-probe, 0=left 1=right toolhead`);let t=r.getToolhead(0).getXAccelerometerName(),n=r.getToolhead(1).getXAccelerometerName();i.push(`variable_adxl_chip: ["${t}", "${n}"]           # toolheads adxl chip names`),i.push(`variable_toolchange_travel_speed: ${this.getMacroTravelSpeed()}     # parking travel speed`),i.push(`variable_toolchange_travel_accel: ${this.getMacroTravelAccel()}     # parking travel accel`),i.push("variable_shaper_x_freq: [0, 0, 0, 0]                    # shaper frequency [T0, T1, COPY, MIRROR]"),i.push("variable_shaper_y_freq: [0, 0, 0, 0]                    # shaper frequency [T0, T1, COPY, MIRROR]"),i.push('variable_shaper_x_type: ["mzv", "mzv", "mzv", "mzv"]    # shaper frequency algorythm [T0, T1, COPY, MIRROR]'),i.push('variable_shaper_y_type: ["mzv", "mzv", "mzv", "mzv"]    # shaper frequency algorythm [T0, T1, COPY, MIRROR]')}return i.push(r.getAxisDriverVariables(s.x,"hybrid-corexy"!==e.printer.kinematics)),i.push(r.getAxisDriverVariables(s.y,!0,"hybrid-corexy"===e.printer.kinematics?[s.x1]:[])),i.push(r.getAxisDriverVariables(s.z,!0)),r.formatInlineComments(i).join("\n")},renderSaveVariables:()=>t.generateSaveVariables().join("\n"),renderUserMacroVariableOverrides(e){let t=[`variable_macro_travel_speed: ${this.getMacroTravelSpeed()}`,`variable_macro_travel_accel: ${this.getMacroTravelAccel()}`],i=r.getToolheads(),o=i.some(e=>e.getMotionAxis()===s.dual_carriage);return o&&(t.push(`variable_toolchange_travel_speed: ${this.getMacroTravelSpeed()}     # parking travel speed`),t.push(`variable_toolchange_travel_accel: ${this.getMacroTravelAccel()}     # parking travel accel`),t.push("variable_shaper_x_freq: [0, 0, 0, 0]                    # shaper frequency [T0, T1, COPY, MIRROR]"),t.push("variable_shaper_y_freq: [0, 0, 0, 0]                    # shaper frequency [T0, T1, COPY, MIRROR]"),t.push('variable_shaper_x_type: ["mzv", "mzv", "mzv", "mzv"]    # shaper frequency algorythm [T0, T1, COPY, MIRROR]'),t.push('variable_shaper_y_type: ["mzv", "mzv", "mzv", "mzv"]    # shaper frequency algorythm [T0, T1, COPY, MIRROR]')),r.formatInlineComments(t).join("\n")},renderControllerFan(){let t=[];if("none"===e.controllerFan.id)return t.push("# No controller fan configured"),t.join("\n");switch(t.push("[controller_fan controller_fan]"),e.controllerFan.id){case"2pin":r.requireControlboardPin("fan_controller_board_pin"),t.push("# 2-pin fan connected to the controller board"),t.push(`pin: ${r.getControlboardPins().fan_controller_board_pin}`);break;case"4pin":r.requireControlboardPin("fan_controller_board_pin"),t.push("# 4-pin fan connected to the controller board"),t.push(`pin: !${r.getControlboardPins().fan_controller_board_pin}`),t.push("cycle_time:  0.00004");break;case"4pin-dedicated":r.requireControlboardPin("4p_fan_part_cooling_tach_pin"),t.push("# 4-pin fan connected to a dedicated 4-pin fan header on the controller board"),t.push(`pin: ${r.getControlboardPins()["4p_fan_part_cooling_tach_pin"]}`),t.push("cycle_time:  0.00004"),null!=r.getControlboardPins()["4p_fan_part_cooling_tach_pin"]&&(t.push(`tachometer_pin: ^${r.getControlboardPins()["4p_fan_part_cooling_tach_pin"]}`),t.push("tachometer_poll_interval: 0.0005"));break;default:throw Error(`Unsupported controller fan option "${e.controllerFan.title}"`)}return t.join("\n")},renderFans(){let e=[],t=r.getToolheads().filter(e=>e.getPartFan()).length>1;return e.push("# Part cooling fan"),t&&(e.push("# Multiple toolheads with part cooling fans configured"),e.push("# [fan] will use an unused io pin, proxy m106 settings to active toolhead via macro."),e.push("[fan]"),e.push("pin: rpi:gpio4         # sacrifical part fan, use this to independently control your both toolhead part fans")),e.push(r.getToolheads().map(e=>e.renderPartFan(t)).join("\n")),e.push(""),e.push("# Hotend cooling fan"),e.push(r.getToolheads().map(e=>e.renderHotendFan()).join("\n")),e.push(""),e.push("# Controller cooling fan"),e.push(this.renderControllerFan()),e.join("\n")},renderBoardPinAlias(e,t,i,o){let n=t.isToolboard?"toolboard":"controlboard",a=t.isToolboard?i?.getToolboardPins():r.getControlboardPins();if(null==a)throw Error(`No pins found for ${t.name}.`);let s={},l=Object.keys(a).map(e=>{let t=e.split("_"),i="dual"===t[0]?t[0]+"_"+t[1]:t[0],o=r.pinAliasPrefixToPrinterAxis(i);if(r.isPrinterAxis(o)&&-1!==Object.keys(k.shape).indexOf(e.replace(i+"_","")))try{let t=r.getRailPinValue(o,e.replace(i,""),[n],!1);return null==s[o]&&(s[o]=[]),s[o]?.push(`${e}=${t}`),null}catch(e){return null}return null==a[e]?e+"=null":e+"="+a[e]}).filter(Boolean),d=[`[board_pins ${e}]`];null!=o&&d.push(`mcu: ${o}`);let p=[];return Object.entries(s).forEach(([e,i])=>{null!=i&&r.isPrinterAxis(e)&&(p.push(r.getMotorPinComments(e,t,`${e.toUpperCase()} motor pins`).join("\n	")),p.push(i.join(",\n	")+","))}),d.push("aliases:",`	${p.join("\n	")}
	${r.renderCommentHeader("GENERAL PINS")}
	${l.join(",\n	")}`),d.join("\n")},renderBase:()=>"[include RatOS/homing.cfg]\n[include RatOS/macros.cfg]\n[include RatOS/shell-macros.cfg]",renderReminders:()=>t.getReminders().join("\n"),renderMacros:()=>r.formatInlineComments(r.getToolheads().flatMap(e=>e.renderToolheadMacro().split("\n"))).join("\n"),uncommentIf:e=>!0===e?"":"#"}),partFanOptions=(e,t)=>{let r=[];return(null==t||t?.axis===s.x||t?.axis===null)&&(r.push({id:"2pin",title:"2-pin fan"}),r.push({id:"4pin",title:"4-pin fan"})),e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated",title:"4-pin fan (dedicated 4-pin header)"}),t?.toolboard!=null&&(r.push({id:"2pin-toolboard",title:"2-pin toolboard fan"}),r.push({id:"4pin-toolboard",title:"4-pin toolboard fan"}),t?.toolboard.fourPinFanConnectorCount!=null&&t.toolboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated-toolboard",title:"4-pin fan (dedicated 4-pin header on toolboard)"})),r},hotendFanOptions=(e,t)=>{let r=[];return(null==t||t?.axis===s.x)&&(r.push({id:"2pin",title:"2-pin fan"}),r.push({id:"4pin",title:"4-pin fan"})),(e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>2||e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>1&&e.controllerFan?.id!=="4pin-dedicated")&&r.push({id:"4pin-dedicated",title:"4-pin fan (dedicated 4-pin header)"}),t?.toolboard!=null&&(r.push({id:"2pin-toolboard",title:"2-pin toolboard fan"}),r.push({id:"4pin-toolboard",title:"4-pin toolboard fan"}),t?.toolboard.fourPinFanConnectorCount!=null&&t.toolboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated-toolboard",title:"4-pin fan (dedicated 4-pin header on toolboard)"})),r},controllerFanOptions=(e,t)=>{let r=[{id:"2pin",title:"2-pin fan"},{id:"4pin",title:"4-pin fan"}];return(e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>2||e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>1&&t?.some(e=>e?.hotendFan?.id!=="4pin-dedicated"))&&r.push({id:"4pin-dedicated",title:"4-pin fan (dedicated 4-pin header)"}),r.push({id:"none",title:"No fan"}),r};var eU=r(74917);let runSudoScript=(e,...t)=>{let r=getScriptRoot();return new Promise((i,o)=>{try{let n=(0,m.spawn)("sudo",[z().join(r,e),...t]),a="",s="";n.stdout.on("data",e=>{a+=e}),n.stderr.on("data",e=>{s+=e}),n.on("error",e=>{o(e)}),n.on("exit",e=>{0===e?i({stdout:a,stderr:s}):o("An error occured while attempting to run script: \n"+a+"\n"+s)}),n.on("close",e=>{0===e?i({stderr:s,stdout:a}):o(s)})}catch(e){if(e instanceof Error)return o(e.message);o("An error occured while attempting to run script")}})},eW=eU.rN.context().meta().create(),eG=eW.router,eq=eW.procedure,eV=eW.middleware;var eX=r(12426);let eK=u.z.object({boardPath:u.z.string().optional(),toolhead:eR.optional()}),detect=(e,t)=>c().existsSync(getBoardSerialPath(e,t)),getBoards=async()=>{let e=ei.get("boards");if(null!=e&&e.length>0)return e.map(e=>(e.detected=detect(e),e));let t=await (0,eX.zA)(`${process.env.RATOS_CONFIGURATION_PATH}/boards/*/board-definition.json`),r=t.map(e=>""===e.trim()?null:{...JSON.parse(c().readFileSync(e).toString()),path:W.parse(e.replace("board-definition.json",""))}).filter(Boolean).map(e=>{e.detected=detect(e);try{return K.parse(e)}catch(t){throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Invalid board definition for ${e.name} in ${e.path}`,cause:t})}});return ei.set("boards",r),r},updateDetectionStatus=async(e,t)=>e.map(e=>(e.detected=detect(e,t),e)),compileFirmware=async(e,t,r)=>{let i=null,o=h.parse(process.env);try{let n=z().join(o.KLIPPER_DIR,".config");if(await (0,J.copyFile)(z().join(e.path,"firmware.config"),n),e.isHost||await replaceInFileByLine(n,/CONFIG_USB_SERIAL_NUMBER=".+"/g,`CONFIG_USB_SERIAL_NUMBER="${getBoardChipId(e,t)}"`),r)return(0,p.readFileSync)(n).toString();let a=e.firmwareBinaryName,s=z().extname(a),l=z().join(o.KLIPPER_DIR,"out",`klipper${s}`),d=z().join(o.RATOS_DATA_DIR,a);if((0,p.existsSync)(d)&&await (0,J.unlink)(d),i=await runSudoScript("klipper-compile.sh"),(0,p.existsSync)(l))await (0,J.copyFile)(l,d);else if(!e.isHost)throw Error(`Could not find compiled firmware at ${l}`);return i}catch(r){let t=r instanceof Error?r.message:r;throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Could not compile firmware for ${e.name}: ${t} 

 ${i?.stdout}`,cause:r})}},getBoardsWithoutHost=e=>e.filter(e=>!e.isHost),getToolboards=e=>u.z.array(Q).parse(e.filter(e=>e.isToolboard)),getBoardsWithDriverCount=(e,t)=>e.filter(e=>e.driverCount>=t||null!=e.extruderlessConfig&&e.driverCount>=t-1),eY=eV(async({ctx:e,next:t,meta:r,rawInput:i})=>{let o=null,n=null,a=eK.safeParse(i);try{o=await getBoards();try{n=a.success&&a.data.toolhead?new ToolheadHelper(await deserializeToolheadConfiguration(a.data.toolhead,{},o)):void 0,o=await updateDetectionStatus(o,n)}catch(e){if(e instanceof u.jm)throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Toolhead configuration cannot be deserialized, please check the configuration.
${Object.entries(e.flatten().fieldErrors).map(([e,t])=>`${e}: ${t}`).join("\n")}`,cause:e});throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:"Toolhead configuration cannot be deserialized, please check the configuration.",cause:e})}r?.includeHost!==!0&&(o=getBoardsWithoutHost(o))}catch(e){if(e instanceof eU.bR)throw e;throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Invalid board definition(s) in ${process.env.RATOS_CONFIGURATION_PATH}/boards.`,cause:e})}let s=null;if(r?.boardRequired&&(!a.success||null==a.data.boardPath))throw new eU.bR({code:"PRECONDITION_FAILED",message:"boardPath parameter missing."});if(a.success&&null!=a.data.boardPath&&null==(s=o.find(e=>e.path===a.data.boardPath)))throw new eU.bR({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${a.data.boardPath}`});return t({ctx:{...e,boards:o,board:s,toolhead:n}})}),eZ=eq.use(eY);eG({boards:eZ.input(u.z.object({boardFilters:u.z.object({toolboard:u.z.boolean().optional(),driverCountRequired:u.z.number().optional()}).optional(),toolhead:eR.optional()})).output(u.z.array(K)).query(({ctx:e,input:t})=>{let r=e.boards;return t.boardFilters?.toolboard===!0&&(r=getToolboards(r)),t.boardFilters?.driverCountRequired!=null&&(r=getBoardsWithDriverCount(r,t.boardFilters.driverCountRequired)),r}),detect:eZ.input(eK).meta({boardRequired:!0}).query(({ctx:e,input:t})=>{if(null==e.board)throw new eU.bR({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});return detect(e.board,e.toolhead)}),unidentifiedDevices:eZ.query(async({ctx:e})=>{let t=e.boards.filter(e=>e.detected).map(e=>c().realpathSync(getBoardSerialPath(e)));return(await (0,eX.zA)("/dev/serial/by-id/usb-Klipper*")).filter(e=>!t.includes(c().realpathSync(e)))}),boardVersion:eZ.input(eK).meta({boardRequired:!0}).query(async({ctx:e,input:t})=>{if(null==e.board)throw new eU.bR({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});if(null==process.env.KLIPPER_ENV||""===process.env.KLIPPER_ENV.trim())throw new eU.bR({code:"PRECONDITION_FAILED",message:"Environment variable KLIPPER_ENV is missing"});if(null==process.env.KLIPPER_DIR||""===process.env.KLIPPER_DIR.trim())throw new eU.bR({code:"PRECONDITION_FAILED",message:"Environment variable KLIPPER_DIR is missing"});let r=getScriptRoot(),i={stdout:""},o=null;try{await fetch("http://127.0.0.1:7125/machine/services/stop?service=klipper",{method:"POST"}),i=await (0,T.promisify)(m.exec)(`${z().join(process.env.KLIPPER_ENV,"bin","python")} ${z().join(r,"check-version.py")} ${getBoardSerialPath(e.board,e.toolhead)}`,{env:{KLIPPER_DIR:process.env.KLIPPER_DIR,NODE_ENV:"production"}})}catch(e){o=e}finally{await fetch("http://127.0.0.1:7125/machine/services/start?service=klipper",{method:"POST"})}if(o)throw new eU.bR({code:"INTERNAL_SERVER_ERROR",cause:o});return i.stdout.match(/Version:\s(v\d+\.\d+\.\d+-\d+-\w{9})/)?.[1]}),compile:eZ.input(u.z.object({boardPath:u.z.string(),toolhead:eR.optional()})).meta({boardRequired:!0}).mutation(async({ctx:e,input:t})=>{if(null==e.board)throw new eU.bR({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});return await compileFirmware(e.board,e.toolhead),"success"}),reversePinLookup:eZ.meta({boardRequired:!0}).input(u.z.object({axis:u.z.nativeEnum(s),canUseExtruderlessConfigs:u.z.boolean(),boardPath:u.z.string()})).query(async({ctx:e,input:t})=>{if(null==e.board)return;let r=null!=e.board.extruderlessConfig&&t.canUseExtruderlessConfigs,i=await parseBoardPinConfig(e.board,r),o=t.axis===s.z?"z0":t.axis===s.extruder?"e":s.extruder1===t.axis?"e1":t.axis;return reversePinLookup({step_pin:i[`${o}_step_pin`],dir_pin:i[`${o}_dir_pin`]},e.board)??null}),flashAllConnected:eZ.meta({boardRequired:!1,includeHost:!0}).mutation(async({ctx:e})=>{let t=await getLastPrinterSettings(),r=t.toolheads.map(e=>new ToolheadHelper(e)),i=e.boards.flatMap(e=>{if(e.flashScript&&e.compileScript&&!0!==e.disableAutoFlash){if(detect(e))return{board:e,toolhead:null};let t=r.map(t=>detect(e,t)?{board:e,toolhead:t}:null).filter(Boolean);return t}return null}).filter(Boolean),o=[];for(let e of i)try{let t=Y.parse(e.board);await compileFirmware(e.board,e.toolhead);let r=null;try{let i=z().join(t.path.replace(`${process.env.RATOS_CONFIGURATION_PATH}/boards/`,""),t.flashScript);r=e.toolhead?await runSudoScript("flash-path.sh",getBoardSerialPath(e.board,e.toolhead)):await runSudoScript("board-script.sh",i)}catch(i){let t=i instanceof Error?i.message:i;throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Could not flash firmware to ${e.board.name}: 

 ${r?.stdout??t}`,cause:i})}o.push({board:e.board,result:"success",message:`${e.board.manufacturer} ${e.board.name} on ${e.toolhead?` ${e.toolhead.getToolCommand}`:""} was successfully flashed.`})}catch(r){let t=r instanceof Error?r.message:r;o.push({board:e.board,result:"error",message:"string"==typeof t?t:`Unknown error occured while flashing ${e.board.manufacturer} ${e.board.name} on ${e.toolhead?` ${e.toolhead.getToolCommand}`:""}`})}let n=o.filter(e=>"success"===e.result).length,a=`${n}/${i.length} connected board(s) flashed successfully.
`;return o.map(e=>{"error"===e.result?a+=`${e.board.manufacturer} ${e.board.name} failed to flash: ${e.message}
`:a+=`${e.board.manufacturer} ${e.board.name} was successfully flashed.
`}),{report:a,flashResults:o}}),flashViaPath:eZ.input(u.z.object({boardPath:u.z.string(),flashPath:u.z.string().optional(),toolhead:eR.optional()})).meta({boardRequired:!0}).mutation(async({ctx:e,input:t})=>{if(null==e.board)throw new eU.bR({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});if(null==e.board.flashScript)throw new eU.bR({code:"PRECONDITION_FAILED",message:`${e.board.name} does not support automatic flashing via serial path.`});if(t.flashPath&&!c().existsSync(t.flashPath))throw new eU.bR({code:"PRECONDITION_FAILED",message:`The path ${t.flashPath} does not exist.`});await compileFirmware(e.board,e.toolhead);let r=null;try{let i=z().join(e.board.path.replace(`${process.env.RATOS_CONFIGURATION_PATH}/boards/`,""),e.board.flashScript);r=t.flashPath?await runSudoScript("flash-path.sh",getBoardSerialPath(e.board,e.toolhead),t.flashPath):e.toolhead?await runSudoScript("flash-path.sh",getBoardSerialPath(e.board,e.toolhead)):await runSudoScript("board-script.sh",i)}catch(i){let t=i instanceof Error?i.message:i;throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Could not flash firmware to ${e.board.name}: 

 ${r?.stdout??t}`,cause:i})}if(!detect(e.board,e.toolhead))throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Could not flash firmware to ${e.board.name}, device did not show up at expected path.: 

 ${r.stdout}`});return"success"}),dfuDetect:eZ.input(eK).meta({boardRequired:!0}).query(async({ctx:e,input:t})=>{let r=parseInt((await (0,T.promisify)(m.exec)('lsusb | grep "0483:df11" | wc -l')).stdout,10);if(1===r)return!0;if(r>1)throw new eU.bR({code:"PRECONDITION_FAILED",message:"Multiple DFU devices detected, please disconnect the other devices."});return!1}),dfuFlash:eZ.input(eK).meta({boardRequired:!0}).mutation(async({ctx:e,input:t})=>{if(null!=e.board){if(null==e.board.dfu)throw new eU.bR({code:"PRECONDITION_FAILED",message:"Board does not support DFU."});try{await compileFirmware(e.board,e.toolhead)}catch(r){let t=r instanceof Error?r.message:r;throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:`Could not compile firmware for ${e.board.name}: 

 ${t}`,cause:r})}try{let t=await runSudoScript("dfu-flash.sh",getBoardSerialPath(e.board,e.toolhead));return t.stdout}catch(e){throw new eU.bR({code:"INTERNAL_SERVER_ERROR",message:"Failed to flash device",cause:e})}}})});let xAccelerometerOptions=(e,t)=>{let r=[{id:"none",title:"None"},{id:"sbc",title:"Wired to Host Computer"}];return e?.controlboard?.ADXL345SPI!=null&&r.push({id:"controlboard",title:"Wired to Controlboard"}),t?.toolboard!=null&&null!=t.toolboard.ADXL345SPI&&r.push({id:"toolboard",title:"Integrated on toolboard"}),r},yAccelerometerOptions=(e,t)=>{let r=[{id:"none",title:"None"},{id:"sbc",title:"Wired to Host Computer"}];return e?.controlboard?.ADXL345SPI!=null&&r.push({id:"controlboard",title:"Wired to Controlboard"}),t?.toolboard!=null&&null!=t.toolboard.ADXL345SPI&&r.push({id:"toolboard",title:"Integrated on toolboard"}),r};var eQ=r(23646);let eJ=(0,eQ.createProxy)(String.raw`/home/runner/work/RatOS-configurator/RatOS-configurator/src/hooks/usePrinterConfiguration.tsx`),{__esModule:e0,$$typeof:e1}=eJ;eJ.default,eJ.PerformanceModeState,eJ.StealthchopState,eJ.StandstillStealthState,eJ.ControllerFanState,eJ.PrinterConfigurationState,eJ.LoadablePrinterConfigurationState;let e2=eJ.serializePrinterConfiguration;eJ.serializePartialPrinterConfiguration,eJ.useSerializedPrinterConfiguration,eJ.usePrinterConfiguration;let e4=u.z.object({eventtime:u.z.number()}),e3=e4.extend({status:u.z.object({print_stats:u.z.object({state:u.z.union([u.z.literal("paused"),u.z.literal("printing"),u.z.literal("complete"),u.z.literal("error"),u.z.literal("canceled"),u.z.literal("standby")])})})}),e6=u.z.object({result:e4.passthrough()}),parseMoonrakerHTTPResponse=async(e,t)=>{let r=await e.json();try{let e=e6.parse(r);return{...e,result:t.parse(e.result)}}catch(e){throw getLogger().error("Error parsing moonraker response"),getLogger().error(r),e}},klipperRestart=async(e=!1)=>{let t=(await parseMoonrakerHTTPResponse(await fetch("http://localhost:7125/printer/objects/query?print_stats"),e3)).result.status.print_stats.state;return!!(e||["error","complete","canceled","standby"].includes(t))&&(await fetch("http://localhost:7125/printer/restart",{method:"POST"}),!0)};var e5=r(92056),e8=r.n(e5);function isNodeError(e){return e instanceof Error}let e7=(n=async(e,t)=>{let r=ei.get(e);if(null!=r)return u.z.array(t).parse(r);let i=await (0,eX.zA)(`${process.env.RATOS_CONFIGURATION_PATH}/${e}/*.cfg`),o=(await Promise.all(i.map(e=>e.trim()).filter(e=>""!==e).map(async e=>{let r=await parseMetadata(e,t);return null==r?(getLogger().warn(`No metadata present in ${e} skipping..`),null):r}))).filter(e=>null!=e);return ei.set(e,o),o},async(e,t)=>{let r=ei.get(`${e}`);if(null==r){let r=eo.get(`${e}`);null==r&&(r=n(e,t),eo.set(`${e}`,r));let i=await r;return ei.set(`${e}`,i),i}return r}),serializedPartialConfigFromPrinterDefinition=e=>eB.parse({printer:e.id,controlboard:e.defaults.board}),getPrinters=async(e=!1)=>{let t=(0,eX.zA)(`${process.env.RATOS_CONFIGURATION_PATH}/printers/*/printer-definition.json`),r=await e7("hotends",eh),i=await getBoards(),o={},n=(await Promise.all((await t).map(async e=>""===e.trim()?null:{...JSON.parse((await (0,J.readFile)(e)).toString()),path:e.replace("printer-definition.json",""),id:e.replace("/printer-definition.json","").split("/").pop()}))).filter(Boolean);n.forEach(t=>{let n=serializedPartialConfigFromPrinterDefinition(t);o[t.id]=t.defaults.toolheads.map(async t=>{let o=(await r).find(e=>e.id===t.hotend);if(null==t.thermistor&&null!=o&&(t.thermistor=o.thermistor),null==t.nozzle&&(t.nozzle=getDefaultNozzle()),e){let e=await deserializeToolheadConfiguration(t,n,i);t=e}return t})});let a={};return await Promise.all(Object.keys(o).map(async e=>{let t=o[e];a[e]=await Promise.all(t)})),u.z.array(e?eO:eN).parse(n.map(e=>(e.defaults.toolheads=a[e.id],e)))},isPrinterCfgInitialized=async()=>{let e=h.parse(process.env);try{await (0,J.access)(z().join(e.KLIPPER_CONFIG_PATH,"printer.cfg"),p.constants.F_OK)}catch(e){if(isNodeError(e)&&"ENOENT"===e.code)return!1;throw e}let t=await (0,J.readFile)(z().join(e.KLIPPER_CONFIG_PATH,"printer.cfg"));return -1===t.indexOf("[include RatOS/printers/initial-setup.cfg]")},deserializeToolheadConfiguration=async(e,t,r)=>{let i=null==r?await getBoards():r,o=i.find(e=>e.id===t.controlboard),n=getToolboards(i),a=await e7("hotends",eh),s=await e7("extruders",e_),l=await e7("z-probe",ef),d=n.find(t=>t.id===e.toolboard)??null,p=xAccelerometerOptions({controlboard:o},{toolboard:d}),c=yAccelerometerOptions({controlboard:o},{toolboard:d}),u={...e,toolboard:d,hotend:a.find(t=>t.id===e.hotend),extruder:s.find(t=>t.id===e.extruder),probe:l.find(t=>t.id===e.probe),thermistor:ed.find(t=>t===e.thermistor),xEndstop:xEndstopOptions(t,e).find(t=>t.id===e.xEndstop),yEndstop:yEndstopOptions(t,e).find(t=>t.id===e.yEndstop),xAccelerometer:p.find(t=>t.id===e.xAccelerometer)??(d&&null!=d.ADXL345SPI?p.find(e=>"toolboard"===e.id):null),yAccelerometer:c.find(t=>t.id===e.yAccelerometer)??(d&&null!=d.ADXL345SPI?c.find(e=>"toolboard"===e.id):null),partFan:partFanOptions({controlboard:o},{toolboard:d,axis:e.axis}).find(t=>t.id===e.partFan),hotendFan:hotendFanOptions({controlboard:o},{toolboard:d,axis:e.axis}).find(t=>t.id===e.hotendFan)};return eP.parse(u)},deserializePartialToolheadConfiguration=async(e,t,r)=>{r=r??await getBoards();let i=r.find(e=>e.id===t?.controlboard),o=getToolboards(r),n=await e7("hotends",eh),a=await e7("extruders",e_),l=await e7("z-probe",ef),d=o.find(t=>t.id===e?.toolboard);return eS.parse({...e,toolboard:d??null,hotend:n.find(t=>t.id===e?.hotend),extruder:a.find(t=>t.id===e?.extruder),probe:l.find(t=>t.id===e?.probe),thermistor:ed.find(t=>t===e?.thermistor),xEndstop:xEndstopOptions(t,e).find(t=>t.id===e?.xEndstop),yEndstop:yEndstopOptions(t,e).find(t=>t.id===e?.yEndstop),xAccelerometer:xAccelerometerOptions({controlboard:i},{toolboard:d}).find(t=>t.id===e?.xAccelerometer),yAccelerometer:yAccelerometerOptions({controlboard:i},{toolboard:d}).find(t=>t.id===e?.yAccelerometer),partFan:partFanOptions({controlboard:i},{toolboard:d,axis:e?.axis??s.x}).find(t=>t.id===e?.partFan),hotendFan:hotendFanOptions({controlboard:i},{toolboard:d,axis:e?.axis??s.x}).find(t=>t.id===e?.hotendFan)})},deserializePartialPrinterConfiguration=async e=>{let t=await getBoards(),r=t.find(t=>t.id===e?.controlboard),i=null==e.toolheads?void 0:await Promise.all(e.toolheads.map(async r=>await deserializePartialToolheadConfiguration(r,e,t)));return eH.parse({toolheads:i,printer:(await getPrinters()).find(t=>t.id===e?.printer),size:e?.size,controllerFan:controllerFanOptions({controlboard:r}).find(t=>t.id===e?.controllerFan),controlboard:r,performanceMode:e?.performanceMode,stealthchop:e?.stealthchop,standstillStealth:e?.standstillStealth,rails:e?.rails?.map(e=>deserializePrinterRail(e))})},deserializePrinterConfiguration=async e=>{let t=await getBoards(),r=t.find(t=>t.id===e?.controlboard),i=null==e.toolheads?void 0:await Promise.all(e.toolheads.map(r=>deserializeToolheadConfiguration(r,e,t)));return eD.parse({toolheads:i,printer:(await getPrinters()).find(t=>t.id===e?.printer),size:e?.size,controllerFan:controllerFanOptions({controlboard:r}).find(t=>t.id===e?.controllerFan),controlboard:r,performanceMode:e?.performanceMode,stealthchop:e?.stealthchop,standstillStealth:e?.standstillStealth,rails:e?.rails.map(e=>deserializePrinterRail(e))})},getTimeStamp=()=>{let e=new Date,t=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),i=e.getFullYear(),o=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${i}${r}${t}_${o}${n}${a}`},portModifications=async(e,t)=>{if((0,p.existsSync)(e)){let r=await searchFileByLine(e,"#*# <---------------------- SAVE_CONFIG ---------------------->");!1!==r&&(t+="\n\n"+await extractLinesFromFile(e,r)+"\n")}return t},getFilesToWrite=async(e,t)=>{let i=await constructKlipperConfigUtils(e),o=constructKlipperConfigExtrasGenerator(e,i),n=await constructKlipperConfigHelpers(e,o,i),a=h.parse(process.env),{template:s,initialPrinterCfg:l}=await r(26004)(`./${e.printer.template.replace("-printer.template.cfg",".ts")}`),d=s(e,n).trim(),c=await portModifications(z().join(a.KLIPPER_CONFIG_PATH,"printer.cfg"),l(e,n).trim()),u=o.getFilesToWrite();return[{fileName:"RatOS.cfg",content:d,overwrite:!0,order:0},{fileName:"printer.cfg",order:1,content:c,overwrite:!await isPrinterCfgInitialized()}].concat(u).map(e=>{let r={...e,exists:!1,diskContent:null};return(t?.includes(r.fileName)||t?.includes("*"))&&(r.overwrite=!0),r.exists=(0,p.existsSync)(z().join(a.KLIPPER_CONFIG_PATH,r.fileName)),r.exists&&(r.diskContent=(0,p.readFileSync)(z().join(a.KLIPPER_CONFIG_PATH,r.fileName),"utf-8"),(0,p.existsSync)(z().join(a.RATOS_DATA_DIR,`last-${r.fileName}`))&&(r.lastSavedContent=(0,p.readFileSync)(z().join(a.RATOS_DATA_DIR,`last-${r.fileName}`),"utf-8"))),r})},generateKlipperConfiguration=async(e,t,r)=>{let i=h.parse(process.env),o=await getFilesToWrite(e,t),n=await Promise.all(o.map(async e=>{let t="created",o=z().join(i.KLIPPER_CONFIG_PATH,e.fileName),n=z().join(i.RATOS_DATA_DIR,`last-${e.fileName}`);try{if(await (0,J.access)(o,p.constants.F_OK),!e.overwrite)return{fileName:e.fileName,action:"skipped"};{let r=`${e.fileName.split(".").slice(0,-1).join(".")}-${getTimeStamp()}.cfg`;try{await (0,J.copyFile)(o,z().join(i.KLIPPER_CONFIG_PATH,r));let t=await (0,eX.zA)(z().join(i.KLIPPER_CONFIG_PATH,`${e.fileName.split(".").slice(0,-1).join(".")}-+([0-9])_+([0-9]).cfg`));if(t.length>0){let e=t.sort((e,t)=>{let r=new Date(e.split("-").slice(-1)[0].split(".cfg")[0]),i=new Date(t.split("-").slice(-1)[0].split(".cfg")[0]);return r.getTime()-i.getTime()});e.length>5&&await Promise.all(e.reverse().slice(0,e.length-5).map(e=>(getLogger().info(`Removing old backup: ${e}`),(0,J.unlink)(e))))}}catch(t){return{fileName:e.fileName,action:"error",err:t}}t="overwritten"}}catch(t){if(!isNodeError(t)||"ENOENT"!==t.code)return{fileName:e.fileName,action:"error",err:t}}try{if(r?.includes(e.fileName))return{fileName:e.fileName,action:"skipped"};return await (0,J.writeFile)(o,e.content),await (0,J.writeFile)(n,e.content),{fileName:e.fileName,action:t}}catch(t){return{fileName:e.fileName,action:"error",err:t}}})),a=n.filter(e=>"error"===e.action);if(a.length>0)throw a.map(e=>getLogger().error(e)),Error("Something went wrong when saving the configuration. The following files couldn't be written: "+a.map(e=>e.fileName).join(", "));try{await savePrinterSettings(e2(e))}catch(e){throw Error("Couldn't backup your current printer settings to disk, but your klipper configuration has been generated.")}return n},compareSettings=async e=>{let t=h.parse(process.env),r=hasLastPrinterSettings()?await getFilesToWrite(await getLastPrinterSettings()):[],i=await getFilesToWrite(await deserializePrinterConfiguration(e)),o=await Promise.all(i.filter(e=>!e.exists||!r.some(t=>t.fileName===e.fileName)).map(async e=>{let t=new Date().getTime()+e8()(e);await (0,J.writeFile)(`/tmp/ratos-added-new-${t}.cfg`,e.content);let r=await new Promise((e,r)=>{(0,m.exec)(`git diff --minimal --no-index /dev/null /tmp/ratos-added-new-${t}.cfg`,(t,i,o)=>{""==i.trim()&&r(o),e(i)})});return{fileName:e.fileName,diff:r,exists:e.exists,overwrite:e.overwrite,order:e.order,state:"created"}})),n=await Promise.all(r.filter(e=>e.exists&&!i.some(t=>t.fileName===e.fileName)).map(async e=>{let t=new Date().getTime()+e8()(e);await (0,J.writeFile)(`/tmp/ratos-removed-old-${t}.cfg`,e.content);let r=await new Promise((e,r)=>{(0,m.exec)(`git diff --minimal --no-index /tmp/ratos-removed-old-${t}.cfg /dev/null`,(t,i,o)=>{""==i.trim()&&r(o),e(i)})});return{fileName:e.fileName,diff:r,exists:e.exists,overwrite:e.overwrite,order:e.order,state:"removed"}})),a=await Promise.all(i.filter(e=>e.exists&&r.some(t=>t.fileName===e.fileName&&(t.content!==e.content||null!=e.lastSavedContent&&t.content!==e.lastSavedContent))).map(async e=>{let i=r.find(t=>t.fileName===e.fileName);if(null==i)throw Error("This should never happen.");let o=new Date().getTime()+e8()(e),n=z().resolve(z().join(t.KLIPPER_CONFIG_PATH,i.fileName));i.exists||(n=`/tmp/ratos-changed-old-${o}.cfg`,await (0,J.writeFile)(n,i.content)),await (0,J.writeFile)(`/tmp/ratos-changed-new-${o}.cfg`,e.content);let a=await new Promise((e,t)=>{(0,m.exec)(`git diff --minimal --no-index ${n} /tmp/ratos-changed-new-${o}.cfg`,(r,i,o)=>{""==i.trim()&&t(o),e(i)})});return{fileName:e.fileName,diff:a,exists:e.exists,overwrite:e.overwrite,changedOnDisk:i.diskContent!==i.content,changedFromConfig:i.content!==e.content||null!=e.lastSavedContent&&i.content!==e.lastSavedContent,order:e.order,state:"changed"}})),s=i.filter(e=>e.exists&&r.some(t=>t.fileName===e.fileName&&t.content===e.content&&(null==e.lastSavedContent||t.content===e.lastSavedContent))).map(e=>{let t=r.find(t=>t.fileName===e.fileName);if(null==t)throw Error("This should never happen.");return{fileName:e.fileName,diff:null,exists:e.exists,overwrite:e.overwrite,changedOnDisk:t.diskContent!==t.content,changedFromConfig:t.content!==e.content||null!=e.lastSavedContent&&t.content!==e.lastSavedContent,order:e.order,state:"unchanged"}}),l=o.concat(n).concat(a).concat(s).sort((e,t)=>{if(null!=e.order||null!=t.order){if((e.order??9999)>(t.order??9999))return 1;if((e.order??9999)<(t.order??9999))return -1}return i.findIndex(t=>t.fileName===e.fileName)<i.findIndex(e=>e.fileName===t.fileName)?-1:i.findIndex(t=>t.fileName===e.fileName)>i.findIndex(e=>e.fileName===t.fileName)?1:e.fileName<t.fileName?-1:e.fileName>t.fileName?1:0});return l},loadSerializedConfig=async e=>{let t=await deserializePrinterConfiguration(await readSerializedConfig(e));return t},readSerializedConfig=async e=>{let t=await (0,J.readFile)(e),r=ek.parse(JSON.parse(t.toString()));return r},regenerateKlipperConfiguration=async(e,t,r)=>await generateKlipperConfiguration(await getLastPrinterSettings(e),t,r),getToolhead=async(e,t,r)=>{let i=extractToolheadFromPrinterConfiguration(t,await deserializePartialPrinterConfiguration(e??{}))??null;return null==i?null:!0===r?i.serialize():i},getToolheads=async(e,t)=>{let r=extractToolheadsFromPrinterConfiguration(await deserializePartialPrinterConfiguration(e??{}))??null;return null==r?null:!0===t?r.map(e=>e.serialize()):r};eG({getSavedConfig:eq.output(ek.nullable()).query(async e=>{let t=await getLastPrinterSettings(void 0,!0);return t}),getSavedPrinterName:eq.output(u.z.string().nullable()).query(async e=>{let t=await getLastPrinterSettings(void 0,!0),r=(await getPrinters()).find(e=>e.id===t.printer);return null==r?null:r.manufacturer+" "+r.name}),printers:eq.output(u.z.array(eO)).query(async()=>(await getPrinters(!0)).sort((e,t)=>"Rat Rig"===e.manufacturer&&("Rat Rig"!==t.manufacturer||t.description.indexOf("Discontinued")>-1)?-1:e.name.localeCompare(t.name))),printer:eq.input(u.z.string()).output(eO.nullable()).query(async e=>{let t=(await getPrinters()).find(t=>t.id===e.input);return t?(t.defaults.toolheads=await Promise.all(t.defaults.toolheads.map(e=>deserializeToolheadConfiguration(e,serializedPartialConfigFromPrinterDefinition(t)))),eO.parse(t)):null}),hotends:eq.output(u.z.array(eh)).query(()=>e7("hotends",eh)),extruders:eq.output(u.z.array(e_)).query(()=>e7("extruders",e_)),probes:eq.output(u.z.array(ef)).query(()=>e7("z-probe",ef)),thermistors:eq.query(()=>ed.map(stringToTitleObject)),xEndstops:eq.input(u.z.object({config:eB.nullable(),toolOrAxis:ey})).output(u.z.array(em)).query(async e=>xEndstopOptions(e.input.config,await getToolhead(e.input.config,e.input.toolOrAxis,!0))),yEndstops:eq.input(u.z.object({config:eB.nullable(),toolOrAxis:ey})).output(u.z.array(em)).query(async e=>yEndstopOptions(e.input.config,await getToolhead(e.input.config,e.input.toolOrAxis,!0))),partFanOptions:eq.input(u.z.object({config:eB.nullable(),toolOrAxis:ey})).output(u.z.array(ez)).query(async e=>partFanOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),hotendFanOptions:eq.input(u.z.object({config:eB.nullable(),toolOrAxis:ey})).output(u.z.array(ez)).query(async e=>hotendFanOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),controllerFanOptions:eq.input(u.z.object({config:eB.nullable()})).output(u.z.array(ez)).query(async e=>controllerFanOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolheads(e.input.config))?.map(e=>e.getConfig()))),xAccelerometerOptions:eq.input(u.z.object({config:eB.nullable(),toolOrAxis:ey})).output(u.z.array(eb)).query(async e=>xAccelerometerOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),yAccelerometerOptions:eq.input(u.z.object({config:eB.nullable(),toolOrAxis:ey})).output(u.z.array(eb)).query(async e=>yAccelerometerOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),deserializeToolheadConfiguration:eq.input(u.z.object({config:eR,printerConfig:eB.optional()})).query(async e=>await deserializeToolheadConfiguration(e.input.config,e.input.printerConfig??{})),printercfgStatus:eq.query(async()=>({isInitialized:await isPrinterCfgInitialized()})),regenerateConfiguration:eq.input(u.z.object({overwriteFiles:u.z.array(u.z.string()).optional(),skipFiles:u.z.array(u.z.string()).optional()})).mutation(async({input:e})=>{let t=await regenerateKlipperConfiguration(void 0,e.overwriteFiles,e.skipFiles);return t.some(e=>"created"===e.action||"overwritten"===e.action)&&klipperRestart(),t}),getFilesToWrite:eq.input(u.z.object({config:ek})).mutation(async e=>{let{config:t}=e.input;return await compareSettings(t)}),saveConfiguration:eq.input(u.z.object({config:ek,overwriteFiles:u.z.array(u.z.string()).optional(),skipFiles:u.z.array(u.z.string()).optional()})).mutation(async e=>{let{config:t,overwriteFiles:r,skipFiles:i}=e.input,o=await deserializePrinterConfiguration(t),n=await generateKlipperConfiguration(o,r,i);return klipperRestart(),n})});let e9=h.parse(process.env),te=z().join(e9.RATOS_DATA_DIR,"last-printer-settings.json"),getLastPrinterSettings=async(e,t)=>{let r=e??te;if(!(0,p.existsSync)(r))throw Error("Couldn't find printer settings file: "+r);return t?await readSerializedConfig(r):await loadSerializedConfig(r)},savePrinterSettings=async e=>await (0,J.writeFile)(z().join(e9.RATOS_DATA_DIR,"last-printer-settings.json"),JSON.stringify(e)),hasLastPrinterSettings=()=>(0,p.existsSync)(te),tt=(0,eQ.createProxy)(String.raw`/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/_hooks/navigation.ts`),{__esModule:tr,$$typeof:ti}=tt;tt.default,tt.useLocalPathname,tt.useIsRouteActive,tt.useNavigation;let to=tt.Redirecter;var tn=r(43977),ta=r(13165),ts=r.n(ta);r(26308);var tl=r(16239);function RootLayout({children:e}){return(0,tl.headers)().get("x-configurator"),d.jsx("html",{className:(0,tn.d)("dark h-full","scroll-smooth scrollbar-thin scrollbar-track-transparent scrollbar-thumb-zinc-400 scrollbar-thumb-rounded-md dark:scrollbar-thumb-zinc-600",ts().variable,ts().className),children:d.jsx("body",{className:"h-full bg-zinc-100 dark:bg-[rgb(18,18,20)]",children:d.jsx(to,{hasLastPrinterSettings:hasLastPrinterSettings(),children:e})})})}},22709:(e,t,r)=>{"use strict";r.r(t),r.d(t,{$$typeof:()=>a,__esModule:()=>n,default:()=>l});var i=r(23646);let o=(0,i.createProxy)(String.raw`/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/template.tsx`),{__esModule:n,$$typeof:a}=o,s=o.default,l=s},26308:()=>{},83547:(e,t,r)=>{"use strict";r.d(t,{Rz:()=>o});var i=r(13728);let o=i.z.object({NODE_ENV:i.z.enum(["development","test","production"]),RATOS_CONFIGURATION_PATH:i.z.string(),RATOS_SCRIPT_DIR:i.z.string(),KLIPPER_CONFIG_PATH:i.z.string(),KLIPPER_DIR:i.z.string(),KLIPPER_ENV:i.z.string(),MOONRAKER_DIR:i.z.string(),LOG_FILE:i.z.string(),RATOS_DATA_DIR:i.z.string()});i.z.object({NEXT_PUBLIC_KLIPPER_HOSTNAME:i.z.string().optional()})}};